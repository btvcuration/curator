<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Curator Admin</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes slide-up {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Drag and Drop Styles */
        .draggable-item { cursor: grab; }
        .draggable-item:active { cursor: grabbing; }
        .drag-over { border: 2px dashed #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Lucide Icon Helper ---
        const Icon = ({ name, size = 24, className, color = "currentColor", ...props }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke={color}
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                    {...props}
                >
                    {iconData.map((child, index) => {
                        const [tag, attrs] = child;
                        return React.createElement(tag, { ...attrs, key: index });
                    })}
                </svg>
            );
        };

        const Sparkles = (p) => <Icon name="Sparkles" {...p} />;
        const Search = (p) => <Icon name="Search" {...p} />;
        const CloudSnow = (p) => <Icon name="CloudSnow" {...p} />;
        const CloudRain = (p) => <Icon name="CloudRain" {...p} />;
        const Cloud = (p) => <Icon name="Cloud" {...p} />;
        const Sun = (p) => <Icon name="Sun" {...p} />;
        const Zap = (p) => <Icon name="Zap" {...p} />;
        const CheckCircle2 = (p) => <Icon name="CheckCircle2" {...p} />;
        const ArrowRight = (p) => <Icon name="ArrowRight" {...p} />;
        const Copy = (p) => <Icon name="Copy" {...p} />;
        const RotateCcw = (p) => <Icon name="RotateCcw" {...p} />;
        const Filter = (p) => <Icon name="Filter" {...p} />;
        const X = (p) => <Icon name="X" {...p} />;
        const Download = (p) => <Icon name="Download" {...p} />;
        const Edit3 = (p) => <Icon name="Edit3" {...p} />;
        const FileSpreadsheet = (p) => <Icon name="FileSpreadsheet" {...p} />;
        const Hash = (p) => <Icon name="Hash" {...p} />;
        const DollarSign = (p) => <Icon name="DollarSign" {...p} />;
        const AlertTriangle = (p) => <Icon name="AlertTriangle" {...p} />;
        const Trash2 = (p) => <Icon name="Trash2" {...p} />;
        const GripVertical = (p) => <Icon name="GripVertical" {...p} />;
        const Database = (p) => <Icon name="Database" {...p} />;
        const CalendarClock = (p) => <Icon name="CalendarClock" {...p} />;
        const CheckSquare = (p) => <Icon name="CheckSquare" {...p} />;
        const Square = (p) => <Icon name="Square" {...p} />;

        // --- CONFIGURATION ---
        const GAS_API_URL = "https://jolly-sun-635f.alcheminos.workers.dev/"; 
        const CACHE_EXPIRY_MS = 24 * 60 * 60 * 1000;

        // --- IndexedDB Helper Functions ---
        const DB_NAME = "AI_Curator_DB";
        const STORE_NAME = "titles";
        const DB_VERSION = 1;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("IndexedDB open failed");
                request.onsuccess = (event) => resolve(event.target.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: "id" });
                    }
                };
            });
        };

        const saveToIndexedDB = async (data) => {
            try {
                const db = await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], "readwrite");
                    const store = transaction.objectStore(STORE_NAME);
                    const item = { id: "full_dump", data: data, timestamp: new Date().getTime() };
                    const request = store.put(item);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e);
                });
            } catch (e) {
                console.error("IndexedDB Save Error:", e);
                throw e;
            }
        };

        const loadFromIndexedDB = async () => {
            try {
                const db = await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], "readonly");
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get("full_dump");
                    request.onsuccess = (event) => {
                        const result = event.target.result;
                        resolve(result ? result : null);
                    };
                    request.onerror = (e) => reject(e);
                });
            } catch (e) {
                console.error("IndexedDB Load Error:", e);
                return null;
            }
        };

        const clearIndexedDB = async () => {
             const db = await initDB();
             return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], "readwrite");
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e);
            });
        }

        // --- HELPER FUNCTIONS ---

        const getSeasonalKeywords = () => {
            const month = new Date().getMonth() + 1;
            if (month >= 12 || month <= 2) {
                return {
                    season: "ê²¨ìš¸",
                    keywords: ["#ë”°ëœ»í•œì „ê¸°ì¥íŒ", "#í¬ë¦¬ìŠ¤ë§ˆìŠ¤", "#ì—°ë§ì •ì£¼í–‰", "#ê²¨ìš¸ë°©í•™", "#ê·¤ê¹Œë¨¹ìœ¼ë©°"],
                    desc: "ì´ë¶ˆ ë°–ì€ ìœ„í—˜í•´! ê²¨ìš¸ í•„ìˆ˜ ì‹œì²­ì‘",
                    sentences: ["ê·¤ ê¹Œë¨¹ìœ¼ë©° ë³´ê¸° ì¢‹ì€ ê²¨ìš¸ ì •ì£¼í–‰ ì‹œë¦¬ì¦ˆ ğŸŠ", "ì—°ë§ ë¶„ìœ„ê¸° ë¬¼ì”¬ ë‚˜ëŠ” í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¹ì„  ğŸ„", "ì¶”ìš´ ë‚  ë§ˆìŒê¹Œì§€ ë”°ëœ»í•´ì§€ëŠ” íë§ ë¬´ë¹„ â˜•", "ê¸´ ê²¨ìš¸ë°¤ì„ ì±…ì„ì§ˆ ëª°ì…ê° 100% ìŠ¤ë¦´ëŸ¬ ğŸŒ™"]
                };
            } else if (month >= 3 && month <= 5) {
                return {
                    season: "ë´„",
                    keywords: ["#ë´„ë‚˜ë“¤ì´", "#ë²šê½ƒì—”ë”©", "#ë¡œë§¨ìŠ¤", "#ìƒˆí•™ê¸°", "#ì„¤ë ˜ì£¼ì˜"],
                    desc: "ì‚´ë‘ì‚´ë‘ ë´„ë°”ëŒ íƒ€ê³  ì˜¨ ë¡œë§¨ìŠ¤",
                    sentences: ["ë´„ë°”ëŒ íœ˜ë‚ ë¦¬ë©° ë³´ê³  ì‹¶ì€ ì„¤ë ˜ ë¡œë§¨ìŠ¤ ğŸŒ¸", "ìƒˆë¡œìš´ ì‹œì‘, í™œê¸°ì°¬ ì—ë„ˆì§€ë¥¼ ì£¼ëŠ” ì„±ì¥ ë“œë¼ë§ˆ ğŸŒ±", "ë‚˜ë¥¸í•œ ì˜¤í›„ë¥¼ ê¹¨ì›Œì¤„ ìœ ì¾Œí•œ ì˜ˆëŠ¥ í•œ ì¡°ê° â˜€ï¸", "ë²šê½ƒ í”¼ëŠ” ê³„ì ˆ, ë‹¤ì‹œ êº¼ë‚´ë³´ëŠ” ì²«ì‚¬ë‘ ëª…ì‘ ğŸ’•"]
                };
            } else if (month >= 6 && month <= 8) {
                return {
                    season: "ì—¬ë¦„",
                    keywords: ["#ê³µí¬íŠ¹ì§‘", "#í˜¸ëŸ¬", "#ì—¬ë¦„íœ´ê°€", "#ë°”ìº‰ìŠ¤", "#ì‹œì›í•œì•¡ì…˜"],
                    desc: "ë¬´ë”ìœ„ë¥¼ ë‚ ë ¤ë²„ë¦´ ì‹œì›í•œ ì½˜í…ì¸ ",
                    sentences: ["ë¬´ë”ìœ„ íƒ€íŒŒ! ë“±ê³¨ì´ ì˜¤ì‹¹í•´ì§€ëŠ” ê³µí¬ íŠ¹ì§‘ ğŸ‘»", "ì§‘ì—ì„œ ë– ë‚˜ëŠ” ì‹œì›í•œ ë°©êµ¬ì„ ë°”ìº‰ìŠ¤ ğŸŒŠ", "ë‹µë‹µí•œ ì†ì´ ë»¥ ëš«ë¦¬ëŠ” ì‚¬ì´ë‹¤ ì•¡ì…˜ ì˜í™” ğŸ¥¤", "ì—´ëŒ€ì•¼ ì  ëª» ë“œëŠ” ë°¤, ì‹œê°„ ìˆœì‚­ ì •ì£¼í–‰ ğŸŒ™"]
                };
            } else {
                return {
                    season: "ê°€ì„",
                    keywords: ["#ê°ì„±ì¶©ë§Œ", "#ë…ì„œì˜ê³„ì ˆ", "#ë©œë¡œ", "#ë‹¨í’ë†€ì´", "#ì¶”ì„íŠ¹ì„ "],
                    desc: "ì„¼ì¹˜í•œ ê°€ì„ ë°¤, ê°ì„± ì¶©ì „ íƒ€ì„",
                    sentences: ["ìŒ€ìŒ€í•œ ê°€ì„ë°¤, ê°ì„±ì„ ì±„ì›Œì¤„ ë©œë¡œ ì˜í™” ğŸ‚", "ê¹Šì–´ê°€ëŠ” ê°€ì„, ìƒê°ì— ì ê¸°ê²Œ í•˜ëŠ” ëª…ì‘ë“¤ ğŸ“š", "í’ì„±í•œ í•œê°€ìœ„, ì˜¨ ê°€ì¡±ì´ í•¨ê»˜ ë³´ëŠ” íŠ¹ì„ ì‘ ğŸŒ•", "ë‚™ì—½ ë–¨ì–´ì§ˆ ë•Œ ìƒê°ë‚˜ëŠ” ì¶”ì–µì˜ ë“œë¼ë§ˆ ğŸï¸"]
                };
            }
        };

        const calculateSimilarity = (s1, s2) => {
            const clean1 = String(s1).replace(/[^a-zA-Z0-9ê°€-í£]/g, "").toLowerCase();
            const clean2 = String(s2).replace(/[^a-zA-Z0-9ê°€-í£]/g, "").toLowerCase();
            if (clean1 === clean2) return 1.0; 
            if (clean1.includes(clean2) || clean2.includes(clean1)) {
                const ratio = Math.min(clean1.length, clean2.length) / Math.max(clean1.length, clean2.length);
                return 0.8 + (ratio * 0.2); 
            }
            return 0.0; 
        };

        const fetchRealWeather = async () => {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const res = await fetch('https://wttr.in/?format=j1', { signal: controller.signal });
                clearTimeout(timeoutId);
                const data = await res.json();
                const current = data.current_condition[0];
                const desc = current.weatherDesc[0].value.toLowerCase();
                let simplifiedDesc = "ë§‘ìŒ";
                if (desc.includes('rain') || desc.includes('drizzle')) simplifiedDesc = "ë¹„";
                else if (desc.includes('snow') || desc.includes('ice')) simplifiedDesc = "ëˆˆ";
                else if (desc.includes('cloud') || desc.includes('overcast')) simplifiedDesc = "íë¦¼";
                else if (desc.includes('fog') || desc.includes('mist')) simplifiedDesc = "ì•ˆê°œ";
                return { temp: `${current.temp_C}Â°C`, weather: simplifiedDesc };
            } catch (e) {
                const seasonInfo = getSeasonalKeywords();
                return { temp: "", weather: seasonInfo.season, isFallback: true };
            }
        };

        const getRandomEmoji = (idx) => {
            const emojis = ['ğŸ¬', 'ğŸ¿', 'ğŸ“º', 'ğŸŒŸ', 'ğŸ‘€', 'âœ¨', 'ğŸ’¿', 'ğŸ“¼', 'ğŸ“½ï¸'];
            return emojis[idx % emojis.length];
        };

        const LOADING_MESSAGES = [
            "ğŸ¿ ìºì‹œëœ ë°ì´í„° í™•ì¸ ì¤‘...", "ğŸ¬ ê°ë…ë‹˜ ì„­ì™¸í•˜ëŸ¬ ê°€ëŠ” ì¤‘...", "âš¡ï¸ ë„·í”Œë¦­ìŠ¤ë³´ë‹¤ ë¹ ë¥´ê²Œ...ëŠ” ë…¸ë ¥ ì¤‘ì…ë‹ˆë‹¤",
            "â›ï¸ ìˆ¨ê²¨ì§„ ëª…ì‘ ë°ì´í„°ë¥¼ ë°œêµ´í•˜ê³  ìˆì–´ìš”", "ğŸ¤– AIê°€ ì‹œë‚˜ë¦¬ì˜¤ ì •ë…í•˜ëŠ” ì¤‘...", "â„ï¸ ê³„ì ˆì— ë”± ë§ëŠ” ì½˜í…ì¸  ì°¾ëŠ” ì¤‘...",
            "ğŸ›« ë°ì´í„° ê°€ì§€ëŸ¬ í—ë¦¬ìš°ë“œ ê°€ëŠ” ì¤‘", "ğŸ“¡ Oasis ì„œë²„ì™€ êµì‹  ì‹œë„ ì¤‘..."
        ];

        const getTagStyle = (text) => {
            const t = String(text).replace('#', '').trim();
            if (t.includes('í•œêµ­ì˜í™”')) return 'bg-indigo-50 text-indigo-600 border-indigo-100';
            if (t.includes('í•´ì™¸ì˜í™”')) return 'bg-purple-50 text-purple-600 border-purple-100';
            if (t.includes('ì˜í™”')) return 'bg-slate-100 text-slate-600 border-slate-200';
            if (t.includes('ë“œë¼ë§ˆ') || t.includes('ì‹œë¦¬ì¦ˆ')) return 'bg-rose-50 text-rose-600 border-rose-100';
            if (t.includes('ì˜ˆëŠ¥')) return 'bg-yellow-50 text-yellow-600 border-yellow-100';
            return 'bg-blue-50 text-blue-600 border-blue-100';
        };

        const SearchBar = ({ query, setQuery, handleSearch, setShowFilters, compact = false, hasFilters = false }) => (
            <div className={`relative group z-10 transition-all ${compact ? 'shadow-none' : 'shadow-sm'}`}>
                <input
                    type="text"
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                    onKeyDown={(e) => e.key === "Enter" && handleSearch()}
                    placeholder="ê²€ìƒ‰ì–´ ë˜ëŠ” í¸ì„± í…Œë§ˆë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                    className={`w-full bg-white border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all placeholder:text-gray-300 ${compact ? 'py-3 pl-4 pr-20 text-base rounded-xl' : 'p-5 pr-24 text-lg rounded-2xl'}`}
                />
                <div className={`absolute right-2 flex gap-1 ${compact ? 'top-2' : 'top-3'}`}>
                    <button 
                        onClick={() => setShowFilters(true)}
                        className={`rounded-lg transition-all flex items-center justify-center ${compact ? 'p-1.5 w-8 h-8' : 'p-2.5'} ${hasFilters ? 'bg-blue-100 text-blue-600' : 'bg-gray-50 text-gray-400 hover:bg-gray-100'}`}
                    >
                        <Filter size={compact ? 16 : 20} />
                    </button>
                    <button 
                        onClick={() => handleSearch()}
                        className={`rounded-lg transition-all flex items-center justify-center ${compact ? 'p-1.5 w-8 h-8' : 'p-2.5'} ${query ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-300'}`}
                    >
                        <ArrowRight size={compact ? 16 : 20} />
                    </button>
                </div>
            </div>
        );

        const App = () => {
            // [NEW] íŠ¸ë Œë“œ ìƒˆë¡œê³ ì¹¨ ë¡œë”© ìƒíƒœ
            const [isTrendRefreshing, setIsTrendRefreshing] = useState(false);

            // [NEW] íŠ¸ë Œë“œ ìƒˆë¡œê³ ì¹¨ í•¸ë“¤ëŸ¬
            const handleTrendRefresh = async () => {
                if (isTrendRefreshing) return; // ì¤‘ë³µ í´ë¦­ ë°©ì§€
                setIsTrendRefreshing(true);
                showToast("ìµœì‹  íŠ¸ë Œë“œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (ì•½ 5ì´ˆ)");
                
                try {
                    // ë°±ì—”ë“œì— 'refresh_picks' ëª¨ë“œë¡œ ìš”ì²­
                    const res = await fetch(`${GAS_API_URL}?mode=refresh_picks`);
                    const json = await res.json();
                    
                    if (json.status === 'success') {
                        setTodaysPicks(json.todaysPicks); // ì¶”ì²œ ë©˜íŠ¸ ì—…ë°ì´íŠ¸
                        setContext(prev => ({ ...prev, ...json.context })); // ë‚ ì”¨/íƒœê·¸ ì—…ë°ì´íŠ¸
                        showToast("ğŸ”¥ íŠ¸ë Œë“œ í”½ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    }
                } catch (e) {
                    console.error(e);
                    showToast("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
                } finally {
                    setIsTrendRefreshing(false);
                }
            };
            const [query, setQuery] = useState("");
            const [viewState, setViewState] = useState("idle");
            const [dbData, setDbData] = useState([]); 
            const [results, setResults] = useState([]);
            
            // [ìˆ˜ì •] ì›ë³¸ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì €ì¥í•˜ëŠ” ìœ ì¼í•œ State
            const [originalSearchResults, setOriginalResults] = useState([]); 

            const [strategy, setStrategy] = useState("");
            const [blockTitle, setBlockTitle] = useState("");
            const [copied, setCopied] = useState(false);
            const [showFilters, setShowFilters] = useState(false);
            const [showDateModal, setShowDateModal] = useState(false);
            const [toastMessage, setToastMessage] = useState(""); 
            const [loadingMsgIndex, setLoadingMsgIndex] = useState(0);
            const [isLoadingData, setIsLoadingData] = useState(true);
            const [isSearching, setIsSearching] = useState(false);
            
            const [selectedItems, setSelectedItems] = useState(new Set());
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);
            
            const [bulkStartDate, setBulkStartDate] = useState("");
            const [bulkEndDate, setBulkEndDate] = useState("");

            const [context, setContext] = useState({ weather: "ë‚ ì”¨ í™•ì¸ ì¤‘", temp: "--", trends: [] });
            const [todaysPicks, setTodaysPicks] = useState([]);
            const [lastUpdated, setLastUpdated] = useState(null);

            const [selectedGenres, setSelectedGenres] = useState([]);
            const [priceType, setPriceType] = useState("all"); 
            const [minPrice, setMinPrice] = useState(0); 
            const [includeRestricted, setIncludeRestricted] = useState(false); 
            const [selectedMetaTypes, setSelectedMetaTypes] = useState([]);

            const resultRef = useRef(null);
            
            const allGenres = dbData.length > 0 
                ? Array.from(new Set(dbData.map(item => item.category).filter(Boolean))) 
                : [];

            const hasActiveFilters = selectedGenres.length > 0 || priceType !== 'all' || includeRestricted || selectedMetaTypes.length > 0;
            const allMetaTypes = React.useMemo(() => {
                if (!dbData) return [];
                const types = new Set(dbData.map(d => d.metaType).filter(t => t && t.trim() !== ''));
                return Array.from(types).sort();
            }, [dbData]);

            useEffect(() => {
                if (isLoadingData) {
                    const interval = setInterval(() => {
                        setLoadingMsgIndex((prev) => (prev + 1) % LOADING_MESSAGES.length);
                    }, 1500); 
                    return () => clearInterval(interval);
                }
            }, [isLoadingData]);

            useEffect(() => {
                const initApp = async () => {
                    setIsLoadingData(true);
                    
                    // 1. í™”ë©´ìš© ë‚ ì”¨ (ë¹ ë¥¸ í‘œì‹œ)
                    const weatherData = await fetchRealWeather();
                    setContext(prev => ({ ...prev, weather: weatherData.weather, temp: weatherData.temp }));
                    
                    // [í•µì‹¬] 2. ì„œë²„ì— ì €ì¥ëœ 'ê¸€ë¡œë²Œ íŠ¸ë Œë“œ í”½' ê°€ì ¸ì˜¤ê¸° (ë¹„ë™ê¸°)
                    fetch(`${GAS_API_URL}?mode=trends`) 
                        .then(res => res.json())
                        .then(json => {
                            if (json.status === 'success') {
                                console.log("ğŸ“… ì„œë²„ íŠ¸ë Œë“œ ë™ê¸°í™” ì™„ë£Œ");
                                setTodaysPicks(json.todaysPicks);
                                setContext(prev => ({ 
                                    ...prev, 
                                    trends: json.context.trends,
                                    timeContext: json.context.timeContext // ì‹œê°„ëŒ€ ë¬¸êµ¬ ë“±
                                }));
                            }
                        })
                        .catch(e => console.warn("íŠ¸ë Œë“œ ë™ê¸°í™” ì‹¤íŒ¨:", e));

                    // 3. ë¬´ê±°ìš´ ì˜í™” DB ë°ì´í„° ë¡œë“œ (ì—¬ê¸°ëŠ” ë¡œì»¬ ìºì‹œ ì ê·¹ í™œìš©)
                    try {
                        const cached = await loadFromIndexedDB();
                        let loadedData = null;

                        if (cached && (new Date().getTime() - cached.timestamp < CACHE_EXPIRY_MS)) {
                            loadedData = cached.data;
                            console.log("âœ… ë¡œì»¬ ì˜í™” DB ì‚¬ìš©");
                        }

                        if (!loadedData) {
                            console.log("â¬‡ï¸ ì˜í™” DB ë‹¤ìš´ë¡œë“œ");
                            const res = await fetch(GAS_API_URL); // mode íŒŒë¼ë¯¸í„° ì—†ìœ¼ë©´ ì „ì²´ ë¡œë“œ
                            const json = await res.json();
                            
                            if (json.status === 'success' && json.data) {
                                loadedData = json.data;
                                await saveToIndexedDB(loadedData);
                            }
                        }

                        if (loadedData) setDbData(loadedData);

                    } catch (error) {
                        console.error("DB Load Error:", error);
                        setDbData([{id:"ERR", title:"ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", category:"ê¸°íƒ€", subCategory:"ê¸°íƒ€", price:0}]);
                    } finally {
                        setIsLoadingData(false);
                    }
                };
                initApp();
            }, []);

            const clearCache = async () => {
                try {
                    await clearIndexedDB();
                    window.location.reload();
                } catch (e) {
                    console.error("Cache clear failed", e);
                    alert("ìºì‹œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            };

            const showToast = (msg) => {
                setToastMessage(msg);
                setTimeout(() => setToastMessage(""), 3000);
            };

            const getDefaultDates = () => {
                const now = new Date();
                const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0); 
                const end = new Date("9999-12-31T23:59:59");
                const formatForInput = (d) => {
                    const pad = (n) => String(n).padStart(2, '0');
                    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                };
                return { start: formatForInput(start), end: formatForInput(end) };
            };

            const handleSearch = async (inputQuery) => {
                const targetQuery = inputQuery || query;
                if (!targetQuery) return;

                setQuery(targetQuery);
                setViewState("thinking");
                setIsSearching(true);
                setResults([]);
                
                // [ìˆ˜ì •] ê²€ìƒ‰ ì‹œì‘ ì‹œ ì›ë³¸ ê²°ê³¼ ì´ˆê¸°í™”
                setOriginalResults([]); 
                setSelectedItems(new Set());

                const currentYear = new Date().getFullYear();
                const augmentedQuery = `${targetQuery} (${currentYear}ë…„ ${context.weather} ë‚ ì”¨)`;
                const { start: defaultStart, end: defaultEnd } = getDefaultDates();

                try {
                    let aiResponse = { recommendedTitles: [], strategy: "", blockTitle: "" };

                    try {
                        const response = await fetch(`${GAS_API_URL}?query=${encodeURIComponent(augmentedQuery)}&weather=${encodeURIComponent(context.weather)}&mode=planning`);
                        if (response.ok) {
                            const json = await response.json();
                            aiResponse = json;
                        }
                    } catch (e) {
                        console.warn("AI Planning API Failed, using local heuristic");
                    }

                    const seasonalInfo = getSeasonalKeywords();
                    setStrategy(aiResponse.strategy || `â˜ï¸ ${context.weather} ë‚ ì”¨ì™€ ${seasonalInfo.season} ì‹œì¦Œ ê°ì„±ì„ ë‹´ì€ íë ˆì´ì…˜`);
                    setBlockTitle(aiResponse.blockTitle || `[${seasonalInfo.season}] ${targetQuery} ì¶”ì²œ ë¦¬ìŠ¤íŠ¸`);

                    const rawRecs = aiResponse.recommendedTitles || [];
                    const normalizedRecs = rawRecs.map(r => ({
                        rawTitle: typeof r === 'string' ? r : r.title,
                        cleanTitle: String(typeof r === 'string' ? r : r.title).replace(/\(.*\)|\[.*\]/g, '').replace(/\s/g, '').toLowerCase(),
                        reason: r.reason || "AI ì¶”ì²œ",
                        targetType: r.type ? r.type.toLowerCase() : (targetQuery.includes("ì •ì£¼í–‰") || targetQuery.includes("ë“œë¼ë§ˆ") ? "drama" : ""), 
                        keywords: r.keywords || []
                    }));
                    
                    const candidates = dbData.map(item => {
                        const rawTitle = item.title || "";
                        const titleForMatch = rawTitle.replace(/\(.*\)|\[.*\]/g, '').trim(); 
                        const myTitle = titleForMatch.replace(/\s/g, '').toLowerCase();
                        
                        const myCategory = (item.category || "").toLowerCase(); 
                        const mySubCategory = (item.subCategory || "").toLowerCase();
                        const myMetaType = (item.metaType || "").toLowerCase(); 

                        const isKids = myMetaType.includes("í‚¤ì¦ˆ") || myMetaType.includes("ì• ë‹ˆ") ||
                                       myCategory.includes("í‚¤ì¦ˆ") || mySubCategory.includes("í‚¤ì¦ˆ") || 
                                       myCategory.includes("ìœ ì•„") || mySubCategory.includes("ë½€ë¡œë¡œ") || 
                                       mySubCategory.includes("íƒ€ìš”") || mySubCategory.includes("í•‘í¬í");
                        
                        const isDbMovie = myMetaType.includes("ì˜í™”") || 
                                          myCategory.includes("ì˜í™”") || myCategory.includes("movie") || 
                                          mySubCategory.includes("ì˜í™”") || mySubCategory.includes("movie");

                        const isDbSeries = !isDbMovie && (
                            myMetaType.includes("ì‹œë¦¬ì¦ˆ") || myMetaType.includes("ë“œë¼ë§ˆ") || myMetaType.includes("ë°©ì†¡") ||
                            myCategory.includes("ë“œë¼ë§ˆ") || myCategory.includes("ì‹œë¦¬ì¦ˆ") || myCategory.includes("ì˜ˆëŠ¥") || myCategory.includes("tv") ||
                            myCategory.includes("ì§€ìƒíŒŒ") || myCategory.includes("ì¢…í¸") || 
                            mySubCategory.includes("ë“œë¼ë§ˆ") || mySubCategory.includes("ì‹œë¦¬ì¦ˆ") || mySubCategory.includes("ì˜ˆëŠ¥") || mySubCategory.includes("tv")
                        );
                    
                        let score = 0;
                        let aiReason = "";
                        let aiTargetTitle = ""; 
                    
                        for (const rec of normalizedRecs) {
                            const recTitle = rec.cleanTitle;
                            const sim = calculateSimilarity(myTitle, recTitle);
                            
                            if (sim > 0.6) { 
                                let currentScore = sim * 100;
                                
                                const isRecSeries = rec.targetType.includes("drama") || rec.targetType.includes("series") || rec.targetType.includes("tv");
                                const isRecMovie = rec.targetType.includes("movie") || rec.targetType.includes("film");
                    
                                if (isKids) currentScore -= 3000; 

                                if (isRecSeries && isDbMovie) currentScore -= 2000; 
                                else if (isRecMovie && isDbSeries) currentScore -= 2000; 
                                else if ((isRecSeries && isDbSeries) || (isRecMovie && isDbMovie)) currentScore += 50; 

                                if (myTitle === recTitle) {
                                    currentScore += 500; 
                                } else if (myTitle.length > recTitle.length + 3) {
                                    currentScore -= 200; 
                                }
                                
                                if (currentScore > score) {
                                    score = currentScore;
                                    aiReason = rec.reason;
                                    aiTargetTitle = rec.rawTitle; 
                                }
                            }
                        }
                    
                        if (score > 0 && (myTitle.includes(targetQuery.replace(/\s/g, '')) || rawTitle.includes(targetQuery))) {
                            score += 30;
                        }
                    
                        return { 
                            ...item, 
                            score, 
                            aiReason, 
                            aiTargetTitle,
                            prices: [item.price], 
                            minPrice: item.price,
                            startDate: defaultStart,
                            endDate: defaultEnd
                        };
                    })
                    .filter(item => item.score > 40)
                    .sort((a, b) => b.score - a.score);
                    
                    const uniqueTitleMap = new Map();
                    
                    candidates.forEach(item => {
                        const dedupKey = item.title.replace(/\[.*?\]|\(.*?\)/g, "").replace(/\s/g, "").toLowerCase();

                        if (!uniqueTitleMap.has(dedupKey)) {
                            uniqueTitleMap.set(dedupKey, item);
                        } else {
                            const existing = uniqueTitleMap.get(dedupKey);
                            if (item.title.length < existing.title.length) {
                                uniqueTitleMap.set(dedupKey, item);
                            }
                        }
                    });
                    
                    const finalCandidates = Array.from(uniqueTitleMap.values()).slice(0, 50); 

                    // [ìˆ˜ì •] ê²€ìƒ‰ ê²°ê³¼ ì›ë³¸ ì €ì¥ (í•„í„°ë§ ê¸°ì¤€ì )
                    setOriginalResults(finalCandidates);
                    
                    // [ìˆ˜ì •] í˜„ì¬ í•„í„°ê°€ ì¼œì ¸ ìˆë‹¤ë©´ ì¦‰ì‹œ í•„í„°ë§ ì ìš©, ì•„ë‹ˆë©´ ì „ì²´ ë…¸ì¶œ
                    if (hasActiveFilters) {
                        const filtered = finalCandidates.filter(item => {
                            if (!includeRestricted && (['ì„±ì¸', 'ê¸°íƒ€', 'adult', 'etc'].some(c => item.category?.includes(c)))) return false;
                            if (selectedGenres.length > 0 && !selectedGenres.includes(item.subCategory)) return false;
                            if (selectedMetaTypes.length > 0 && !selectedMetaTypes.includes(item.metaType)) return false;
                            if (priceType === 'free' && item.price > 0) return false;
                            if (priceType === 'paid') {
                                if (item.price === 0) return false;
                                if (item.price < minPrice) return false;
                            }
                            return true;
                        });
                        setResults(filtered);
                    } else {
                        setResults(finalCandidates);
                    }

                    setViewState("result");

                } catch (e) {
                    console.error(e);
                    showToast("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    setViewState("idle");
                } finally {
                    setIsSearching(false);
                }
            };

            const applyFilters = (sourceData = originalResults) => {
                let filtered = sourceData.filter(item => {
                    if (!includeRestricted && ['ì„±ì¸', 'ê¸°íƒ€', 'adult', 'etc'].includes(item.category)) return false;
                    if (selectedGenres.length > 0 && !selectedGenres.includes(item.category)) return false;
                    if (priceType === 'free' && item.minPrice > 0) return false;
                    if (priceType === 'paid') {
                        if (item.minPrice === 0) return false; 
                        if (item.minPrice < minPrice) return false; 
                    }
                    return true;
                });
                setResults(filtered);
            };

            // [ìˆ˜ì •] í•„í„° ì ìš© í•¸ë“¤ëŸ¬ (ëŒ€ìƒ ì´ì›í™” + ë¬´í•œ ë¡œë”© ë°©ì§€)
            const handleApplyFilterUI = () => {
                setShowFilters(false); // íŒì—… ë‹«ê¸°
                setIsLoadingData(true); // ë¡œë”© ì‹œì‘

                setTimeout(() => {
                    try {
                        // [í•µì‹¬ Logic] í•„í„°ë§ ëŒ€ìƒ(Source) ê²°ì •
                        let sourceData = dbData; 
                        
                        // ê²€ìƒ‰ì–´(query)ê°€ ìˆê³ , ì›ë³¸ ê²€ìƒ‰ ê²°ê³¼(originalSearchResults)ê°€ ìˆë‹¤ë©´ -> ê²€ìƒ‰ ê²°ê³¼ ë‚´ì—ì„œ í•„í„°ë§
                        if (query.trim() !== "" && originalSearchResults.length > 0) {
                            sourceData = originalSearchResults; 
                        }

                        const filtered = sourceData.filter(item => {
                            if (!includeRestricted && (['ì„±ì¸', 'ê¸°íƒ€', 'adult', 'etc'].some(c => item.category?.includes(c)))) return false;
                            if (selectedGenres.length > 0 && !selectedGenres.includes(item.subCategory)) return false;
                            if (selectedMetaTypes.length > 0 && !selectedMetaTypes.includes(item.metaType)) return false;
                            if (priceType === 'free' && item.price > 0) return false;
                            if (priceType === 'paid') {
                                if (item.price === 0) return false;
                                if (item.price < minPrice) return false;
                            }
                            return true;
                        });

                        setResults(filtered);
                        
                        setHasActiveFilters(
                            includeRestricted || selectedGenres.length > 0 || selectedMetaTypes.length > 0 || priceType !== 'all'
                        );

                        showToast(`${filtered.length.toLocaleString()}ê±´ í•„í„° ì ìš©`);

                    } catch (error) {
                        console.error("Filter Error:", error);
                        showToast("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    } finally {
                        setIsLoadingData(false); // [ì¤‘ìš”] ë¡œë”© ë¬´ì¡°ê±´ ë„ê¸°
                    }
                }, 200); 
            };

            const toggleSelection = (id) => {
                const newSet = new Set(selectedItems);
                if (newSet.has(id)) newSet.delete(id);
                else newSet.add(id);
                setSelectedItems(newSet);
            };

            const toggleAllSelection = () => {
                if (selectedItems.size === results.length) {
                    setSelectedItems(new Set());
                } else {
                    setSelectedItems(new Set(results.map(r => r.id)));
                }
            };

            const handleDateChange = (id, field, value) => {
                setResults(prev => prev.map(item => 
                    item.id === id ? { ...item, [field]: value } : item
                ));
            };

            const openBulkEditModal = () => {
                if (selectedItems.size === 0) {
                    showToast("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                const { start, end } = getDefaultDates();
                setBulkStartDate(start);
                setBulkEndDate(end);
                setShowDateModal(true);
            };

            const applyBulkDateEdit = () => {
                setResults(prev => prev.map(item => {
                    if (selectedItems.has(item.id)) {
                        return {
                            ...item,
                            startDate: bulkStartDate || item.startDate,
                            endDate: bulkEndDate || item.endDate
                        };
                    }
                    return item;
                }));
                setShowDateModal(false);
                showToast(`${selectedItems.size}ê±´ ë‚ ì§œ ìˆ˜ì • ì™„ë£Œ`);
            };

            const removeItem = (id) => {
                setResults(prev => prev.filter(item => item.id !== id));
                const newSet = new Set(selectedItems);
                newSet.delete(id);
                setSelectedItems(newSet);
            };

            const onDragStart = (e, index) => {
                dragItem.current = index;
            };

            const onDragEnter = (e, index) => {
                dragOverItem.current = index;
            };

            const onDragEnd = (e) => {
                const _results = [...results];
                const dragItemContent = _results[dragItem.current];
                _results.splice(dragItem.current, 1);
                _results.splice(dragOverItem.current, 0, dragItemContent);
                dragItem.current = null;
                dragOverItem.current = null;
                setResults(_results);
            };

            const onDragOver = (e) => {
                e.preventDefault(); 
            };

            const copyToClipboard = () => {
                const body = results.map(r => r.id).join('\n');
                const textArea = document.createElement("textarea");
                textArea.value = body;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                setCopied(true);
                showToast(`ID ${results.length}ê±´ ë³µì‚¬ ì™„ë£Œ`);
                setTimeout(() => setCopied(false), 2000);
            };

            const downloadExcel = () => {
                const formatForCSV = (isoStr) => {
                    return isoStr.replace("T", " ") + ":00";
                };
                let csvContent = "ì‹œë¦¬ì¦ˆID,í¸ì„±ì‹œì‘ì¼ì‹œ,í¸ì„±ì¢…ë£Œì¼ì‹œ\n";
                results.forEach(r => {
                    const safeId = String(r.id).replace(/,/g, ""); 
                    const start = formatForCSV(r.startDate);
                    const end = formatForCSV(r.endDate);
                    csvContent += `${safeId},${start},${end}\n`;
                });
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `í¸ì„±ì—…ë¡œë“œ_${new Date().toISOString().slice(0,10)}_${query}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const getWeatherIcon = (weatherStr) => {
                if (!weatherStr) return <Sun size={12} />;
                const w = String(weatherStr).toLowerCase();
                if (w.includes('snow') || w.includes('ëˆˆ') || w.includes('ì¶”ì›€')) return <CloudSnow size={12} />;
                if (w.includes('rain') || w.includes('ë¹„')) return <CloudRain size={12} />;
                if (w.includes('cloud') || w.includes('íë¦¼') || w.includes('êµ¬ë¦„') || w.includes('ì•ˆê°œ')) return <Cloud size={12} />;
                return <Sun size={12} />;
            };

            // ---------------- UI RENDER ----------------

            if (isLoadingData) {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center font-sans">
                        <div className="bg-white p-8 rounded-3xl shadow-xl flex flex-col items-center max-w-sm w-full border border-slate-100 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-purple-500 animate-pulse"></div>
                            <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
                                <Sparkles size={32} className="text-blue-600" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-800 mb-4 transition-all duration-500 min-h-[3rem] flex items-center justify-center break-keep">
                                {LOADING_MESSAGES[loadingMsgIndex]}
                            </h2>
                            <div className="flex items-center gap-2 text-xs font-bold text-gray-400 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-100">
                                <Database size={12} />
                                <span>ë°ì´í„° ë™ê¸°í™” ë° íŠ¸ë Œë“œ ë¶„ì„ ì¤‘...</span>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans w-full px-4 md:px-8 lg:px-12 py-6 overflow-x-hidden transition-all duration-300">
                    
                    {toastMessage && (
                        <div className="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 text-sm font-bold animate-fade-in flex items-center gap-2 whitespace-nowrap">
                            <CheckCircle2 size={18} className="text-green-400" />
                            {toastMessage}
                        </div>
                    )}

                    {/* í—¤ë” ì˜ì—­ */}
                    <header className="bg-white rounded-3xl px-6 py-4 mb-4 shadow-sm border border-gray-100 sticky top-4 z-40">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            {/* 1. ë¡œê³  ì˜ì—­: ëª¨ë°”ì¼ì—ì„œë„ í…ìŠ¤íŠ¸ ë³´ì´ê²Œ ìˆ˜ì • */}
                            <div className="flex items-center gap-3 shrink-0" onClick={() => { setViewState("idle"); setQuery(""); }}>
                                <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white cursor-pointer shadow-blue-200 shadow-md hover:scale-105 transition-transform">
                                    <Sparkles size={20} fill="currentColor" />
                                </div>
                                <div className="block"> 
                                    <h1 className="font-bold text-xl tracking-tight cursor-pointer leading-none">AI Curator</h1>
                                    <span className="text-[10px] text-gray-400 font-medium ml-0.5">Smart Admin System</span>
                                </div>
                            </div>

                            {/* 2. ê²€ìƒ‰ì°½ ì˜ì—­ */}
                            <div className="flex-1 max-w-2xl w-full mx-auto">
                                <SearchBar 
                                    query={query} 
                                    setQuery={setQuery} 
                                    handleSearch={handleSearch} 
                                    setShowFilters={setShowFilters} 
                                    hasFilters={hasActiveFilters} 
                                    compact={true} 
                                />
                            </div>
                            
                            {/* 3. ìš°ì¸¡ ì»¨íŠ¸ë¡¤ ì˜ì—­ */}
                            <div className="flex items-center justify-end gap-2 sm:gap-3 shrink-0">
                                {/* ë‚ ì”¨ ë±ƒì§€ */}
                                <div className="flex items-center gap-1.5 px-3 py-2 bg-sky-50 text-sky-700 rounded-xl text-xs font-bold border border-sky-100 whitespace-nowrap">
                                    {getWeatherIcon(context.weather)} {context.temp}
                                </div>

                                {/* [ìˆ˜ì •] ë°ì´í„° ì¬ì„¤ì • ë²„íŠ¼: í…ìŠ¤íŠ¸ ëª…ì‹œ & ë¶‰ì€ìƒ‰ */}
                                <button 
                                    onClick={clearCache} 
                                    className="flex items-center gap-1.5 px-3 py-2 bg-rose-50 border border-rose-100 rounded-xl text-rose-600 hover:bg-rose-100 hover:text-rose-700 transition-colors" 
                                    title="ë¡œì»¬/ì„œë²„ ë°ì´í„° ê°•ì œ ì´ˆê¸°í™”"
                                >
                                    <RotateCcw size={14} />
                                    <span className="text-xs font-bold hidden sm:inline-block">ë°ì´í„° ì¬ì„¤ì •</span>
                                </button>
                                
                                <div className="hidden sm:flex items-center gap-1.5 bg-green-50 px-3 py-2 rounded-xl border border-green-100">
                                    <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                    <span className="text-xs font-bold text-green-700 tracking-tight flex items-center gap-1">
                                        <FileSpreadsheet size={14} className="text-green-600"/>
                                        {dbData.length.toLocaleString()}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="pb-32 min-h-[60vh]">
                        {viewState === "idle" && (
                            <div className="flex flex-col animate-fade-in w-full">
                                
                                {/* [ë³µêµ¬ ì™„ë£Œ] ì‚¬ë¼ì¡Œë˜ í—¤ë” ì˜ì—­ (ì œëª© + ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ + ë±ƒì§€) */}
                                <div className="w-full max-w-6xl mx-auto mt-10">
                                    <div className="flex items-center justify-between px-2 mb-4">
                                        <div className="flex items-center gap-3">
                                            <h3 className="text-lg font-extrabold text-gray-900 tracking-tight">
                                                Today's Trend Pick
                                            </h3>
                                            <button 
                                                onClick={handleTrendRefresh} 
                                                disabled={isTrendRefreshing}
                                                className="p-2 rounded-full bg-white border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 shadow-sm transition-all active:scale-95 group"
                                                title="ìµœì‹  íŠ¸ë Œë“œë¡œ ì—…ë°ì´íŠ¸"
                                            >
                                                {/* íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ì ìš© */}
                                                <RotateCcw size={14} className={`text-gray-400 group-hover:text-indigo-600 ${isTrendRefreshing ? "animate-spin" : ""}`} />
                                            </button>
                                        </div>
                                        <span className="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2.5 py-1 rounded-md border border-indigo-100 flex items-center gap-1">
                                            <Sparkles size={10} />
                                            ì‹¤ì‹œê°„ ì´ìŠˆ ë°˜ì˜
                                        </span>
                                    </div>
                                    
                                    {/* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) */}
                                    <div className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 transition-opacity duration-300 ${isTrendRefreshing ? 'opacity-50 pointer-events-none' : 'opacity-100'}`}>
                                        {todaysPicks.map((item, i) => {
                                            // [ê°•ì œ íŒŒì‹± ë¡œì§]
                                            let emoji = getRandomEmoji(i);
                                            let title = "";
                                            let keywords = [];

                                            if (typeof item === 'object' && item !== null && item.emoji) {
                                                emoji = item.emoji;
                                                title = item.title;
                                                keywords = item.keywords || [];
                                            } else {
                                                const str = String(item);
                                                const emojiMatch = str.match(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/);
                                                if (emojiMatch) emoji = emojiMatch[0];
                                                title = str.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '')
                                                           .replace(/\*\*/g, '').replace(/\"/g, '').trim();
                                                keywords = ["#íŠ¸ë Œë“œ", "#ì¶”ì²œ"];
                                            }

                                            return (
                                                <button 
                                                    key={i} 
                                                    onClick={() => handleSearch(title)} 
                                                    className="flex flex-col h-full p-5 rounded-2xl bg-white border border-gray-100 shadow-sm hover:border-indigo-300 hover:shadow-lg hover:-translate-y-1 transition-all group text-left relative overflow-hidden"
                                                >
                                                    <div className="absolute top-0 right-0 w-20 h-20 bg-gradient-to-bl from-gray-50 to-transparent rounded-bl-full opacity-50 group-hover:from-indigo-50 group-hover:opacity-100 transition-all"></div>
                                                    
                                                    {/* ìƒë‹¨: ì´ëª¨ì§€ */}
                                                    <div className="flex justify-between items-start mb-4 relative z-10">
                                                        <div className="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-xl group-hover:bg-white group-hover:shadow-sm transition-all border border-slate-100">
                                                            {emoji}
                                                        </div>
                                                        <div className="p-1.5 rounded-full bg-transparent group-hover:bg-indigo-50 text-gray-300 group-hover:text-indigo-600 transition-colors">
                                                            <ArrowRight size={16} />
                                                        </div>
                                                    </div>
                                                    
                                                    {/* ì¤‘ë‹¨: ì œëª© */}
                                                    <div className="flex-1 relative z-10 mb-3">
                                                        <h4 className="text-[15px] font-bold text-gray-800 leading-snug group-hover:text-indigo-700 transition-colors word-keep-all line-clamp-3">
                                                            {title}
                                                        </h4>
                                                    </div>

                                                    {/* í•˜ë‹¨: íƒœê·¸ */}
                                                    <div className="relative z-10 flex flex-wrap gap-1.5 mt-auto">
                                                        {keywords.map((k, idx) => (
                                                            <span key={idx} className="text-[10px] text-gray-500 bg-gray-50 px-2 py-0.5 rounded border border-gray-100 font-medium group-hover:border-indigo-100 group-hover:text-indigo-500 transition-colors">
                                                                {k}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Thinking View */}
                        {viewState === "thinking" && (
                            <div className="flex flex-col items-center justify-center h-[50vh] space-y-8 animate-fade-in">
                                <div className="relative">
                                    <div className="absolute inset-0 bg-blue-500 blur-2xl opacity-20 rounded-full animate-ping"></div>
                                    <div className="w-24 h-24 bg-white rounded-3xl shadow-xl border border-blue-100 flex items-center justify-center relative z-10">
                                        <Sparkles size={40} className="text-blue-600 animate-spin-slow" />
                                    </div>
                                </div>
                                <div className="text-center space-y-2">
                                    <h3 className="text-2xl font-bold text-gray-800">
                                        AI íë ˆì´ì…˜ ìƒì„± ì¤‘...
                                    </h3>
                                    <p className="text-gray-500">
                                        ìµœì ì˜ ì½˜í…ì¸ ë¥¼ ë§¤ì¹­í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br/>
                                        ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
                                    </p>
                                </div>
                            </div>
                        )}

                        {/* Result View (ì–´ì œ ë²„ì „ ë””ìì¸ìœ¼ë¡œ ë³µêµ¬ + ë©”íƒ€ íƒœê·¸ ì¶”ê°€) */}
                        {viewState === "result" && (
                            <div className="space-y-6 animate-slide-up w-full max-w-5xl mx-auto px-2 mt-12" ref={resultRef}>
                                
                                {/* í•„í„° í™œì„±í™” ìƒíƒœ í‘œì‹œ */}
                                {(hasActiveFilters) && (
                                    <div className="w-full flex justify-end">
                                        <div className="text-xs text-blue-600 font-bold flex gap-2 items-center bg-blue-50 px-3 py-1.5 rounded-full border border-blue-100 cursor-pointer hover:bg-blue-100 transition-colors" onClick={() => setShowFilters(true)}>
                                            <Filter size={12}/>
                                            <span>í•„í„° ì ìš© ì¤‘ (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</span>
                                        </div>
                                    </div>
                                )}

                                {/* AI ë¸”ë¡ */}
                                <div className="bg-gradient-to-r from-violet-600 to-indigo-600 rounded-3xl p-8 text-white shadow-xl relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-10 opacity-10 transform translate-x-10 -translate-y-10">
                                        <Sparkles size={150} fill="currentColor" />
                                    </div>
                                    <div className="relative z-10">
                                        <div className="flex items-center gap-2 mb-3 text-violet-200 text-xs font-bold uppercase tracking-wider">
                                            <Sparkles size={14} /> AI Curation Block
                                        </div>
                                        <h3 className="text-3xl font-extrabold leading-tight tracking-tight mb-2">
                                            {blockTitle}
                                        </h3>
                                        <p className="text-sm text-violet-200 opacity-90 flex items-center gap-1.5">
                                            <Edit3 size={14} />
                                            {strategy}
                                        </p>
                                    </div>
                                </div>

                                {/* ì»¨íŠ¸ë¡¤ ë°” (ì „ì²´ ì„ íƒ / ì¼ê´„ ìˆ˜ì •) */}
                                <div className="flex items-center justify-between px-2">
                                    <div className="flex items-center gap-2">
                                        <button onClick={toggleAllSelection} className="flex items-center gap-1.5 text-xs font-bold text-gray-600 bg-white border border-gray-200 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                                            {selectedItems.size === results.length && results.length > 0 ? <CheckSquare size={16} className="text-blue-600"/> : <Square size={16}/>}
                                            ì „ì²´ ì„ íƒ
                                        </button>
                                        <button onClick={openBulkEditModal} className="flex items-center gap-1.5 text-xs font-bold text-blue-700 bg-blue-50 border border-blue-100 px-3 py-2 rounded-lg hover:bg-blue-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled={selectedItems.size === 0}>
                                            <CalendarClock size={16}/>
                                            ì¼ê´„ ì¼ì‹œ ìˆ˜ì •
                                        </button>
                                    </div>
                                    <span className="text-[11px] text-gray-400 font-medium hidden sm:inline-block">ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½ ê°€ëŠ¥</span>
                                </div>

                                {/* ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ (ì¹´ë“œí˜•) */}
                                <div className="space-y-3">
                                    {results.length > 0 ? results.map((item, idx) => (
                                        <div 
                                            key={item.id} 
                                            className={`bg-white p-4 rounded-xl border shadow-sm flex flex-col gap-3 group transition-colors draggable-item ${selectedItems.has(item.id) ? 'border-blue-400 ring-1 ring-blue-400 bg-blue-50/10' : 'border-gray-100 hover:border-blue-200'}`}
                                            draggable
                                            onDragStart={(e) => onDragStart(e, idx)}
                                            onDragEnter={(e) => onDragEnter(e, idx)}
                                            onDragEnd={onDragEnd}
                                            onDragOver={onDragOver}
                                        >
                                            <div className="flex items-start gap-3">
                                                {/* ì¢Œì¸¡: ë“œë˜ê·¸ í•¸ë“¤ & ì²´í¬ë°•ìŠ¤ */}
                                                <div className="flex flex-col items-center gap-2 pt-1">
                                                    <div className="cursor-grab text-gray-300 hover:text-gray-500 active:cursor-grabbing">
                                                        <GripVertical size={18} />
                                                    </div>
                                                    <button onClick={() => toggleSelection(item.id)} className="text-gray-400 hover:text-blue-500">
                                                        {selectedItems.has(item.id) ? <CheckSquare size={18} className="text-blue-500"/> : <Square size={18}/>}
                                                    </button>
                                                </div>
        
                                                {/* ì¤‘ì•™: ì½˜í…ì¸  ì •ë³´ */}
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex justify-between items-start mb-1 gap-2">
                                                        <div className="flex-1">
                                                            <h5 className="font-bold text-gray-900 text-base break-keep leading-tight">
                                                                {item.title}
                                                            </h5>
                                                            <span className="text-[10px] text-gray-400 font-mono mt-0.5 block">
                                                                {item.id}
                                                            </span>
                                                        </div>
                                                        <div className={`px-2.5 py-1 rounded-lg text-xs font-bold whitespace-nowrap ${item.price > 0 ? 'bg-slate-100 text-slate-600' : 'bg-blue-100 text-blue-600'}`}>
                                                            {item.price > 0 ? `â‚©${item.price.toLocaleString()}` : 'ë¬´ë£Œ'}
                                                        </div>
                                                    </div>
        
                                                    {/* ë©”íƒ€ íƒœê·¸ & ì¹´í…Œê³ ë¦¬ */}
                                                    <div className="flex items-center gap-2 text-xs text-gray-500 mb-2 flex-wrap">
                                                        {item.metaType && (
                                                            <span className="text-[10px] bg-green-50 text-green-600 border border-green-200 px-1.5 py-0.5 rounded font-bold">
                                                                {item.metaType}
                                                            </span>
                                                        )}
                                                        <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold border ${getTagStyle(item.subCategory)}`}>
                                                            {item.subCategory.includes('ì˜í™”') ? 'ğŸ¬ ' : item.subCategory.includes('ë“œë¼ë§ˆ') ? 'ğŸ“º ' : ''}
                                                            {item.subCategory}
                                                        </span>
                                                        <span className="text-[10px] bg-gray-50 text-gray-400 border border-gray-100 px-1.5 py-0.5 rounded">{item.category}</span>
                                                    </div>
                                                    
                                                    {/* AI ì¶”ì²œ ì‚¬ìœ  */}
                                                    {item.aiReason && (
                                                        <div className="mb-3 p-2 bg-blue-50 rounded-lg border border-blue-100">
                                                            <p className="text-xs text-blue-700 font-medium line-clamp-3 leading-relaxed">
                                                                {item.aiTargetTitle && (
                                                                    <span className="font-bold text-indigo-800 mr-1">
                                                                        [{item.aiTargetTitle}]
                                                                    </span>
                                                                )}
                                                                {item.aiReason}
                                                            </p>
                                                        </div>
                                                    )}
                                                    
                                                    {/* ë‚ ì§œ ì…ë ¥ */}
                                                    <div className="flex flex-wrap items-center gap-2 text-xs bg-gray-50 p-2 rounded-lg">
                                                        <div className="flex items-center gap-1">
                                                            <span className="text-gray-400 font-bold">ì‹œì‘</span>
                                                            <input 
                                                                type="datetime-local" 
                                                                value={item.startDate}
                                                                onChange={(e) => handleDateChange(item.id, 'startDate', e.target.value)}
                                                                className="bg-white border border-gray-200 rounded px-1 py-0.5 focus:outline-none focus:border-blue-500 w-32 text-gray-600 font-mono text-[11px]"
                                                            />
                                                        </div>
                                                        <div className="flex items-center gap-1">
                                                            <span className="text-gray-400 font-bold">ì¢…ë£Œ</span>
                                                            <input 
                                                                type="datetime-local" 
                                                                value={item.endDate}
                                                                onChange={(e) => handleDateChange(item.id, 'endDate', e.target.value)}
                                                                className="bg-white border border-gray-200 rounded px-1 py-0.5 focus:outline-none focus:border-blue-500 w-32 text-gray-600 font-mono text-[11px]"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
        
                                                {/* ìš°ì¸¡: ì‚­ì œ ë²„íŠ¼ */}
                                                <button 
                                                    onClick={() => removeItem(item.id)}
                                                    className="p-1.5 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors self-start"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            </div>
                                        </div>
                                    )) : (
                                        <div className="py-20 text-center text-gray-400 bg-white rounded-xl border border-dashed border-gray-200">
                                            <AlertTriangle size={32} className="mx-auto mb-3 text-gray-300" />
                                            <p className="font-medium">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                        </div>
                                    )}
                                </div>
                                <div className="h-32"></div>
                            </div>
                        )}

                        {/* í•˜ë‹¨ ê³ ì • ì•¡ì…˜ë°” (Result í™”ë©´ìš©) */}
                        {viewState === "result" && (
                            <div className="fixed bottom-6 left-0 right-0 z-30 flex justify-center pointer-events-none px-4">
                                <div className="flex gap-3 w-full max-w-2xl pointer-events-auto animate-slide-up bg-white/90 backdrop-blur-xl p-3 rounded-2xl border border-white/50 shadow-2xl ring-1 ring-gray-200/50">
                                    <button 
                                        onClick={() => { setViewState("idle"); setQuery(""); }}
                                        className="w-14 h-14 bg-white border border-gray-200 rounded-xl shadow-sm flex items-center justify-center text-gray-500 hover:bg-gray-50 active:scale-95 transition-all"
                                        title="ì´ˆê¸°í™”"
                                    >
                                        <RotateCcw size={20} />
                                    </button>

                                    <button 
                                        onClick={downloadExcel}
                                        className="w-14 h-14 bg-white border border-gray-200 rounded-xl shadow-sm flex items-center justify-center text-green-600 hover:bg-green-50 active:scale-95 transition-all"
                                        title="CSV ë‹¤ìš´ë¡œë“œ"
                                    >
                                        <Download size={20} />
                                    </button>
                                    
                                    <button 
                                        onClick={copyToClipboard}
                                        className={`flex-1 h-14 rounded-xl shadow-sm font-bold text-lg flex items-center justify-center gap-2 transition-all active:scale-95 ${copied ? 'bg-indigo-600 text-white' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                                    >
                                        {copied ? (
                                            <>
                                                <CheckCircle2 size={20} />
                                                <span>ë³µì‚¬ ì™„ë£Œ</span>
                                            </>
                                        ) : (
                                            <>
                                                <Copy size={20} />
                                                <span>ID ë¦¬ìŠ¤íŠ¸ ë³µì‚¬</span>
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        )}

                        {showDateModal && (
                            <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center animate-fade-in p-4" onClick={(e) => e.target === e.currentTarget && setShowDateModal(false)}>
                                <div className="bg-white w-full max-w-sm rounded-3xl p-8 space-y-6 animate-slide-up shadow-2xl">
                                    <div className="flex justify-between items-center border-b border-gray-100 pb-4">
                                        <h3 className="text-xl font-bold text-gray-800">ì¼ê´„ ì¼ì‹œ ìˆ˜ì •</h3>
                                        <button onClick={() => setShowDateModal(false)} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><X size={20} className="text-gray-400"/></button>
                                    </div>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-xs font-bold text-gray-500 block mb-1.5 uppercase tracking-wide">ì‹œì‘ ì¼ì‹œ</label>
                                            <input 
                                                type="datetime-local" 
                                                value={bulkStartDate}
                                                onChange={(e) => setBulkStartDate(e.target.value)}
                                                className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-500 block mb-1.5 uppercase tracking-wide">ì¢…ë£Œ ì¼ì‹œ</label>
                                            <input 
                                                type="datetime-local" 
                                                value={bulkEndDate}
                                                onChange={(e) => setBulkEndDate(e.target.value)}
                                                className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                            />
                                        </div>
                                    </div>
                                    <button onClick={applyBulkDateEdit} className="w-full py-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200">
                                        {selectedItems.size}ê±´ ì ìš©í•˜ê¸°
                                    </button>
                                </div>
                            </div>
                        )}

                        {showFilters && (
                           <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end sm:items-center sm:justify-center animate-fade-in" onClick={(e) => e.target === e.currentTarget && setShowFilters(false)}>
                                <div className="bg-white w-full sm:w-[450px] sm:rounded-3xl rounded-t-3xl p-8 pb-10 space-y-8 animate-slide-up shadow-2xl max-h-[90vh] overflow-y-auto">
                                    <div className="flex justify-between items-center border-b border-gray-100 pb-4">
                                        <h3 className="text-2xl font-bold text-gray-900">ìƒì„¸ í•„í„°</h3>
                                        <button onClick={() => setShowFilters(false)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
                                            <X size={20} />
                                        </button>
                                    </div>
                                    
                                    {/* ìƒì„¸ í•„í„° ë‚´ìš©ë“¤ */}
                                    <div className="space-y-6">
                                        <div className="flex items-center justify-between bg-red-50 p-4 rounded-2xl border border-red-100">
                                            <span className="text-sm font-bold text-red-700">ì„±ì¸/ê¸°íƒ€ ì¹´í…Œê³ ë¦¬ í¬í•¨</span>
                                            <button 
                                                onClick={() => setIncludeRestricted(!includeRestricted)}
                                                className={`w-12 h-7 rounded-full transition-colors relative ${includeRestricted ? 'bg-red-500' : 'bg-gray-300'}`}
                                            >
                                                <div className={`absolute top-1 left-1 w-5 h-5 bg-white rounded-full shadow transition-transform ${includeRestricted ? 'translate-x-5' : ''}`}></div>
                                            </button>
                                        </div>
                                        
                                        {/* ë©”íƒ€ ìœ í˜• í•„í„° */}
                                        <div className="space-y-3">
                                            <label className="text-sm font-bold text-gray-500 uppercase tracking-wide">ì½˜í…ì¸  íƒ€ì… (ë©”íƒ€)</label>
                                            <div className="flex flex-wrap gap-2">
                                                {allMetaTypes.map(t => (
                                                    <button 
                                                        key={t}
                                                        onClick={() => setSelectedMetaTypes(prev => prev.includes(t) ? prev.filter(x => x !== t) : [...prev, t])}
                                                        className={`px-4 py-2 rounded-xl text-sm font-bold border transition-all ${selectedMetaTypes.includes(t) ? 'bg-green-600 text-white border-green-600 shadow-md shadow-green-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}
                                                    >
                                                        {t}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="space-y-3 pt-4 border-t border-gray-100">
                                            <label className="text-sm font-bold text-gray-500 uppercase tracking-wide">ì¥ë¥´ ì„ íƒ</label>
                                            <div className="flex flex-wrap gap-2">
                                                {allGenres.map(g => (
                                                    <button 
                                                        key={g}
                                                        onClick={() => setSelectedGenres(prev => prev.includes(g) ? prev.filter(x => x !== g) : [...prev, g])}
                                                        className={`px-4 py-2 rounded-xl text-sm font-bold border transition-all ${selectedGenres.includes(g) ? 'bg-blue-600 text-white border-blue-600 shadow-md shadow-blue-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}
                                                    >
                                                        {g}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        <div className="space-y-3 pt-4 border-t border-gray-100">
                                            <label className="text-sm font-bold text-gray-500 uppercase tracking-wide flex items-center gap-1">
                                                <DollarSign size={16} /> ê°€ê²©ëŒ€
                                            </label>
                                            <div className="flex gap-3">
                                                {[{l:'ì „ì²´', v:'all'}, {l:'ë¬´ë£Œ', v:'free'}, {l:'ìœ ë£Œ', v:'paid'}].map(opt => (
                                                    <button
                                                        key={opt.v}
                                                        onClick={() => setPriceType(opt.v)}
                                                        className={`flex-1 py-3.5 rounded-xl text-sm font-bold border transition-all ${priceType === opt.v ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}
                                                    >
                                                        {opt.l}
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            {priceType === 'paid' && (
                                                <div className="bg-gray-50 p-5 rounded-2xl border border-gray-200 animate-fade-in mt-3 space-y-3">
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-xs font-bold text-gray-500">ìµœì†Œ ê°€ê²©</span>
                                                        <span className="text-base font-bold text-blue-600 bg-white px-2 py-1 rounded border border-blue-100">{minPrice.toLocaleString()}ì› ì´ìƒ</span>
                                                    </div>
                                                    <input 
                                                        type="range" 
                                                        min="0" 
                                                        max="20000" 
                                                        step="500" 
                                                        value={minPrice} 
                                                        onChange={(e) => setMinPrice(Number(e.target.value))}
                                                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                                    />
                                                    <div className="flex justify-between text-[10px] text-gray-400 font-medium">
                                                        <span>0ì›</span>
                                                        <span>20,000ì›+</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <button 
                                        onClick={handleApplyFilterUI}
                                        className="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold text-lg hover:bg-slate-800 transition-colors shadow-xl"
                                    >
                                        í•„í„° ì ìš©í•˜ê¸°
                                    </button>
                                </div>
                           </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
