Import React, { useState, useRef, useEffect } from 'react';
import { 
  Sparkles, 
  Search, 
  CloudSnow, 
  CloudRain, 
  Cloud, 
  Sun, 
  Zap, 
  CheckCircle2, 
  ArrowRight, 
  Copy, 
  RotateCcw, 
  Film, 
  Filter, 
  X, 
  RefreshCw, 
  Calendar, 
  Download, 
  Edit3, 
  Server, 
  FileSpreadsheet, 
  Loader2, 
  Hash, 
  DollarSign, 
  AlertTriangle, 
  Thermometer, 
  Tag, 
  Quote 
} from 'lucide-react';

// --- CONFIGURATION ---
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxrhGuW2iFJ-RXV6Ad7lfY2_k4ZvGuptYRF7ey9PxoKKn34639lf7BqzevxTO-PXksp/exec"; 

// --- HELPER FUNCTIONS ---

const calculateSimilarity = (s1, s2) => {
  const clean1 = String(s1).replace(/[^a-zA-Z0-9ê°€-í£]/g, "").toLowerCase();
  const clean2 = String(s2).replace(/[^a-zA-Z0-9ê°€-í£]/g, "").toLowerCase();
  
  if (clean1 === clean2) return 1.0; 
  if (clean1.includes(clean2) || clean2.includes(clean1)) {
    const ratio = Math.min(clean1.length, clean2.length) / Math.max(clean1.length, clean2.length);
    return 0.8 + (ratio * 0.2); 
  }
  return 0.0; 
};

const fetchRealWeather = async () => {
  try {
    const res = await fetch('https://wttr.in/?format=j1');
    const data = await res.json();
    const current = data.current_condition[0];
    
    const desc = current.weatherDesc[0].value.toLowerCase();
    let simplifiedDesc = "ë§‘ìŒ";
    if (desc.includes('rain') || desc.includes('drizzle')) simplifiedDesc = "ë¹„";
    else if (desc.includes('snow') || desc.includes('ice')) simplifiedDesc = "ëˆˆ";
    else if (desc.includes('cloud') || desc.includes('overcast')) simplifiedDesc = "íë¦¼";
    else if (desc.includes('fog') || desc.includes('mist')) simplifiedDesc = "ì•ˆê°œ";

    return {
      temp: `${current.temp_C}Â°C`,
      weather: simplifiedDesc,
      rawDesc: desc
    };
  } catch (e) {
    console.error("Weather Fetch Error:", e);
    const month = new Date().getMonth() + 1;
    let season = "ë§‘ìŒ";
    if (month >= 12 || month <= 2) season = "ì¶”ì›€";
    return { temp: "Seasonal", weather: season, isFallback: true };
  }
};

const getRandomColorClass = (idx) => {
  const colors = [
    'bg-red-50 border-red-100 text-red-600',
    'bg-orange-50 border-orange-100 text-orange-600',
    'bg-amber-50 border-amber-100 text-amber-600',
    'bg-green-50 border-green-100 text-green-600',
    'bg-teal-50 border-teal-100 text-teal-600',
    'bg-blue-50 border-blue-100 text-blue-600',
    'bg-indigo-50 border-indigo-100 text-indigo-600',
    'bg-purple-50 border-purple-100 text-purple-600',
    'bg-pink-50 border-pink-100 text-pink-600'
  ];
  return colors[idx % colors.length];
};

const getRandomEmoji = (idx) => {
  const emojis = ['ğŸ¬', 'ğŸ¿', 'ğŸ“º', 'ğŸŒŸ', 'ğŸ‘€', 'âœ¨', 'ğŸ’¿', 'ğŸ“¼', 'ğŸ“½ï¸'];
  return emojis[idx % emojis.length];
};

const LOADING_MESSAGES = [
  "ğŸ¿ íŒì½˜ íŠ€ê¸°ëŠ” ì¤‘...",
  "ğŸ¬ ê°ë…ë‹˜ ì„­ì™¸í•˜ëŸ¬ ê°€ëŠ” ì¤‘...",
  "âš¡ï¸ ë„·í”Œë¦­ìŠ¤ë³´ë‹¤ ë¹ ë¥´ê²Œ...ëŠ” ë…¸ë ¥ ì¤‘ì…ë‹ˆë‹¤",
  "â›ï¸ ìˆ¨ê²¨ì§„ ëª…ì‘ ë°ì´í„°ë¥¼ ë°œêµ´í•˜ê³  ìˆì–´ìš”",
  "ğŸ“ ì´ë²ˆ ì£¼ë§ ì±…ì„ì§ˆ ë¦¬ìŠ¤íŠ¸ ì‘ì„± ì¤‘",
  "â­ í‰ì  1ì ì§œë¦¬ëŠ” ê±°ë¥´ëŠ” ì¤‘...",
  "ğŸŒŠ ë°ì´í„° ë°”ë‹¤ì—ì„œ ë³´ë¬¼ ì°¾ëŠ” ì¤‘",
  "ğŸ•µï¸â€â™‚ï¸ ë²”ì¸ì€ ë°”ë¡œ... ë°ì´í„° ì†ì— ìˆìŠµë‹ˆë‹¤",
  "ğŸ¤– AIê°€ ì‹œë‚˜ë¦¬ì˜¤ ì •ë…í•˜ëŠ” ì¤‘...",
  "ğŸƒâ€â™‚ï¸ ë°°ìš°ë“¤ ìŠ¤ì¼€ì¤„ í™•ì¸í•˜ëŸ¬ ë›°ì–´ê°€ëŠ” ì¤‘",
  "ğŸª ì¿ í‚¤ ì˜ìƒ ì°¾ëŠë¼ ì¢€ ëŠ¦ë„¤ìš”...",
  "â„ï¸ 'ì˜¤ê²¡ë¼ë°ìŠ¤ê¹Œ' ì™¸ì¹˜ëŠ” ì¤‘...",
  "ğŸ›« ë°ì´í„° ê°€ì§€ëŸ¬ í—ë¦¬ìš°ë“œ ê°€ëŠ” ì¤‘",
  "ğŸ§¹ ì§€ë‚œì£¼ ë§ì‘ë“¤ ì²­ì†Œí•˜ëŠ” ì¤‘",
  "ğŸ§™â€â™‚ï¸ íë ˆì´ì…˜ ë§ˆë²•ì„ ë¶€ë¦¬ëŠ” ì¤‘...",
  "ğŸ§›â€â™‚ï¸ ë°¤ìƒˆ ë³¼ ì˜í™” ê³ ë¥´ëŠ” ì¤‘",
  "ğŸ”‹ ë‹¹ì‹ ì˜ ë„íŒŒë¯¼ì„ ì¶©ì „í•˜ëŠ” ì¤‘...",
  "ğŸ“¡ ì˜¤ì•„ì‹œìŠ¤ ì„œë²„ì™€ êµì‹  ì‹œë„ ì¤‘...",
  "ğŸ­ í˜ë¥´ì†Œë‚˜ ë¶„ì„ ì¤‘...",
  "ğŸ“º ì±„ë„ ê³ ì •! ë¦¬ëª¨ì»¨ ìˆ¨ê¸°ëŠ” ì¤‘",
  "ğŸ» ë°°ê²½ìŒì•… ì„ ê³¡í•˜ëŠ” ì¤‘...",
  "ğŸ’¤ ì ì€ ì£½ì–´ì„œ ìëŠ”ê±°ì•¼... ì •ì£¼í–‰ ì¤€ë¹„ ì¤‘",
  "ğŸ‘€ ìŠ¤í¬ì¼ëŸ¬ í”¼í•´ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘",
  "ğŸ’¡ ë²ˆëœ©ì´ëŠ” ì•„ì´ë””ì–´ ìƒì„± ì¤‘...",
  "ğŸ´â€â˜ ï¸ ë°ì´í„°, ë„ˆ ë‚´ ë™ë£Œê°€ ë¼ë¼!"
];

const getTagStyle = (text) => {
  const t = String(text).replace('#', '').trim();
  if (t === 'í•œêµ­ì˜í™”') return 'bg-indigo-50 text-indigo-600 border-indigo-100';
  if (t === 'CJ ENM' || t === 'CJ') return 'bg-orange-50 text-orange-600 border-orange-100';
  if (t === 'ì˜í™”') return 'bg-slate-100 text-slate-600 border-slate-200';
  if (t === 'ë“œë¼ë§ˆ') return 'bg-rose-50 text-rose-600 border-rose-100';
  if (t === 'ì˜ˆëŠ¥') return 'bg-yellow-50 text-yellow-600 border-yellow-100';
  return 'bg-blue-50 text-blue-600 border-blue-100';
};

// [FIX] SearchBarë¥¼ ë©”ì¸ ì»´í¬ë„ŒíŠ¸ ì™¸ë¶€ë¡œ ë¶„ë¦¬í•˜ì—¬ ë¦¬ë Œë”ë§ ì‹œ í¬ì»¤ìŠ¤ ì†ì‹¤ ë°©ì§€
const SearchBar = ({ 
  query, 
  setQuery, 
  handleSearch, 
  setShowFilters, 
  compact = false, 
  hasFilters = false 
}) => (
  <div className={`relative group z-10 transition-all ${compact ? 'shadow-none' : 'shadow-sm'}`}>
    <input
      type="text"
      value={query}
      onChange={(e) => setQuery(e.target.value)}
      onKeyDown={(e) => e.key === "Enter" && handleSearch()}
      placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
      className={`w-full bg-white border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all placeholder:text-gray-300 ${compact ? 'py-3 pl-4 pr-20 text-base rounded-xl' : 'p-5 pr-24 text-lg rounded-2xl'}`}
    />
    <div className={`absolute right-2 flex gap-1 ${compact ? 'top-2' : 'top-3'}`}>
      <button 
        onClick={() => setShowFilters(true)}
        className={`rounded-lg transition-all flex items-center justify-center ${compact ? 'p-1.5 w-8 h-8' : 'p-2.5'} ${hasFilters ? 'bg-blue-100 text-blue-600' : 'bg-gray-50 text-gray-400 hover:bg-gray-100'}`}
      >
        <Filter size={compact ? 16 : 20} />
      </button>
      <button 
        onClick={() => handleSearch()}
        className={`rounded-lg transition-all flex items-center justify-center ${compact ? 'p-1.5 w-8 h-8' : 'p-2.5'} ${query ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-300'}`}
      >
        <ArrowRight size={compact ? 16 : 20} />
      </button>
    </div>
  </div>
);

export default function App() {
  const [query, setQuery] = useState("");
  const [viewState, setViewState] = useState("idle");
  
  const [dbData, setDbData] = useState([]); 
  const [results, setResults] = useState([]);
  const [allMatches, setAllMatches] = useState([]); // ë¡œì»¬ í•„í„°ë§ìš© ì›ë³¸ ë°ì´í„°

  const [strategy, setStrategy] = useState("");
  const [blockTitle, setBlockTitle] = useState("");
  const [copied, setCopied] = useState(false);
  const [showFilters, setShowFilters] = useState(false);
  
  const [todaysPicks, setTodaysPicks] = useState([]);
  const [context, setContext] = useState({ weather: "", temp: "", trends: [] }); 
  
  const [isLoadingData, setIsLoadingData] = useState(true); 
  const [loadingMsgIndex, setLoadingMsgIndex] = useState(0);

  const [isSearching, setIsSearching] = useState(false); 
  const [toastMessage, setToastMessage] = useState(""); 
  
  const today = new Date();
  const dateString = `${today.getFullYear()}.${today.getMonth() + 1}.${today.getDate()}`;
  const [sheetName, setSheetName] = useState("ë°ì´í„° ì—°ê²° ëŒ€ê¸°ì¤‘...");

  // í•„í„° ìƒíƒœ
  const [selectedGenres, setSelectedGenres] = useState([]);
  const [priceType, setPriceType] = useState("all"); 
  const [minPrice, setMinPrice] = useState(0); 
  const [includeRestricted, setIncludeRestricted] = useState(false); 

  const resultRef = useRef(null);
  
  const allGenres = dbData.length > 0 
    ? Array.from(new Set(dbData.map(item => item.category).filter(Boolean))) 
    : [];

  const hasActiveFilters = selectedGenres.length > 0 || priceType !== 'all' || includeRestricted;

  const getWeatherIcon = (weatherStr) => {
    if (!weatherStr) return <Sun size={12} />;
    const w = String(weatherStr).toLowerCase();
    
    if (w.includes('snow') || w.includes('ëˆˆ') || w.includes('ì¶”ì›€')) return <CloudSnow size={12} />;
    if (w.includes('rain') || w.includes('ë¹„')) return <CloudRain size={12} />;
    if (w.includes('cloud') || w.includes('íë¦¼') || w.includes('êµ¬ë¦„') || w.includes('ì•ˆê°œ')) return <Cloud size={12} />;
    return <Sun size={12} />;
  };

  useEffect(() => {
    if (isLoadingData) {
      const interval = setInterval(() => {
        setLoadingMsgIndex((prev) => (prev + 1) % LOADING_MESSAGES.length);
      }, 1500); 
      return () => clearInterval(interval);
    }
  }, [isLoadingData]);

  useEffect(() => {
    const initApp = async () => {
      setIsLoadingData(true);

      const weatherPromise = fetchRealWeather();
      
      let dataPromise;
      if (GAS_API_URL.includes("YOUR_SCRIPT_ID")) {
        dataPromise = new Promise(resolve => {
          setTimeout(() => resolve({
            status: 'success',
            todaysPicks: ["ë¹„ë°€ì˜ ìˆ² ì •ì£¼í–‰", "ê²¨ìš¸ ê°ì„± ì˜í™”", "í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë¡œì½”", "ì£¼ë§ íë§ ì˜ˆëŠ¥"],
            sheetName: "2025_02_í¸ì„±ë°ì´í„°", 
            data: [
              { id: "CS11197562", title: "í†µì ", category: "ì˜í™”", subCategory: "í•œêµ­ì˜í™”", price: 10000 },
              { id: "CS001", title: "ê²¨ìš¸ì™•êµ­", category: "ì˜í™”", subCategory: "ì• ë‹ˆë©”ì´ì…˜", price: 5500 },
              { id: "CS001", title: "ê²¨ìš¸ì™•êµ­", category: "ì˜í™”", subCategory: "ì• ë‹ˆë©”ì´ì…˜", price: 0 },
              { id: "CS002", title: "ì–´ë°”ì›ƒ íƒ€ì„", category: "ì˜í™”", subCategory: "ë¡œë§¨ìŠ¤", price: 1500 },
              { id: "CS003", title: "ëŸ¬ë¸Œ ì•¡ì¸„ì–¼ë¦¬", category: "ì˜í™”", subCategory: "ë¡œë§¨ìŠ¤", price: 1200 },
              { id: "CS004", title: "ë‚˜ í™€ë¡œ ì§‘ì—", category: "ì˜í™”", subCategory: "ê°€ì¡±", price: 1000 },
              { id: "CS005", title: "ë¹„ë°€ì˜ ìˆ²", category: "ë“œë¼ë§ˆ", subCategory: "í•œêµ­ë“œë¼ë§ˆ", price: 0 },
              { id: "CS006", title: "ì‘ë‹µí•˜ë¼ 1988", category: "ë“œë¼ë§ˆ", subCategory: "ë“œë¼ë§ˆ", price: 0 },
              { id: "XXX001", title: "ì„±ì¸ ì˜í™” ì˜ˆì‹œ", category: "ì„±ì¸", subCategory: "ì—ë¡œ", price: 5000 },
              { id: "ETC001", title: "ê¸°íƒ€ ì˜ìƒ", category: "ê¸°íƒ€", subCategory: "ê¸°íƒ€", price: 100 }
            ]
          }), 3000); 
        });
      } else {
        // ì‹¤ì œ fetch ì‹œë„, ì‹¤íŒ¨ ì‹œ mock ë°ì´í„°ë¡œ í´ë°±í•˜ëŠ” ë¡œì§ ì¶”ê°€
        dataPromise = fetch(GAS_API_URL)
          .then(r => r.json())
          .catch(e => {
            console.warn("API Fetch failed, using mock data", e);
            return {
              status: 'success',
              todaysPicks: ["ë¹„ë°€ì˜ ìˆ² ì •ì£¼í–‰", "ê²¨ìš¸ ê°ì„± ì˜í™”", "í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë¡œì½”", "ì£¼ë§ íë§ ì˜ˆëŠ¥"],
              sheetName: "ì˜¤í”„ë¼ì¸_ìƒ˜í”Œë°ì´í„°", 
              data: [
                  { id: "CS11197562", title: "í†µì ", category: "ì˜í™”", subCategory: "í•œêµ­ì˜í™”", price: 10000 },
                  { id: "CS001", title: "ê²¨ìš¸ì™•êµ­", category: "ì˜í™”", subCategory: "ì• ë‹ˆë©”ì´ì…˜", price: 5500 },
                  { id: "CS001", title: "ê²¨ìš¸ì™•êµ­", category: "ì˜í™”", subCategory: "ì• ë‹ˆë©”ì´ì…˜", price: 0 },
                  { id: "CS002", title: "ì–´ë°”ì›ƒ íƒ€ì„", category: "ì˜í™”", subCategory: "ë¡œë§¨ìŠ¤", price: 1500 },
                  { id: "CS003", title: "ëŸ¬ë¸Œ ì•¡ì¸„ì–¼ë¦¬", category: "ì˜í™”", subCategory: "ë¡œë§¨ìŠ¤", price: 1200 },
                  { id: "CS004", title: "ë‚˜ í™€ë¡œ ì§‘ì—", category: "ì˜í™”", subCategory: "ê°€ì¡±", price: 1000 },
                  { id: "CS005", title: "ë¹„ë°€ì˜ ìˆ²", category: "ë“œë¼ë§ˆ", subCategory: "í•œêµ­ë“œë¼ë§ˆ", price: 0 },
                  { id: "CS006", title: "ì‘ë‹µí•˜ë¼ 1988", category: "ë“œë¼ë§ˆ", subCategory: "ë“œë¼ë§ˆ", price: 0 },
                  { id: "XXX001", title: "ì„±ì¸ ì˜í™” ì˜ˆì‹œ", category: "ì„±ì¸", subCategory: "ì—ë¡œ", price: 5000 },
                  { id: "ETC001", title: "ê¸°íƒ€ ì˜ìƒ", category: "ê¸°íƒ€", subCategory: "ê¸°íƒ€", price: 100 }
              ]
            };
          });
      }

      try {
        const [weatherData, json] = await Promise.all([weatherPromise, dataPromise]);
        
        const month = new Date().getMonth() + 1;
        const seasonalTrends = 
          month === 12 ? ["#í¬ë¦¬ìŠ¤ë§ˆìŠ¤", "#ì—°ë§ê²°ì‚°", "#ë¡œë§¨ìŠ¤"] :
          month === 1 ? ["#ìƒˆí•´", "#ê°€ì¡±", "#í•´ë‹ì´"] :
          month === 7 || month === 8 ? ["#ê³µí¬", "#ì—¬ë¦„íœ´ê°€"] : ["#ì£¼ë§", "#íë§"];

        setContext({
          weather: weatherData.weather,
          temp: weatherData.temp,
          trends: seasonalTrends
        });

        if (json.status === 'success') {
          setTodaysPicks(json.todaysPicks || []);
          setDbData(json.data || []);
          setSheetName(json.sheetName || `${dateString}_í¸ì„±ë°ì´í„°`);
          if (json.data && json.data.length > 0) {
            showToast(`${json.data.length}ê±´ ë¡œë“œ ì™„ë£Œ`);
          }
        }
      } catch (error) {
        console.error("Init Failed:", error);
        showToast("ì´ˆê¸°í™” ì‹¤íŒ¨");
        setSheetName("ì˜¤í”„ë¼ì¸ ëª¨ë“œ");
      } finally {
        setIsLoadingData(false);
      }
    };

    initApp();
  }, []);

  const showToast = (msg) => {
    setToastMessage(msg);
    setTimeout(() => setToastMessage(""), 3000);
  };

  const applyLocalFilters = (candidates = allMatches) => {
    const finalResults = candidates
      .filter(item => {
        if (item.score <= 0) return false;
        if (!includeRestricted && ['ì„±ì¸', 'ê¸°íƒ€', 'adult', 'etc'].includes(item.category)) return false;
        if (selectedGenres.length > 0 && !selectedGenres.includes(item.category)) return false;
        if (priceType === 'free' && item.minPrice > 0) return false;
        if (priceType === 'paid') {
          if (item.minPrice === 0) return false; 
          if (item.minPrice < minPrice) return false; 
        }
        return true;
      })
      .sort((a, b) => b.score - a.score)
      .slice(0, 30);

    setResults(finalResults);
  };

  const handleSearch = async (inputQuery) => {
    const targetQuery = inputQuery || query;
    if (!targetQuery) return;

    setQuery(targetQuery);
    setViewState("thinking");
    setIsSearching(true); 
    setResults([]); 
    setAllMatches([]); 

    const currentYear = new Date().getFullYear();
    const augmentedQuery = `${targetQuery} (${currentYear}ë…„ ê¸°ì¤€)`;

    try {
      let aiResponse = { recommendedTitles: [], strategy: "", blockTitle: "" };
      
      // GAS_API_URLì´ YOUR_SCRIPT_IDê°€ ì•„ë‹ˆë”ë¼ë„ fetch ì‹¤íŒ¨ ì‹œ í´ë°±ì„ ìœ„í•´ êµ¬ì¡° ë³€ê²½
      try {
        if (GAS_API_URL.includes("YOUR_SCRIPT_ID")) throw new Error("Mock Mode");
        
        const response = await fetch(`${GAS_API_URL}?query=${encodeURIComponent(augmentedQuery)}&weather=${encodeURIComponent(context.weather)}`);
        if (!response.ok) throw new Error("API Error");
        const json = await response.json();
        if (json.status === 'success') {
            aiResponse = json;
        } else {
            throw new Error("API Returned Error Status");
        }
      } catch (e) {
         // Fallback Logic
         await new Promise(r => setTimeout(r, 1500));
         aiResponse = {
          recommendedTitles: [
            { title: "ë¹„ë°€ì˜ ìˆ²", reason: "ì›°ë©”ì´ë“œ ì¶”ë¦¬ê·¹", type: "ë“œë¼ë§ˆ", keywords: ["#ì¡°ìŠ¹ìš°", "#ë°°ë‘ë‚˜", "#ì¶”ë¦¬ë¬¼", "#ì›°ë©”ì´ë“œ"] },
            { title: "ê²¨ìš¸ì™•êµ­", reason: "ëˆˆ ë‚´ë¦¬ëŠ” ë‚  ì•„ì´ë“¤ê³¼ í•¨ê»˜ â„ï¸", type: "ì˜í™”", keywords: ["#ì—˜ì‚¬", "#ë””ì¦ˆë‹ˆ", "#OST"] },
            { title: "ì–´ë°”ì›ƒ íƒ€ì„", reason: "ì‹œê°„ ì—¬í–‰ ë¡œë§¨ìŠ¤ì˜ ì •ì„", type: "ì˜í™”", keywords: ["#ë ˆì´ì²¼ë§¥ì•„ë‹´ìŠ¤", "#ì‹œê°„ì—¬í–‰", "#ê°ë™"] },
            { title: "ë‚˜ í™€ë¡œ ì§‘ì—", reason: "í¬ë¦¬ìŠ¤ë§ˆìŠ¤ì—ëŠ” ì¼€ë¹ˆê³¼ í•¨ê»˜", type: "ì˜í™”", keywords: ["#ì¼€ë¹ˆ", "#í¬ë¦¬ìŠ¤ë§ˆìŠ¤", "#ë„ë‘‘"] },
            { title: "ì‘ë‹µí•˜ë¼ 1988", reason: "ë”°ëœ»í•œ ê°€ì¡± ë“œë¼ë§ˆ", type: "ë“œë¼ë§ˆ", keywords: ["#ê°€ì¡±", "#ë ˆíŠ¸ë¡œ", "#ë°•ë³´ê²€"] }
          ],
          strategy: `â„ï¸ ë‚ ì”¨(${context.weather})ì™€ ${currentYear}ë…„ íŠ¸ë Œë“œë¥¼ ë°˜ì˜í•œ íë ˆì´ì…˜ (Offline Mode)`,
          blockTitle: "ğŸ” ìš”ì²­í•˜ì‹  íë ˆì´ì…˜ ê²°ê³¼"
        };
      }

      setStrategy(aiResponse.strategy || "í‚¤ì›Œë“œ ê¸°ë°˜ ë§¤ì¹­");
      setBlockTitle(aiResponse.blockTitle || "ì¶”ì²œ ë¦¬ìŠ¤íŠ¸");

      const rawRecs = aiResponse.recommendedTitles || [];
      const normalizedRecs = rawRecs.map(r => {
        const title = typeof r === 'string' ? r : r.title;
        const reason = typeof r === 'string' ? "AI ì¶”ì²œì‘" : r.reason;
        const type = r.type || "";
        // AI í‚¤ì›Œë“œ ì•ˆì „í•˜ê²Œ ì¶”ì¶œ
        const keywords = Array.isArray(r.keywords) ? r.keywords : [];
        return { 
          rawTitle: title,
          cleanTitle: String(title).replace(/\s/g, '').toLowerCase(),
          reason,
          type,
          keywords
        };
      });
      
      const matches = dbData.map(item => {
        const myTitle = (item.title || "").replace(/\s/g, '').toLowerCase();
        let score = 0;
        let matchDetails = "";
        let matchedKeywords = [];
        
        let bestMatchScore = 0;
        let bestMatchRec = null;

        for (const rec of normalizedRecs) {
          const sim = calculateSimilarity(myTitle, rec.cleanTitle);
          if (sim > bestMatchScore) {
            bestMatchScore = sim;
            bestMatchRec = rec;
          }
        }

        if (bestMatchScore >= 0.8) {
          score = bestMatchScore * 100;
          matchDetails = `AI: ${bestMatchRec.rawTitle}`;
          matchedKeywords = bestMatchRec.keywords;
          
          if (bestMatchRec.type && item.category && !item.category.includes(bestMatchRec.type)) {
            score -= 20; 
          }
        } else {
          const cleanQuery = targetQuery.replace(/\s/g, '');
          if (cleanQuery.length > 1 && myTitle.includes(cleanQuery)) {
            score = 40;
            matchDetails = "í‚¤ì›Œë“œ í¬í•¨";
          }
        }

        return { ...item, score, matchDebug: matchDetails, aiKeywords: matchedKeywords };
      });

      const mergedMap = new Map();
      matches.forEach(item => {
        if (!mergedMap.has(item.id)) {
          mergedMap.set(item.id, {
            ...item,
            prices: [item.price], 
            minPrice: item.price
          });
        } else {
          const existing = mergedMap.get(item.id);
          if (!existing.prices.includes(item.price)) {
            existing.prices.push(item.price);
            existing.prices.sort((a, b) => a - b);
          }
          existing.minPrice = Math.min(existing.minPrice, item.price);
          existing.score = Math.max(existing.score, item.score);
          if (item.aiKeywords && item.aiKeywords.length > 0) {
             existing.aiKeywords = item.aiKeywords;
          }
        }
      });

      const candidates = Array.from(mergedMap.values());
      
      setAllMatches(candidates);
      applyLocalFilters(candidates);

      setViewState("result");

    } catch (e) {
      console.error(e);
      showToast("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      setViewState("idle");
    } finally {
      setIsSearching(false);
    }
  };

  const handleApplyFilter = () => {
    setShowFilters(false);
    if (viewState === 'result') {
      applyLocalFilters(allMatches);
    } else {
      handleSearch();
    }
  };

  const copyToClipboard = () => {
    const header = `[í¸ì„± ë¸”ë¡ëª…] ${blockTitle}\n`;
    const body = results.map(r => `${r.id}\t${r.title}`).join('\n'); 
    
    const textArea = document.createElement("textarea");
    textArea.value = header + "\n" + body;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const downloadExcel = () => {
    const blockHeader = `ì¶”ì²œ í¸ì„± ë¸”ë¡ëª…,${blockTitle}\n\n`;
    const colHeader = "ì‹œë¦¬ì¦ˆID,íƒ€ì´í‹€ëª…,ê°€ê²©ì •ë³´,ì„œë¸Œì¹´í…Œê³ ë¦¬,AIíƒœê·¸\n";
    const csvRows = results.map(r => {
      const cleanTitle = (r.title || "").replace(/,/g, " "); 
      const priceStr = r.prices.join(" / ");
      const tags = (r.aiKeywords || []).join(" ");
      return `${r.id},${cleanTitle},"${priceStr}",${r.subCategory},${tags}`;
    }).join('\n');

    const BOM = '\uFEFF';
    const blob = new Blob([BOM + blockHeader + colHeader + csvRows], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', `í¸ì„±ë¦¬ìŠ¤íŠ¸_${dateString}_${query}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const toggleGenre = (genre) => {
    setSelectedGenres(prev => 
      prev.includes(genre) ? prev.filter(g => g !== genre) : [...prev, genre]
    );
  };

  const resetApp = () => {
    setViewState("idle");
    setQuery("");
    setResults([]);
    setAllMatches([]);
  };

  if (isLoadingData) {
    return (
      <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center font-sans">
        <div className="bg-white p-8 rounded-3xl shadow-xl flex flex-col items-center max-w-sm w-full border border-slate-100 relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-purple-500 animate-pulse"></div>
          
          <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
            <Sparkles size={32} className="text-blue-600" />
          </div>
          
          <h2 className="text-xl font-bold text-slate-800 mb-4 transition-all duration-500 min-h-[3rem] flex items-center justify-center break-keep">
            {LOADING_MESSAGES[loadingMsgIndex]}
          </h2>
          
          <div className="flex items-center gap-2 text-xs font-bold text-gray-400 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-100">
             <Server size={12} />
             <span>Oasis ì„œë²„ ì—°ê²° ì¤‘...</span>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 text-gray-800 font-sans max-w-5xl mx-auto shadow-2xl overflow-hidden relative border-x border-gray-100 transition-all duration-300">
      
      {toastMessage && (
        <div className="absolute top-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-5 py-3 rounded-full shadow-xl z-50 text-sm font-bold animate-fade-in flex items-center gap-2 whitespace-nowrap">
          <CheckCircle2 size={18} className="text-green-400" />
          {toastMessage}
        </div>
      )}

      {/* Header */}
      <header className="bg-white px-5 pt-6 pb-4 sticky top-0 z-20 border-b border-gray-100">
        <div className="flex justify-between items-center mb-4">
          <div className="flex items-center gap-2" onClick={resetApp}>
            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white cursor-pointer shadow-blue-200 shadow-md">
              <Sparkles size={18} fill="currentColor" />
            </div>
            <h1 className="font-bold text-xl tracking-tight cursor-pointer">AI Curator</h1>
          </div>
          
          <div className="flex items-center gap-1.5 bg-green-50 px-3 py-1.5 rounded-full border border-green-100 shadow-sm">
            <div className="w-2 h-2 rounded-full bg-blue-500"></div>
            <span className="text-[11px] font-bold text-green-800 tracking-tight flex items-center gap-1.5">
              <FileSpreadsheet size={12} className="text-green-600"/>
              Data
            </span>
          </div>
        </div>

        <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
          <div className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-xs font-bold whitespace-nowrap border border-blue-100">
            {getWeatherIcon(context.weather)} {context.temp} {context.weather}
          </div>
          {context.trends && context.trends.map((tag, i) => (
            <button 
              key={i} 
              onClick={() => handleSearch(tag.replace("#", ""))}
              className="px-3 py-1.5 bg-white text-gray-600 rounded-full text-xs font-medium whitespace-nowrap border border-gray-200 shadow-sm active:scale-95 transition-transform hover:bg-gray-50 flex items-center gap-1"
            >
              <Hash size={10} className="text-gray-400"/>
              {tag.replace("#", "")}
            </button>
          ))}
        </div>
      </header>

      {/* Main Content */}
      <main className="p-5 pb-32 min-h-[80vh]">
        
        {/* VIEW: Idle */}
        {viewState === "idle" && (
          <div className="flex flex-col gap-6 mt-4 animate-fade-in max-w-3xl mx-auto">
            
            <SearchBar 
              query={query} 
              setQuery={setQuery} 
              handleSearch={handleSearch} 
              setShowFilters={setShowFilters}
              hasFilters={hasActiveFilters}
            />

            <div className="px-2 flex gap-3 text-sm text-gray-400">
               <span className="font-bold text-gray-500 shrink-0">ì˜ˆì‹œ:</span>
               <div className="flex gap-2 overflow-x-auto scrollbar-hide">
                 <span className="cursor-pointer hover:text-blue-500" onClick={() => setQuery("ëˆˆì˜¤ëŠ” ë‚  ì˜í™”")}>ëˆˆì˜¤ëŠ” ë‚  ì˜í™”</span>
                 <span>Â·</span>
                 <span className="cursor-pointer hover:text-blue-500" onClick={() => setQuery("ì£¼ë§ íë§ ì˜ˆëŠ¥")}>ì£¼ë§ íë§ ì˜ˆëŠ¥</span>
                 <span>Â·</span>
                 <span className="cursor-pointer hover:text-blue-500" onClick={() => setQuery("í¬ë¦¬ìŠ¤ë§ˆìŠ¤")}>í¬ë¦¬ìŠ¤ë§ˆìŠ¤</span>
               </div>
            </div>

            <div className="space-y-4 mt-2">
              <div className="flex justify-between items-center px-1">
                <p className="text-xs font-bold text-gray-400 uppercase tracking-wider">AI Recommendation</p>
                <span className="text-[10px] text-blue-500 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">Weather Based</span>
              </div>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                {todaysPicks.length > 0 ? todaysPicks.map((q, i) => (
                  <button
                    key={i}
                    onClick={() => handleSearch(q)}
                    className={`p-4 rounded-xl text-left text-sm font-bold shadow-sm hover:shadow-md active:scale-95 transition-all h-full border ${getRandomColorClass(i)}`}
                  >
                    <div className="text-lg mb-1">{getRandomEmoji(i)}</div>
                    {q}
                  </button>
                )) : ([1,2,3,4].map(n => <div key={n} className="h-20 bg-gray-100 rounded-xl animate-pulse"></div>))}
              </div>
            </div>

            {(hasActiveFilters) && (
              <div className="bg-blue-50 p-3 rounded-lg flex items-start gap-2 text-xs text-blue-700 border border-blue-100">
                <Filter size={14} className="mt-0.5" />
                <div>
                  <span className="font-bold">ì ìš©ëœ í•„í„°:</span> <br/>
                  {selectedGenres.length > 0 && `ì¥ë¥´: ${selectedGenres.join(', ')}`}
                  {selectedGenres.length > 0 && (priceType !== 'all' || includeRestricted) && ' | '}
                  {priceType === 'free' && 'ê°€ê²©: ë¬´ë£Œ'}
                  {priceType === 'paid' && `ê°€ê²©: ìœ ë£Œ (${minPrice.toLocaleString()}ì›â†‘)`}
                  {(priceType !== 'all' && includeRestricted) && ' | '}
                  {includeRestricted && <span className="text-red-500 font-bold">ì„±ì¸/ê¸°íƒ€ í¬í•¨</span>}
                </div>
              </div>
            )}
          </div>
        )}

        {/* VIEW: Thinking */}
        {viewState === "thinking" && (
          <div className="flex flex-col items-center justify-center h-64 mt-10 space-y-6 animate-pulse">
            <div className="relative">
              <div className="absolute inset-0 bg-blue-500 blur-xl opacity-20 rounded-full animate-ping"></div>
              <div className="w-20 h-20 bg-white rounded-2xl shadow-lg border border-blue-100 flex items-center justify-center relative z-10">
                <Sparkles size={32} className="text-blue-600 animate-spin-slow" />
              </div>
            </div>
            <div className="text-center space-y-1">
              <h3 className="text-lg font-bold text-gray-800">
                AI íë ˆì´ì…˜ ì§„í–‰ ì¤‘...
              </h3>
              <p className="text-sm text-gray-500">
                ìœ ì‚¬ë„ ë¶„ì„ ë° ì¤‘ë³µ ë°ì´í„°<br/>
                ë³‘í•© ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.
              </p>
            </div>
          </div>
        )}

        {/* VIEW: Result */}
        {viewState === "result" && (
          <div className="space-y-6 animate-slide-up" ref={resultRef}>
            
            <div className="mb-6">
              <SearchBar 
                query={query} 
                setQuery={setQuery} 
                handleSearch={handleSearch} 
                setShowFilters={setShowFilters}
                compact={true} 
                hasFilters={hasActiveFilters}
              />
              
              {(hasActiveFilters) && (
                <div className="mt-2 text-[10px] text-blue-600 font-bold flex gap-2 overflow-hidden whitespace-nowrap px-1">
                   <Filter size={10} className="mt-0.5"/>
                   <span>í•„í„° ì ìš© ì¤‘:</span>
                   {selectedGenres.length > 0 && <span>{selectedGenres.join(', ')}</span>}
                   {priceType === 'free' && <span>| ë¬´ë£Œ</span>}
                   {priceType === 'paid' && <span>| ìœ ë£Œ ({minPrice.toLocaleString()}ì›â†‘)</span>}
                   {includeRestricted && <span className="text-red-500">| ì„±ì¸í¬í•¨</span>}
                </div>
              )}
            </div>

            <div className="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
              <Edit3 className="absolute top-5 right-5 text-white opacity-50" size={20} />
              <div className="relative z-10">
                <div className="flex items-center gap-2 mb-3 text-purple-200 text-xs font-bold uppercase tracking-wider">
                  <Sparkles size={12} /> AI Recommended Title
                </div>
                <h3 className="text-2xl font-bold leading-snug pr-8 tracking-tight">
                  {blockTitle}
                </h3>
                <p className="text-xs text-purple-200 mt-3 opacity-80 flex items-center gap-1">
                  <Download size={10} /> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œ ë§¤ì¹­ ìƒì„¸ ì‚¬ìœ ê°€ í¬í•¨ë©ë‹ˆë‹¤.
                </p>
              </div>
            </div>

            <div className="bg-slate-50 border border-slate-200 rounded-xl p-4 flex gap-4 items-center">
               <div className="bg-slate-200 p-2.5 rounded-lg text-slate-500">
                 <Zap size={18} />
               </div>
               <div>
                 <div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Curator Strategy</div>
                 <div className="text-sm text-slate-700 font-medium">{strategy}</div>
               </div>
            </div>

            <div className="flex items-center justify-between px-1 pt-2">
              <h4 className="font-bold text-gray-800 flex items-center gap-2 text-lg">
                <CheckCircle2 size={20} className="text-green-500" />
                ì¶”ì²œ ê²°ê³¼ ({results.length}ê±´)
              </h4>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {results.length > 0 ? results.map((item, idx) => (
                <div key={idx} className="bg-white p-5 rounded-xl border border-gray-100 shadow-sm flex flex-col justify-between hover:shadow-md transition-shadow group">
                  <div>
                    <div className="flex justify-between items-start gap-3">
                      <span className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded font-mono font-bold shrink-0 border border-slate-200 h-fit mt-0.5">
                        {item.id}
                      </span>
                      <h5 className="font-bold text-gray-900 text-lg leading-tight break-keep flex-1 text-right">
                        {item.title}
                      </h5>
                    </div>
                    
                    <div className="flex justify-end flex-wrap gap-1 mt-3">
                       <span className={`px-2 py-1 rounded text-[10px] font-bold border flex items-center gap-1 ${getTagStyle(item.subCategory)}`}>
                          <Hash size={10} /> {item.subCategory}
                       </span>

                       {item.aiKeywords && item.aiKeywords.length > 0 ? (
                          item.aiKeywords.map((k, kIdx) => (
                            <span key={kIdx} className="px-2 py-1 bg-blue-50 text-blue-600 text-[10px] font-bold rounded flex items-center gap-1 border border-blue-100">
                               {k}
                            </span>
                          ))
                       ) : null}
                    </div>
                  </div>

                  <div className="flex items-center justify-end gap-2 mt-4 pt-3 border-t border-gray-50">
                    <span className="text-xs text-gray-400">
                        {item.prices.length > 1 ? (
                            <span className="flex items-center gap-1">
                                {item.prices.map((p, i) => (
                                    <React.Fragment key={i}>
                                        <span className={`font-bold ${p === 0 ? 'text-green-600' : 'text-slate-600'}`}>
                                            {p === 0 ? "ë¬´ë£Œ" : `${p.toLocaleString()}ì›`}
                                        </span>
                                        {i < item.prices.length - 1 && <span className="text-gray-300">/</span>}
                                    </React.Fragment>
                                ))}
                            </span>
                        ) : (
                            <span className={`font-bold ${item.prices[0] === 0 ? 'text-green-600' : 'text-slate-600'}`}>
                                {item.prices[0] === 0 ? "ë¬´ë£Œ" : `${item.prices[0].toLocaleString()}ì›`}
                            </span>
                        )}
                    </span>
                  </div>
                </div>
              )) : (
                <div className="col-span-full text-center py-16 text-gray-400">
                  <div className="inline-block p-4 bg-gray-50 rounded-full mb-3">
                    <AlertTriangle size={24} className="text-gray-300" />
                  </div>
                  <p className="font-bold text-gray-600">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                  <p className="text-xs text-gray-400 mt-2 max-w-xs mx-auto leading-relaxed">
                    AIê°€ ì¶”ì²œí•œ íƒ€ì´í‹€ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” DB ì½˜í…ì¸ ê°€ ì—†ê±°ë‚˜,
                    ì„¤ì •ëœ í•„í„°ì— ì˜í•´ ì œì™¸ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                  </p>
                  <button onClick={() => { setPriceType('all'); setSelectedGenres([]); setIncludeRestricted(false); applyLocalFilters(); }} className="text-blue-600 text-sm font-bold mt-4 underline">
                    í•„í„° ì´ˆê¸°í™”
                  </button>
                </div>
              )}
            </div>

            <div className="h-20"></div>
          </div>
        )}
      </main>

      {/* Floating Action Bar */}
      {viewState === "result" && (
        <div className="absolute bottom-6 left-5 right-5 z-30 flex justify-center pointer-events-none">
          <div className="flex gap-3 w-full max-w-2xl pointer-events-auto animate-slide-up bg-white/80 backdrop-blur-sm p-2 rounded-2xl border border-white/50 shadow-2xl">
            <button 
              onClick={resetApp}
              className="w-14 h-14 bg-white border border-gray-200 rounded-xl shadow-sm flex items-center justify-center text-gray-500 hover:bg-gray-50 hover:text-gray-800 active:scale-95 transition-all"
              title="ì´ˆê¸°í™”"
            >
              <RotateCcw size={22} />
            </button>

            <button 
              onClick={downloadExcel}
              className="w-14 h-14 bg-white border border-gray-200 rounded-xl shadow-sm flex items-center justify-center text-green-600 hover:bg-green-50 active:scale-95 transition-all"
              title="ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ"
            >
              <Download size={22} />
            </button>
            
            <button 
              onClick={copyToClipboard}
              className={`flex-1 h-14 rounded-xl shadow-sm font-bold text-lg flex items-center justify-center gap-2 transition-all active:scale-95 ${copied ? 'bg-indigo-600 text-white' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
            >
              {copied ? (
                <>
                  <CheckCircle2 size={22} />
                  ID ë³µì‚¬ ì™„ë£Œ!
                </>
              ) : (
                <>
                  <Copy size={22} />
                  ë¦¬ìŠ¤íŠ¸ ë³µì‚¬ (ID)
                </>
              )}
            </button>
          </div>
        </div>
      )}

      {/* Filters Modal: Fixed Positionìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ìŠˆ í•´ê²° */}
      {showFilters && (
        <div className="fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center sm:justify-center animate-fade-in" onClick={(e) => e.target === e.currentTarget && setShowFilters(false)}>
          <div className="bg-white w-full sm:w-[400px] sm:rounded-3xl rounded-t-3xl p-6 pb-10 space-y-6 animate-slide-up shadow-2xl">
            <div className="flex justify-between items-center">
              <h3 className="text-xl font-bold">ê²€ìƒ‰ í•„í„°</h3>
              <button onClick={() => setShowFilters(false)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
                <X size={20} />
              </button>
            </div>

            <div className="space-y-4">
              {/* ì„±ì¸/ê¸°íƒ€ í¬í•¨ ì—¬ë¶€ */}
              <div className="flex items-center justify-between bg-red-50 p-3 rounded-xl border border-red-100">
                <span className="text-sm font-bold text-red-600">ì„±ì¸/ê¸°íƒ€ ì¹´í…Œê³ ë¦¬ í¬í•¨</span>
                <button 
                  onClick={() => setIncludeRestricted(!includeRestricted)}
                  className={`w-12 h-7 rounded-full transition-colors relative ${includeRestricted ? 'bg-red-500' : 'bg-gray-300'}`}
                >
                  <div className={`absolute top-1 left-1 w-5 h-5 bg-white rounded-full shadow transition-transform ${includeRestricted ? 'translate-x-5' : ''}`}></div>
                </button>
              </div>

              <div className="space-y-2">
                <label className="text-sm font-bold text-gray-500">ì¥ë¥´ (Category)</label>
                <div className="flex flex-wrap gap-2">
                  {allGenres.length > 0 ? allGenres.map(g => (
                    <button 
                      key={g}
                      onClick={() => toggleGenre(g)}
                      className={`px-4 py-2 rounded-full text-sm font-medium border transition-all ${selectedGenres.includes(g) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200 hover:border-blue-400'}`}
                    >
                      {g}
                    </button>
                  )) : <span className="text-sm text-gray-400">ë°ì´í„° ë¡œë“œ í›„ ì„ íƒ ê°€ëŠ¥</span>}
                </div>
              </div>
            </div>

            {/* ê°€ê²© í•„í„° */}
            <div className="space-y-4 pt-2 border-t border-gray-100">
              <label className="text-sm font-bold text-gray-500 flex items-center gap-1">
                <DollarSign size={14} /> ê°€ê²© (Price)
              </label>
              
              <div className="flex gap-2">
                {[{l:'ì „ì²´', v:'all'}, {l:'ë¬´ë£Œ', v:'free'}, {l:'ìœ ë£Œ', v:'paid'}].map(opt => (
                  <button
                    key={opt.v}
                    onClick={() => setPriceType(opt.v)}
                    className={`flex-1 py-3 rounded-xl text-sm font-bold border transition-all ${priceType === opt.v ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200 hover:border-blue-400'}`}
                  >
                    {opt.l}
                  </button>
                ))}
              </div>

              {priceType === 'paid' && (
                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 animate-fade-in">
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-xs font-bold text-gray-500">ìµœì†Œ ê°€ê²© ì„¤ì •</span>
                    <span className="text-sm font-bold text-blue-600">{minPrice.toLocaleString()}ì› ì´ìƒ</span>
                  </div>
                  <input 
                    type="range" 
                    min="0" 
                    max="20000" 
                    step="500" 
                    value={minPrice} 
                    onChange={(e) => setMinPrice(Number(e.target.value))}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                  />
                  <div className="flex justify-between text-[10px] text-gray-400 mt-1 px-1">
                    <span>0ì›</span>
                    <span>10,000ì›</span>
                    <span>20,000ì›+</span>
                  </div>
                </div>
              )}
            </div>

            <button 
              onClick={handleApplyFilter}
              className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold text-lg hover:bg-slate-800 transition-colors mt-2"
            >
              ì ìš©í•˜ê¸°
            </button>
          </div>
        </div>
      )}

      <style>{`
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes slide-up {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      `}</style>
    </div>
  );
}
