<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Curator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (JSX Î≥ÄÌôòÏö©) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes slide-up {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
        .animate-ping { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; }
        
        /* Drag and Drop Styles */
        .draggable-item { cursor: grab; }
        .draggable-item:active { cursor: grabbing; }
        .drag-over { border: 2px dashed #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Lucide Icon Helper ---
        const Icon = ({ name, size = 24, className, color = "currentColor", ...props }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke={color}
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                    {...props}
                >
                    {iconData.map((child, index) => {
                        const [tag, attrs] = child;
                        return React.createElement(tag, { ...attrs, key: index });
                    })}
                </svg>
            );
        };

        const Sparkles = (p) => <Icon name="Sparkles" {...p} />;
        const Search = (p) => <Icon name="Search" {...p} />;
        const CloudSnow = (p) => <Icon name="CloudSnow" {...p} />;
        const CloudRain = (p) => <Icon name="CloudRain" {...p} />;
        const Cloud = (p) => <Icon name="Cloud" {...p} />;
        const Sun = (p) => <Icon name="Sun" {...p} />;
        const Zap = (p) => <Icon name="Zap" {...p} />;
        const CheckCircle2 = (p) => <Icon name="CheckCircle2" {...p} />;
        const ArrowRight = (p) => <Icon name="ArrowRight" {...p} />;
        const Copy = (p) => <Icon name="Copy" {...p} />;
        const RotateCcw = (p) => <Icon name="RotateCcw" {...p} />;
        const Filter = (p) => <Icon name="Filter" {...p} />;
        const X = (p) => <Icon name="X" {...p} />;
        const Download = (p) => <Icon name="Download" {...p} />;
        const Edit3 = (p) => <Icon name="Edit3" {...p} />;
        const Server = (p) => <Icon name="Server" {...p} />;
        const FileSpreadsheet = (p) => <Icon name="FileSpreadsheet" {...p} />;
        const Hash = (p) => <Icon name="Hash" {...p} />;
        const DollarSign = (p) => <Icon name="DollarSign" {...p} />;
        const AlertTriangle = (p) => <Icon name="AlertTriangle" {...p} />;
        const Trash2 = (p) => <Icon name="Trash2" {...p} />;
        const GripVertical = (p) => <Icon name="GripVertical" {...p} />;
        const Database = (p) => <Icon name="Database" {...p} />;
        const CalendarClock = (p) => <Icon name="CalendarClock" {...p} />;
        const CheckSquare = (p) => <Icon name="CheckSquare" {...p} />;
        const Square = (p) => <Icon name="Square" {...p} />;

        // --- CONFIGURATION ---
        const GAS_API_URL = "https://jolly-sun-635f.alcheminos.workers.dev/"; 
        const CACHE_EXPIRY_MS = 24 * 60 * 60 * 1000; // 24ÏãúÍ∞Ñ Ï∫êÏãú

        // --- IndexedDB Helper Functions ---
        const DB_NAME = "AI_Curator_DB";
        const STORE_NAME = "titles";
        const DB_VERSION = 1;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("IndexedDB open failed");
                request.onsuccess = (event) => resolve(event.target.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: "id" });
                    }
                };
            });
        };

        const saveToIndexedDB = async (data) => {
            try {
                const db = await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], "readwrite");
                    const store = transaction.objectStore(STORE_NAME);
                    // ÎåÄÏö©Îüâ Îç∞Ïù¥ÌÑ∞Î•º ÌïòÎÇòÏùò Î†àÏΩîÎìúÎ°ú Ï†ÄÏû• (key: "full_dump")
                    const item = { id: "full_dump", data: data, timestamp: new Date().getTime() };
                    const request = store.put(item);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e);
                });
            } catch (e) {
                console.error("IndexedDB Save Error:", e);
                throw e;
            }
        };

        const loadFromIndexedDB = async () => {
            try {
                const db = await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], "readonly");
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get("full_dump");
                    request.onsuccess = (event) => {
                        const result = event.target.result;
                        resolve(result ? result : null);
                    };
                    request.onerror = (e) => reject(e);
                });
            } catch (e) {
                console.error("IndexedDB Load Error:", e);
                return null;
            }
        };

        const clearIndexedDB = async () => {
             const db = await initDB();
             return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], "readwrite");
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e);
            });
        }

        // --- HELPER FUNCTIONS ---

        const getSeasonalKeywords = () => {
            const month = new Date().getMonth() + 1;
            if (month >= 12 || month <= 2) {
                return {
                    season: "Í≤®Ïö∏",
                    keywords: ["#Îî∞ÎúªÌïúÏ†ÑÍ∏∞Ïû•Ìåê", "#ÌÅ¨Î¶¨Ïä§ÎßàÏä§", "#Ïó∞ÎßêÏ†ïÏ£ºÌñâ", "#Í≤®Ïö∏Î∞©Ìïô", "#Í∑§ÍπåÎ®πÏúºÎ©∞"],
                    desc: "Ïù¥Î∂à Î∞ñÏùÄ ÏúÑÌóòÌï¥! Í≤®Ïö∏ ÌïÑÏàò ÏãúÏ≤≠Ïûë",
                    sentences: [
                        "Í∑§ ÍπåÎ®πÏúºÎ©∞ Î≥¥Í∏∞ Ï¢ãÏùÄ Í≤®Ïö∏ Ï†ïÏ£ºÌñâ ÏãúÎ¶¨Ï¶à üçä",
                        "Ïó∞Îßê Î∂ÑÏúÑÍ∏∞ Î¨ºÏî¨ ÎÇòÎäî ÌÅ¨Î¶¨Ïä§ÎßàÏä§ ÌäπÏÑ† üéÑ",
                        "Ï∂îÏö¥ ÎÇ† ÎßàÏùåÍπåÏßÄ Îî∞ÎúªÌï¥ÏßÄÎäî ÌûêÎßÅ Î¨¥ÎπÑ ‚òï",
                        "Í∏¥ Í≤®Ïö∏Î∞§ÏùÑ Ï±ÖÏûÑÏßà Î™∞ÏûÖÍ∞ê 100% Ïä§Î¶¥Îü¨ üåô"
                    ]
                };
            } else if (month >= 3 && month <= 5) {
                return {
                    season: "Î¥Ñ",
                    keywords: ["#Î¥ÑÎÇòÎì§Ïù¥", "#Î≤öÍΩÉÏóîÎî©", "#Î°úÎß®Ïä§", "#ÏÉàÌïôÍ∏∞", "#ÏÑ§Î†òÏ£ºÏùò"],
                    desc: "ÏÇ¥ÎûëÏÇ¥Îûë Î¥ÑÎ∞îÎûå ÌÉÄÍ≥† Ïò® Î°úÎß®Ïä§",
                    sentences: [
                        "Î¥ÑÎ∞îÎûå ÌúòÎÇ†Î¶¨Î©∞ Î≥¥Í≥† Ïã∂ÏùÄ ÏÑ§Î†ò Î°úÎß®Ïä§ üå∏",
                        "ÏÉàÎ°úÏö¥ ÏãúÏûë, ÌôúÍ∏∞Ï∞¨ ÏóêÎÑàÏßÄÎ•º Ï£ºÎäî ÏÑ±Ïû• ÎìúÎùºÎßà üå±",
                        "ÎÇòÎ•∏Ìïú Ïò§ÌõÑÎ•º Íπ®ÏõåÏ§Ñ Ïú†ÏæåÌïú ÏòàÎä• Ìïú Ï°∞Í∞Å ‚òÄÔ∏è",
                        "Î≤öÍΩÉ ÌîºÎäî Í≥ÑÏ†à, Îã§Ïãú Í∫ºÎÇ¥Î≥¥Îäî Ï≤´ÏÇ¨Îûë Î™ÖÏûë üíï"
                    ]
                };
            } else if (month >= 6 && month <= 8) {
                return {
                    season: "Ïó¨Î¶Ñ",
                    keywords: ["#Í≥µÌè¨ÌäπÏßë", "#Ìò∏Îü¨", "#Ïó¨Î¶ÑÌú¥Í∞Ä", "#Î∞îÏ∫âÏä§", "#ÏãúÏõêÌïúÏï°ÏÖò"],
                    desc: "Î¨¥ÎçîÏúÑÎ•º ÎÇ†Î†§Î≤ÑÎ¶¥ ÏãúÏõêÌïú ÏΩòÌÖêÏ∏†",
                    sentences: [
                        "Î¨¥ÎçîÏúÑ ÌÉÄÌåå! Îì±Í≥®Ïù¥ Ïò§ÏãπÌï¥ÏßÄÎäî Í≥µÌè¨ ÌäπÏßë üëª",
                        "ÏßëÏóêÏÑú Îñ†ÎÇòÎäî ÏãúÏõêÌïú Î∞©Íµ¨ÏÑù Î∞îÏ∫âÏä§ üåä",
                        "ÎãµÎãµÌïú ÏÜçÏù¥ Îª• Îö´Î¶¨Îäî ÏÇ¨Ïù¥Îã§ Ïï°ÏÖò ÏòÅÌôî ü•§",
                        "Ïó¥ÎåÄÏïº Ïû† Î™ª ÎìúÎäî Î∞§, ÏãúÍ∞Ñ ÏàúÏÇ≠ Ï†ïÏ£ºÌñâ üåô"
                    ]
                };
            } else {
                return {
                    season: "Í∞ÄÏùÑ",
                    keywords: ["#Í∞êÏÑ±Ï∂©Îßå", "#ÎèÖÏÑúÏùòÍ≥ÑÏ†à", "#Î©úÎ°ú", "#Îã®ÌíçÎÜÄÏù¥", "#Ï∂îÏÑùÌäπÏÑ†"],
                    desc: "ÏÑºÏπòÌïú Í∞ÄÏùÑ Î∞§, Í∞êÏÑ± Ï∂©Ï†Ñ ÌÉÄÏûÑ",
                    sentences: [
                        "ÏåÄÏåÄÌïú Í∞ÄÏùÑÎ∞§, Í∞êÏÑ±ÏùÑ Ï±ÑÏõåÏ§Ñ Î©úÎ°ú ÏòÅÌôî üçÇ",
                        "ÍπäÏñ¥Í∞ÄÎäî Í∞ÄÏùÑ, ÏÉùÍ∞ÅÏóê Ïû†Í∏∞Í≤å ÌïòÎäî Î™ÖÏûëÎì§ üìö",
                        "ÌíçÏÑ±Ìïú ÌïúÍ∞ÄÏúÑ, Ïò® Í∞ÄÏ°±Ïù¥ Ìï®Íªò Î≥¥Îäî ÌäπÏÑ†Ïûë üåï",
                        "ÎÇôÏóΩ Îñ®Ïñ¥Ïßà Îïå ÏÉùÍ∞ÅÎÇòÎäî Ï∂îÏñµÏùò ÎìúÎùºÎßà üéûÔ∏è"
                    ]
                };
            }
        };

        const calculateSimilarity = (s1, s2) => {
            const clean1 = String(s1).replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, "").toLowerCase();
            const clean2 = String(s2).replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, "").toLowerCase();
            if (clean1 === clean2) return 1.0; 
            if (clean1.includes(clean2) || clean2.includes(clean1)) {
                const ratio = Math.min(clean1.length, clean2.length) / Math.max(clean1.length, clean2.length);
                return 0.8 + (ratio * 0.2); 
            }
            return 0.0; 
        };

        const fetchRealWeather = async () => {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                
                const res = await fetch('https://wttr.in/?format=j1', { signal: controller.signal });
                clearTimeout(timeoutId);

                const data = await res.json();
                const current = data.current_condition[0];
                const desc = current.weatherDesc[0].value.toLowerCase();
                
                let simplifiedDesc = "ÎßëÏùå";
                if (desc.includes('rain') || desc.includes('drizzle')) simplifiedDesc = "ÎπÑ";
                else if (desc.includes('snow') || desc.includes('ice')) simplifiedDesc = "Îàà";
                else if (desc.includes('cloud') || desc.includes('overcast')) simplifiedDesc = "ÌùêÎ¶º";
                else if (desc.includes('fog') || desc.includes('mist')) simplifiedDesc = "ÏïàÍ∞ú";

                return {
                    temp: `${current.temp_C}¬∞C`,
                    weather: simplifiedDesc
                };
            } catch (e) {
                const seasonInfo = getSeasonalKeywords();
                return { temp: "", weather: seasonInfo.season, isFallback: true };
            }
        };

        const getRandomColorClass = (idx) => {
            const colors = [
                'bg-red-50 border-red-100 text-red-600',
                'bg-orange-50 border-orange-100 text-orange-600',
                'bg-amber-50 border-amber-100 text-amber-600',
                'bg-green-50 border-green-100 text-green-600',
                'bg-teal-50 border-teal-100 text-teal-600',
                'bg-blue-50 border-blue-100 text-blue-600',
                'bg-indigo-50 border-indigo-100 text-indigo-600',
                'bg-purple-50 border-purple-100 text-purple-600',
                'bg-pink-50 border-pink-100 text-pink-600'
            ];
            return colors[idx % colors.length];
        };

        const getRandomEmoji = (idx) => {
            const emojis = ['üé¨', 'üçø', 'üì∫', 'üåü', 'üëÄ', '‚ú®', 'üíø', 'üìº', 'üìΩÔ∏è'];
            return emojis[idx % emojis.length];
        };

        const LOADING_MESSAGES = [
            "üçø Ï∫êÏãúÎêú Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏ Ï§ë...",
            "üé¨ Í∞êÎèÖÎãò ÏÑ≠Ïô∏ÌïòÎü¨ Í∞ÄÎäî Ï§ë...",
            "‚ö°Ô∏è ÎÑ∑ÌîåÎ¶≠Ïä§Î≥¥Îã§ Îπ†Î•¥Í≤å...Îäî ÎÖ∏Î†• Ï§ëÏûÖÎãàÎã§",
            "‚õèÔ∏è Ïà®Í≤®ÏßÑ Î™ÖÏûë Îç∞Ïù¥ÌÑ∞Î•º Î∞úÍµ¥ÌïòÍ≥† ÏûàÏñ¥Ïöî",
            "ü§ñ AIÍ∞Ä ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎèÖÌïòÎäî Ï§ë...",
            "‚ùÑÔ∏è Í≥ÑÏ†àÏóê Îî± ÎßûÎäî ÏΩòÌÖêÏ∏† Ï∞æÎäî Ï§ë...",
            "üõ´ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏßÄÎü¨ ÌóêÎ¶¨Ïö∞Îìú Í∞ÄÎäî Ï§ë",
            "üì° Oasis ÏÑúÎ≤ÑÏôÄ ÍµêÏã† ÏãúÎèÑ Ï§ë..."
        ];

        const getTagStyle = (text) => {
            const t = String(text).replace('#', '').trim();
            if (t === 'ÌïúÍµ≠ÏòÅÌôî') return 'bg-indigo-50 text-indigo-600 border-indigo-100';
            if (t === 'CJ ENM' || t === 'CJ') return 'bg-orange-50 text-orange-600 border-orange-100';
            if (t === 'ÏòÅÌôî') return 'bg-slate-100 text-slate-600 border-slate-200';
            if (t === 'ÎìúÎùºÎßà') return 'bg-rose-50 text-rose-600 border-rose-100';
            if (t === 'ÏòàÎä•') return 'bg-yellow-50 text-yellow-600 border-yellow-100';
            return 'bg-blue-50 text-blue-600 border-blue-100';
        };

        // --- COMPONENTS ---

        const SearchBar = ({ 
            query, 
            setQuery, 
            handleSearch, 
            setShowFilters, 
            compact = false, 
            hasFilters = false 
        }) => (
            <div className={`relative group z-10 transition-all ${compact ? 'shadow-none' : 'shadow-sm'}`}>
                <input
                    type="text"
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                    onKeyDown={(e) => e.key === "Enter" && handleSearch()}
                    placeholder="Í≤ÄÏÉâÏñ¥ ÎòêÎäî Ìé∏ÏÑ± ÌÖåÎßàÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                    className={`w-full bg-white border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all placeholder:text-gray-300 ${compact ? 'py-3 pl-4 pr-20 text-base rounded-xl' : 'p-5 pr-24 text-lg rounded-2xl'}`}
                />
                <div className={`absolute right-2 flex gap-1 ${compact ? 'top-2' : 'top-3'}`}>
                    <button 
                        onClick={() => setShowFilters(true)}
                        className={`rounded-lg transition-all flex items-center justify-center ${compact ? 'p-1.5 w-8 h-8' : 'p-2.5'} ${hasFilters ? 'bg-blue-100 text-blue-600' : 'bg-gray-50 text-gray-400 hover:bg-gray-100'}`}
                    >
                        <Filter size={compact ? 16 : 20} />
                    </button>
                    <button 
                        onClick={() => handleSearch()}
                        className={`rounded-lg transition-all flex items-center justify-center ${compact ? 'p-1.5 w-8 h-8' : 'p-2.5'} ${query ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-300'}`}
                    >
                        <ArrowRight size={compact ? 16 : 20} />
                    </button>
                </div>
            </div>
        );

        const App = () => {
            // Core State
            const [query, setQuery] = useState("");
            const [viewState, setViewState] = useState("idle");
            const [dbData, setDbData] = useState([]); 
            const [results, setResults] = useState([]); // ÌòÑÏû¨ Î≥¥Ïó¨ÏßÄÎäî(Ìé∏ÏßëÎêú) Í≤∞Í≥º
            const [originalResults, setOriginalResults] = useState([]); // ÌïÑÌÑ∞ÎßÅ Ï†Ñ ÏõêÎ≥∏ Îß§Ïπ≠ Í≤∞Í≥º

            // UI State
            const [strategy, setStrategy] = useState("");
            const [blockTitle, setBlockTitle] = useState("");
            const [copied, setCopied] = useState(false);
            const [showFilters, setShowFilters] = useState(false);
            const [showDateModal, setShowDateModal] = useState(false);
            const [toastMessage, setToastMessage] = useState(""); 
            const [loadingMsgIndex, setLoadingMsgIndex] = useState(0);
            const [isLoadingData, setIsLoadingData] = useState(true);
            const [isSearching, setIsSearching] = useState(false);
            
            // Selection & DnD
            const [selectedItems, setSelectedItems] = useState(new Set());
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);
            
            // Bulk Edit State
            const [bulkStartDate, setBulkStartDate] = useState("");
            const [bulkEndDate, setBulkEndDate] = useState("");

            // Context State
            const [context, setContext] = useState({ weather: "", temp: "", trends: [] }); 
            const [todaysPicks, setTodaysPicks] = useState([]);
            const [lastUpdated, setLastUpdated] = useState(null);

            // Filters
            const [selectedGenres, setSelectedGenres] = useState([]);
            const [priceType, setPriceType] = useState("all"); 
            const [minPrice, setMinPrice] = useState(0); 
            const [includeRestricted, setIncludeRestricted] = useState(false); 

            const resultRef = useRef(null);
            
            const allGenres = dbData.length > 0 
                ? Array.from(new Set(dbData.map(item => item.category).filter(Boolean))) 
                : [];

            const hasActiveFilters = selectedGenres.length > 0 || priceType !== 'all' || includeRestricted;

            // --- Effects ---

            useEffect(() => {
                if (isLoadingData) {
                    const interval = setInterval(() => {
                        setLoadingMsgIndex((prev) => (prev + 1) % LOADING_MESSAGES.length);
                    }, 1500); 
                    return () => clearInterval(interval);
                }
            }, [isLoadingData]);

            useEffect(() => {
                const initApp = async () => {
                    setIsLoadingData(true);
                    
                    const weatherData = await fetchRealWeather();
                    const seasonalInfo = getSeasonalKeywords(); 
                    
                    setContext({
                        weather: weatherData.weather,
                        temp: weatherData.temp,
                        trends: seasonalInfo.keywords
                    });
                    
                    setTodaysPicks(seasonalInfo.sentences);

                    try {
                        const cached = await loadFromIndexedDB();
                        let loadedData = null;
                        let loadedTime = null;

                        if (cached) {
                            const now = new Date().getTime();
                            if (now - cached.timestamp < CACHE_EXPIRY_MS) {
                                loadedData = cached.data;
                                loadedTime = new Date(cached.timestamp);
                                console.log("Using IndexedDB cached data");
                            }
                        }

                        if (!loadedData) {
                            console.log("Fetching fresh DB data");
                            const response = await fetch(GAS_API_URL); 
                            const json = await response.json();
                            if (json.status === 'success' && json.data) {
                                loadedData = json.data;
                                loadedTime = new Date();
                                await saveToIndexedDB(loadedData);
                            } else {
                                throw new Error("Invalid API Data");
                            }
                        }

                        if (loadedData) {
                            setDbData(loadedData);
                            setLastUpdated(loadedTime);
                            showToast(`Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å (${loadedData.length.toLocaleString()}Í±¥)`);
                        }

                    } catch (error) {
                        console.error("Data Load Failed:", error);
                        showToast("Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå® (Ïò§ÌîÑÎùºÏù∏ Î™®Îìú)");
                        setDbData([
                            { id: "CS_MOCK_01", title: "Ï∫êÏãú Î°úÎìú Ïã§Ìå® ÏòàÏãú1", category: "ÏòÅÌôî", price: 0 },
                            { id: "CS_MOCK_02", title: "Ï∫êÏãú Î°úÎìú Ïã§Ìå® ÏòàÏãú2", category: "ÎìúÎùºÎßà", price: 1000 }
                        ]);
                    } finally {
                        setIsLoadingData(false);
                    }
                };

                initApp();
            }, []);

            // --- Handlers ---

            const clearCache = async () => {
                try {
                    await clearIndexedDB();
                    window.location.reload();
                } catch (e) {
                    console.error("Cache clear failed", e);
                    alert("Ï∫êÏãú Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                }
            };

            const showToast = (msg) => {
                setToastMessage(msg);
                setTimeout(() => setToastMessage(""), 3000);
            };

            // Í∏∞Î≥∏ ÎÇ†Ïßú ÏÉùÏÑ± Ìï®Ïàò
            const getDefaultDates = () => {
                const now = new Date();
                const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0); // Ïò§Îäò 00:00
                const end = new Date("9999-12-31T23:59:59");
                
                // datetime-local input value format: YYYY-MM-DDTHH:mm
                const formatForInput = (d) => {
                    const pad = (n) => String(n).padStart(2, '0');
                    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                };

                return {
                    start: formatForInput(start),
                    end: formatForInput(end)
                };
            };

            const handleSearch = async (inputQuery) => {
                const targetQuery = inputQuery || query;
                if (!targetQuery) return;

                setQuery(targetQuery);
                setViewState("thinking");
                setIsSearching(true);
                setResults([]);
                setSelectedItems(new Set());

                const currentYear = new Date().getFullYear();
                const augmentedQuery = `${targetQuery} (${currentYear}ÎÖÑ ${context.weather} ÎÇ†Ïî®)`;
                const { start: defaultStart, end: defaultEnd } = getDefaultDates();

                try {
                    let aiResponse = { recommendedTitles: [], strategy: "", blockTitle: "" };

                    try {
                        const response = await fetch(`${GAS_API_URL}?query=${encodeURIComponent(augmentedQuery)}&weather=${encodeURIComponent(context.weather)}&mode=planning`);
                        if (response.ok) {
                            const json = await response.json();
                            aiResponse = json;
                        }
                    } catch (e) {
                        console.warn("AI Planning API Failed, using local heuristic");
                    }

                    const seasonalInfo = getSeasonalKeywords();
                    setStrategy(aiResponse.strategy || `‚òÅÔ∏è ${context.weather} ÎÇ†Ïî®ÏôÄ ${seasonalInfo.season} ÏãúÏ¶å Í∞êÏÑ±ÏùÑ Îã¥ÏùÄ ÌÅêÎ†àÏù¥ÏÖò`);
                    setBlockTitle(aiResponse.blockTitle || `[${seasonalInfo.season}] ${targetQuery} Ï∂îÏ≤ú Î¶¨Ïä§Ìä∏`);

                    const rawRecs = aiResponse.recommendedTitles || [];
                    const normalizedRecs = rawRecs.map(r => ({
                        rawTitle: typeof r === 'string' ? r : r.title,
                        cleanTitle: String(typeof r === 'string' ? r : r.title).replace(/\s/g, '').toLowerCase(),
                        reason: r.reason || "AI Ï∂îÏ≤ú",
                        // AIÍ∞Ä typeÏùÑ Ï£ºÎ©¥ Ïì∞Í≥†, ÏóÜÏúºÎ©¥ ÏøºÎ¶¨ Î¨∏Îß•ÏúºÎ°ú Ï∂îÏ∏° (Ï†ïÏ£ºÌñâ -> ÎìúÎùºÎßà)
                        targetType: r.type ? r.type.toLowerCase() : (targetQuery.includes("Ï†ïÏ£ºÌñâ") || targetQuery.includes("ÎìúÎùºÎßà") ? "drama" : ""), 
                        keywords: r.keywords || []
                    }));
                    
                    const candidates = dbData.map(item => {
                        // DB Îç∞Ïù¥ÌÑ∞ Ï†ÑÏ≤òÎ¶¨
                        const myTitle = (item.title || "").replace(/\s/g, '').toLowerCase();
                        const myCategory = (item.category || "").toLowerCase(); // ÏòÅÌôî, ÎìúÎùºÎßà, ÏòàÎä• Îì±
                        
                        let score = 0;
                        let aiReason = "";
                        let matchType = "none"; // ÎîîÎ≤ÑÍπÖÏö©
                    
                        // AI Ï∂îÏ≤ú Î¶¨Ïä§Ìä∏ÏôÄ ÎπÑÍµê
                        for (const rec of normalizedRecs) {
                            const sim = calculateSimilarity(myTitle, rec.cleanTitle);
                            
                            if (sim > 0.6) { // Ïú†ÏÇ¨ÎèÑÍ∞Ä Ïñ¥ÎäêÏ†ïÎèÑ ÏûàÏùÑ Îïå
                                let currentScore = sim * 100;
                    
                                // [ÌïµÏã¨] Ïò§Îß§Ìïë Î∞©ÏßÄ Î°úÏßÅ: Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏ¶ù
                                // rec.targetTypeÏù¥ Ï°¥Ïû¨ÌïòÍ≥†(AIÍ∞Ä Ï§¨Í±∞ÎÇò Ïö∞Î¶¨Í∞Ä Ï∂îÏ∏°ÌñàÍ±∞ÎÇò),
                                // DBÏùò categoryÏôÄ ÏÑúÎ°ú ÏÉÅÏ∂©Îê† Îïå Ï†êÏàò ÎåÄÌè≠ ÏÇ≠Í∞ê
                                
                                const isRecDrama = rec.targetType.includes("drama") || rec.targetType.includes("series") || rec.targetType.includes("ÎìúÎùºÎßà");
                                const isMyDrama = myCategory.includes("ÎìúÎùºÎßà") || myCategory.includes("ÏãúÎ¶¨Ï¶à");
                                
                                const isRecMovie = rec.targetType.includes("movie") || rec.targetType.includes("film") || rec.targetType.includes("ÏòÅÌôî");
                                const isMyMovie = myCategory.includes("ÏòÅÌôî");
                    
                                // Case 1: AIÎäî ÎìúÎùºÎßàÎ•º ÏõêÌïòÎäîÎç∞ DBÎäî ÏòÅÌôîÏù∏ Í≤ΩÏö∞ (ÎÇòÏùò ÏïÑÏ†ÄÏî® Ìï¥Ïô∏ÏòÅÌôî ÏºÄÏù¥Ïä§)
                                if (isRecDrama && !isMyDrama) {
                                    currentScore -= 50; // Í∞ïÎ†•Ìïú ÌéòÎÑêÌã∞
                                }
                                // Case 2: AIÎäî ÏòÅÌôîÎ•º ÏõêÌïòÎäîÎç∞ DBÎäî ÎìúÎùºÎßàÏù∏ Í≤ΩÏö∞
                                else if (isRecMovie && !isMyMovie) {
                                    currentScore -= 50;
                                }
                                // Case 3: ÌÉÄÏûÖÏù¥ Ï†ïÌôïÌûà ÏùºÏπòÌïòÎäî Í≤ΩÏö∞ Í∞ÄÏÇ∞Ï†ê
                                else if ((isRecDrama && isMyDrama) || (isRecMovie && isMyMovie)) {
                                    currentScore += 20; 
                                }
                    
                                if (currentScore > score) {
                                    score = currentScore;
                                    aiReason = rec.reason;
                                }
                            }
                        }
                    
                        // Í≤ÄÏÉâÏñ¥ ÏßÅÏ†ë Ìè¨Ìï® Ïó¨Î∂Ä (Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ)
                        if (myTitle.includes(targetQuery.replace(/\s/g, ''))) {
                            score += 30; 
                        }
                    
                        // ÎÇ†Ïßú Í∏∞Î≥∏Í∞í Ï£ºÏûÖ Î∞è Î∞òÌôò
                        return { 
                            ...item, 
                            score, 
                            aiReason, 
                            prices: [item.price], 
                            minPrice: item.price,
                            startDate: defaultStart,
                            endDate: defaultEnd
                        };
                    })
                    .filter(item => item.score > 40) // Ïª§Ìä∏ÎùºÏù∏ÏùÑ Ï°∞Í∏à ÎÜíÏûÑ (Ïò§Îß§Ìïë Ï†úÍ±∞Î•º ÏúÑÌï¥)
                    .sort((a, b) => b.score - a.score);

                    const uniqueMap = new Map();
                    candidates.forEach(item => {
                        if (!uniqueMap.has(item.id)) uniqueMap.set(item.id, item);
                    });
                    
                    const finalCandidates = Array.from(uniqueMap.values()).slice(0, 50); 

                    setOriginalResults(finalCandidates);
                    applyFilters(finalCandidates);
                    setViewState("result");

                } catch (e) {
                    console.error(e);
                    showToast("Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                    setViewState("idle");
                } finally {
                    setIsSearching(false);
                }
            };

            const applyFilters = (sourceData = originalResults) => {
                let filtered = sourceData.filter(item => {
                    if (!includeRestricted && ['ÏÑ±Ïù∏', 'Í∏∞ÌÉÄ', 'adult', 'etc'].includes(item.category)) return false;
                    if (selectedGenres.length > 0 && !selectedGenres.includes(item.category)) return false;
                    if (priceType === 'free' && item.minPrice > 0) return false;
                    if (priceType === 'paid') {
                        if (item.minPrice === 0) return false; 
                        if (item.minPrice < minPrice) return false; 
                    }
                    return true;
                });
                setResults(filtered);
            };

            const handleApplyFilterUI = () => {
                setShowFilters(false);
                applyFilters();
            };

            // --- Ìé∏Ïßë Í∏∞Îä• (Selection, Date, DnD) ---

            const toggleSelection = (id) => {
                const newSet = new Set(selectedItems);
                if (newSet.has(id)) newSet.delete(id);
                else newSet.add(id);
                setSelectedItems(newSet);
            };

            const toggleAllSelection = () => {
                if (selectedItems.size === results.length) {
                    setSelectedItems(new Set());
                } else {
                    setSelectedItems(new Set(results.map(r => r.id)));
                }
            };

            const handleDateChange = (id, field, value) => {
                setResults(prev => prev.map(item => 
                    item.id === id ? { ...item, [field]: value } : item
                ));
            };

            const openBulkEditModal = () => {
                if (selectedItems.size === 0) {
                    showToast("ÏÑ†ÌÉùÎêú Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.");
                    return;
                }
                const { start, end } = getDefaultDates();
                setBulkStartDate(start);
                setBulkEndDate(end);
                setShowDateModal(true);
            };

            const applyBulkDateEdit = () => {
                setResults(prev => prev.map(item => {
                    if (selectedItems.has(item.id)) {
                        return {
                            ...item,
                            startDate: bulkStartDate || item.startDate,
                            endDate: bulkEndDate || item.endDate
                        };
                    }
                    return item;
                }));
                setShowDateModal(false);
                showToast(`${selectedItems.size}Í±¥ ÎÇ†Ïßú ÏàòÏ†ï ÏôÑÎ£å`);
            };

            const removeItem = (id) => {
                setResults(prev => prev.filter(item => item.id !== id));
                const newSet = new Set(selectedItems);
                newSet.delete(id);
                setSelectedItems(newSet);
            };

            // Drag and Drop Handlers
            const onDragStart = (e, index) => {
                dragItem.current = index;
                // e.target.classList.add('opacity-50');
            };

            const onDragEnter = (e, index) => {
                dragOverItem.current = index;
                // e.target.classList.add('drag-over');
            };

            const onDragEnd = (e) => {
                const _results = [...results];
                const dragItemContent = _results[dragItem.current];
                _results.splice(dragItem.current, 1);
                _results.splice(dragOverItem.current, 0, dragItemContent);
                dragItem.current = null;
                dragOverItem.current = null;
                setResults(_results);
                // remove drag-over classes logic if needed
            };

            const onDragOver = (e) => {
                e.preventDefault(); // Necessary for Drop to work
            };

            // --- ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Í∏∞Îä• ---

            const copyToClipboard = () => {
                const body = results.map(r => r.id).join('\n');
                const textArea = document.createElement("textarea");
                textArea.value = body;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                setCopied(true);
                showToast(`ID ${results.length}Í±¥ Î≥µÏÇ¨ ÏôÑÎ£å`);
                setTimeout(() => setCopied(false), 2000);
            };

            const downloadExcel = () => {
                // Format: YYYY-MM-DD HH:mm:ss
                const formatForCSV = (isoStr) => {
                    return isoStr.replace("T", " ") + ":00";
                };

                let csvContent = "ÏãúÎ¶¨Ï¶àID,Ìé∏ÏÑ±ÏãúÏûëÏùºÏãú,Ìé∏ÏÑ±Ï¢ÖÎ£åÏùºÏãú\n";
                
                results.forEach(r => {
                    const safeId = String(r.id).replace(/,/g, ""); 
                    const start = formatForCSV(r.startDate);
                    const end = formatForCSV(r.endDate);
                    csvContent += `${safeId},${start},${end}\n`;
                });

                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `Ìé∏ÏÑ±ÏóÖÎ°úÎìú_${new Date().toISOString().slice(0,10)}_${query}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- Render Helpers ---

            const getWeatherIcon = (weatherStr) => {
                if (!weatherStr) return <Sun size={12} />;
                const w = String(weatherStr).toLowerCase();
                if (w.includes('snow') || w.includes('Îàà') || w.includes('Ï∂îÏõÄ')) return <CloudSnow size={12} />;
                if (w.includes('rain') || w.includes('ÎπÑ')) return <CloudRain size={12} />;
                if (w.includes('cloud') || w.includes('ÌùêÎ¶º') || w.includes('Íµ¨Î¶Ñ') || w.includes('ÏïàÍ∞ú')) return <Cloud size={12} />;
                return <Sun size={12} />;
            };

            // ---------------- UI RENDER ----------------

            if (isLoadingData) {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center font-sans">
                        <div className="bg-white p-8 rounded-3xl shadow-xl flex flex-col items-center max-w-sm w-full border border-slate-100 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-purple-500 animate-pulse"></div>
                            <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
                                <Sparkles size={32} className="text-blue-600" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-800 mb-4 transition-all duration-500 min-h-[3rem] flex items-center justify-center break-keep">
                                {LOADING_MESSAGES[loadingMsgIndex]}
                            </h2>
                            <div className="flex items-center gap-2 text-xs font-bold text-gray-400 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-100">
                                <Database size={12} />
                                <span>Î°úÏª¨ Ï†ÄÏû•ÏÜå ÌôïÏù∏ Î∞è Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Ï§ë...</span>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans max-w-5xl mx-auto shadow-2xl overflow-hidden relative border-x border-gray-100 transition-all duration-300">
                    
                    {toastMessage && (
                        <div className="absolute top-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-5 py-3 rounded-full shadow-xl z-50 text-sm font-bold animate-fade-in flex items-center gap-2 whitespace-nowrap">
                            <CheckCircle2 size={18} className="text-green-400" />
                            {toastMessage}
                        </div>
                    )}

                    {/* Header */}
                    <header className="bg-white px-5 pt-6 pb-4 sticky top-0 z-20 border-b border-gray-100">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center gap-2" onClick={() => { setViewState("idle"); setQuery(""); }}>
                                <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white cursor-pointer shadow-blue-200 shadow-md">
                                    <Sparkles size={18} fill="currentColor" />
                                </div>
                                <h1 className="font-bold text-xl tracking-tight cursor-pointer">AI Curator</h1>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                {lastUpdated && (
                                    <span className="text-[10px] text-gray-400 hidden sm:inline-block">
                                        Update: {lastUpdated.toLocaleTimeString()}
                                    </span>
                                )}
                                <button onClick={clearCache} className="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 hover:bg-gray-200">
                                    Ï∫êÏãúÏ¥àÍ∏∞Ìôî
                                </button>
                                <div className="flex items-center gap-1.5 bg-green-50 px-3 py-1.5 rounded-full border border-green-100 shadow-sm">
                                    <div className="w-2 h-2 rounded-full bg-blue-500"></div>
                                    <span className="text-[11px] font-bold text-green-800 tracking-tight flex items-center gap-1.5">
                                        <FileSpreadsheet size={12} className="text-green-600"/>
                                        {dbData.length.toLocaleString()}Í±¥
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                            <div className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-xs font-bold whitespace-nowrap border border-blue-100">
                                {getWeatherIcon(context.weather)} {context.temp} {context.weather}
                            </div>
                            {context.trends && context.trends.map((tag, i) => (
                                <button 
                                    key={i} 
                                    onClick={() => handleSearch(tag.replace("#", ""))}
                                    className="px-3 py-1.5 bg-white text-gray-600 rounded-full text-xs font-medium whitespace-nowrap border border-gray-200 shadow-sm active:scale-95 transition-transform hover:bg-gray-50 flex items-center gap-1"
                                >
                                    <Hash size={10} className="text-gray-400"/>
                                    {tag.replace("#", "")}
                                </button>
                            ))}
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="p-5 pb-32 min-h-[80vh]">
                        
                        {/* VIEW: Idle */}
                        {viewState === "idle" && (
                            <div className="flex flex-col gap-6 mt-4 animate-fade-in max-w-3xl mx-auto">
                                <SearchBar 
                                    query={query} 
                                    setQuery={setQuery} 
                                    handleSearch={handleSearch} 
                                    setShowFilters={setShowFilters}
                                    hasFilters={hasActiveFilters}
                                />

                                <div className="space-y-4 mt-2">
                                    <div className="flex justify-between items-center px-1">
                                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider">Today's Season Pick</p>
                                        <span className="text-[10px] text-blue-500 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">
                                            {getSeasonalKeywords().season} Ï∂îÏ≤ú
                                        </span>
                                    </div>
                                    <div className="grid grid-cols-1 gap-3">
                                        {todaysPicks.map((sent, i) => (
                                            <button
                                                key={i}
                                                onClick={() => handleSearch(sent.replace(/[^a-zA-Z0-9Í∞Ä-Ìû£\s]/g, "").trim())}
                                                className={`p-4 rounded-xl text-left text-sm font-bold shadow-sm hover:shadow-md active:scale-95 transition-all w-full border flex items-center gap-3 bg-white border-gray-100 hover:border-blue-200 group`}
                                            >
                                                <div className="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-lg group-hover:bg-blue-100 transition-colors">
                                                     {getRandomEmoji(i)}
                                                </div>
                                                <span className="text-gray-700 group-hover:text-blue-700 transition-colors">{sent}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* VIEW: Thinking */}
                        {viewState === "thinking" && (
                            <div className="flex flex-col items-center justify-center h-64 mt-10 space-y-6 animate-pulse">
                                <div className="relative">
                                    <div className="absolute inset-0 bg-blue-500 blur-xl opacity-20 rounded-full animate-ping"></div>
                                    <div className="w-20 h-20 bg-white rounded-2xl shadow-lg border border-blue-100 flex items-center justify-center relative z-10">
                                        <Sparkles size={32} className="text-blue-600 animate-spin-slow" />
                                    </div>
                                </div>
                                <div className="text-center space-y-1">
                                    <h3 className="text-lg font-bold text-gray-800">
                                        ÌÅêÎ†àÏù¥ÏÖò ÏÉùÏÑ± Ï§ë...
                                    </h3>
                                    <p className="text-sm text-gray-500">
                                        Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú ÏµúÏ†ÅÏùò ÏΩòÌÖêÏ∏†Î•º<br/>
                                        Îß§Ïπ≠ÌïòÍ≥† ÏûàÏäµÎãàÎã§.
                                    </p>
                                </div>
                            </div>
                        )}

                        {/* VIEW: Result */}
                        {viewState === "result" && (
                            <div className="space-y-6 animate-slide-up" ref={resultRef}>
                                <div className="mb-6">
                                    <SearchBar 
                                        query={query} 
                                        setQuery={setQuery} 
                                        handleSearch={handleSearch} 
                                        setShowFilters={setShowFilters}
                                        compact={true} 
                                        hasFilters={hasActiveFilters}
                                    />
                                    {(hasActiveFilters) && (
                                        <div className="mt-2 text-[10px] text-blue-600 font-bold flex gap-2 overflow-hidden whitespace-nowrap px-1">
                                            <Filter size={10} className="mt-0.5"/>
                                            <span>ÌïÑÌÑ∞ Ï†ÅÏö© Ï§ë</span>
                                        </div>
                                    )}
                                </div>

                                <div className="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                                    <Edit3 className="absolute top-5 right-5 text-white opacity-50" size={20} />
                                    <div className="relative z-10">
                                        <div className="flex items-center gap-2 mb-3 text-purple-200 text-xs font-bold uppercase tracking-wider">
                                            <Sparkles size={12} /> AI Curation Block
                                        </div>
                                        <h3 className="text-2xl font-bold leading-snug pr-8 tracking-tight">
                                            {blockTitle}
                                        </h3>
                                        <p className="text-xs text-purple-200 mt-3 opacity-80 flex items-center gap-1">
                                            <Download size={10} /> Îã§Ïö¥Î°úÎìú Ïãú ÏÑ§Ï†ïÎêú Ìé∏ÏÑ± ÏùºÏãúÍ∞Ä Î∞òÏòÅÎê©ÎãàÎã§.
                                        </p>
                                    </div>
                                </div>

                                {/* Controls Row */}
                                <div className="flex items-center justify-between px-1">
                                    <div className="flex items-center gap-2">
                                        <button onClick={toggleAllSelection} className="flex items-center gap-1 text-xs font-bold text-gray-500 bg-white border border-gray-200 px-2 py-1.5 rounded hover:bg-gray-50">
                                            {selectedItems.size === results.length && results.length > 0 ? <CheckSquare size={14} className="text-blue-500"/> : <Square size={14}/>}
                                            Ï†ÑÏ≤¥ ÏÑ†ÌÉù
                                        </button>
                                        <button onClick={openBulkEditModal} className="flex items-center gap-1 text-xs font-bold text-blue-600 bg-blue-50 border border-blue-100 px-2 py-1.5 rounded hover:bg-blue-100 disabled:opacity-50" disabled={selectedItems.size === 0}>
                                            <CalendarClock size={14}/>
                                            ÏùºÍ¥Ñ ÏùºÏãú ÏàòÏ†ï
                                        </button>
                                    </div>
                                    <span className="text-[10px] text-gray-400">ÎìúÎûòÍ∑∏ÌïòÏó¨ ÏàúÏÑú Î≥ÄÍ≤Ω</span>
                                </div>

                                <div className="space-y-3">
                                    {results.length > 0 ? results.map((item, idx) => (
                                        <div 
                                            key={item.id} 
                                            className={`bg-white p-4 rounded-xl border shadow-sm flex flex-col gap-3 group transition-colors draggable-item ${selectedItems.has(item.id) ? 'border-blue-400 ring-1 ring-blue-400 bg-blue-50/10' : 'border-gray-100 hover:border-blue-200'}`}
                                            draggable
                                            onDragStart={(e) => onDragStart(e, idx)}
                                            onDragEnter={(e) => onDragEnter(e, idx)}
                                            onDragEnd={onDragEnd}
                                            onDragOver={onDragOver}
                                        >
                                            <div className="flex items-start gap-3">
                                                {/* Drag Handle & Checkbox */}
                                                <div className="flex flex-col items-center gap-2 pt-1">
                                                    <div className="cursor-grab text-gray-300 hover:text-gray-500 active:cursor-grabbing">
                                                        <GripVertical size={18} />
                                                    </div>
                                                    <button onClick={() => toggleSelection(item.id)} className="text-gray-400 hover:text-blue-500">
                                                        {selectedItems.has(item.id) ? <CheckSquare size={18} className="text-blue-500"/> : <Square size={18}/>}
                                                    </button>
                                                </div>

                                                <div className="flex-1 min-w-0">
                                                    <div className="flex justify-between items-start mb-1">
                                                        <h5 className="font-bold text-gray-900 text-base truncate pr-2">
                                                            {item.title}
                                                        </h5>
                                                        <span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-mono shrink-0">
                                                            {item.id}
                                                        </span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-xs text-gray-500 mb-2">
                                                        {/* Í∏∞Ï°¥ ÏΩîÎìúÏùò Ïπ¥ÌÖåÍ≥†Î¶¨ Î±ÉÏßÄ Î∂ÄÎ∂Ñ ÏàòÏ†ï */}
                                                        <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold border ${getTagStyle(item.subCategory)}`}>
                                                            {/* Ïπ¥ÌÖåÍ≥†Î¶¨ ÏïûÏóê ÏïÑÏù¥ÏΩò Ï∂îÍ∞ÄÎ°ú ÏãúÏù∏ÏÑ± ÌôïÎ≥¥ */}
                                                            {item.subCategory.includes('ÏòÅÌôî') ? 'üé¨ ' : item.subCategory.includes('ÎìúÎùºÎßà') ? 'üì∫ ' : ''}
                                                            {item.subCategory}
                                                        </span>
                                                        {item.aiReason && (
                                                            <span className="truncate text-blue-500 max-w-[200px]">
                                                                üí° {item.aiReason}
                                                            </span>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Date Inputs */}
                                                    <div className="flex flex-wrap items-center gap-2 text-xs bg-gray-50 p-2 rounded-lg">
                                                        <div className="flex items-center gap-1">
                                                            <span className="text-gray-400 font-bold">ÏãúÏûë</span>
                                                            <input 
                                                                type="datetime-local" 
                                                                value={item.startDate}
                                                                onChange={(e) => handleDateChange(item.id, 'startDate', e.target.value)}
                                                                className="bg-white border border-gray-200 rounded px-1 py-0.5 focus:outline-none focus:border-blue-500 w-36 text-gray-600 font-mono"
                                                            />
                                                        </div>
                                                        <div className="flex items-center gap-1">
                                                            <span className="text-gray-400 font-bold">Ï¢ÖÎ£å</span>
                                                            <input 
                                                                type="datetime-local" 
                                                                value={item.endDate}
                                                                onChange={(e) => handleDateChange(item.id, 'endDate', e.target.value)}
                                                                className="bg-white border border-gray-200 rounded px-1 py-0.5 focus:outline-none focus:border-blue-500 w-36 text-gray-600 font-mono"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>

                                                <button 
                                                    onClick={() => removeItem(item.id)}
                                                    className="p-1.5 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors self-start"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            </div>
                                        </div>
                                    )) : (
                                        <div className="text-center py-16 text-gray-400 bg-white rounded-xl border border-dashed border-gray-200">
                                            <AlertTriangle size={24} className="mx-auto mb-2 text-gray-300" />
                                            <p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                                        </div>
                                    )}
                                </div>
                                <div className="h-24"></div>
                            </div>
                        )}
                    </main>

                    {/* Floating Action Bar */}
                    {viewState === "result" && (
                        <div className="absolute bottom-6 left-5 right-5 z-30 flex justify-center pointer-events-none">
                            <div className="flex gap-3 w-full max-w-2xl pointer-events-auto animate-slide-up bg-white/90 backdrop-blur-md p-2 rounded-2xl border border-white/50 shadow-2xl">
                                <button 
                                    onClick={() => { setViewState("idle"); setQuery(""); }}
                                    className="w-14 h-14 bg-white border border-gray-200 rounded-xl shadow-sm flex items-center justify-center text-gray-500 hover:bg-gray-50 active:scale-95 transition-all"
                                    title="Ï¥àÍ∏∞Ìôî"
                                >
                                    <RotateCcw size={22} />
                                </button>

                                <button 
                                    onClick={downloadExcel}
                                    className="w-14 h-14 bg-white border border-gray-200 rounded-xl shadow-sm flex items-center justify-center text-green-600 hover:bg-green-50 active:scale-95 transition-all"
                                    title="Ìé∏ÏÑ± ÏóÖÎ°úÎìú CSV Îã§Ïö¥Î°úÎìú"
                                >
                                    <Download size={22} />
                                </button>
                                
                                <button 
                                    onClick={copyToClipboard}
                                    className={`flex-1 h-14 rounded-xl shadow-sm font-bold text-lg flex items-center justify-center gap-2 transition-all active:scale-95 ${copied ? 'bg-indigo-600 text-white' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                                >
                                    {copied ? (
                                        <>
                                            <CheckCircle2 size={22} />
                                            ID Î≥µÏÇ¨ ÏôÑÎ£å
                                        </>
                                    ) : (
                                        <>
                                            <Copy size={22} />
                                            ID Î¶¨Ïä§Ìä∏ Î≥µÏÇ¨
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Bulk Edit Modal */}
                    {showDateModal && (
                        <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center animate-fade-in p-4" onClick={(e) => e.target === e.currentTarget && setShowDateModal(false)}>
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 space-y-4 animate-slide-up shadow-2xl">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-lg font-bold">ÏùºÍ¥Ñ ÏùºÏãú ÏàòÏ†ï ({selectedItems.size}Í±¥)</h3>
                                    <button onClick={() => setShowDateModal(false)}><X size={20} className="text-gray-400"/></button>
                                </div>
                                <div className="space-y-3">
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 block mb-1">ÏãúÏûë ÏùºÏãú</label>
                                        <input 
                                            type="datetime-local" 
                                            value={bulkStartDate}
                                            onChange={(e) => setBulkStartDate(e.target.value)}
                                            className="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 block mb-1">Ï¢ÖÎ£å ÏùºÏãú</label>
                                        <input 
                                            type="datetime-local" 
                                            value={bulkEndDate}
                                            onChange={(e) => setBulkEndDate(e.target.value)}
                                            className="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                        />
                                    </div>
                                </div>
                                <button onClick={applyBulkDateEdit} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">Ï†ÅÏö©ÌïòÍ∏∞</button>
                            </div>
                        </div>
                    )}

                    {/* Filters Modal */}
                    {showFilters && (
                        <div className="fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center sm:justify-center animate-fade-in" onClick={(e) => e.target === e.currentTarget && setShowFilters(false)}>
                            <div className="bg-white w-full sm:w-[400px] sm:rounded-3xl rounded-t-3xl p-6 pb-10 space-y-6 animate-slide-up shadow-2xl">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-xl font-bold">ÏÉÅÏÑ∏ ÌïÑÌÑ∞</h3>
                                    <button onClick={() => setShowFilters(false)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
                                        <X size={20} />
                                    </button>
                                </div>
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between bg-red-50 p-3 rounded-xl border border-red-100">
                                        <span className="text-sm font-bold text-red-600">ÏÑ±Ïù∏/Í∏∞ÌÉÄ Ïπ¥ÌÖåÍ≥†Î¶¨ Ìè¨Ìï®</span>
                                        <button 
                                            onClick={() => setIncludeRestricted(!includeRestricted)}
                                            className={`w-12 h-7 rounded-full transition-colors relative ${includeRestricted ? 'bg-red-500' : 'bg-gray-300'}`}
                                        >
                                            <div className={`absolute top-1 left-1 w-5 h-5 bg-white rounded-full shadow transition-transform ${includeRestricted ? 'translate-x-5' : ''}`}></div>
                                        </button>
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-bold text-gray-500">Ïû•Î•¥</label>
                                        <div className="flex flex-wrap gap-2">
                                            {allGenres.map(g => (
                                                <button 
                                                    key={g}
                                                    onClick={() => setSelectedGenres(prev => prev.includes(g) ? prev.filter(x => x !== g) : [...prev, g])}
                                                    className={`px-3 py-1.5 rounded-full text-sm font-medium border transition-all ${selectedGenres.includes(g) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200'}`}
                                                >
                                                    {g}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="space-y-2 pt-2 border-t border-gray-100">
                                        <label className="text-sm font-bold text-gray-500 flex items-center gap-1">
                                            <DollarSign size={14} /> Í∞ÄÍ≤©
                                        </label>
                                        <div className="flex gap-2">
                                            {[{l:'Ï†ÑÏ≤¥', v:'all'}, {l:'Î¨¥Î£å', v:'free'}, {l:'Ïú†Î£å', v:'paid'}].map(opt => (
                                                <button
                                                    key={opt.v}
                                                    onClick={() => setPriceType(opt.v)}
                                                    className={`flex-1 py-3 rounded-xl text-sm font-bold border transition-all ${priceType === opt.v ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200'}`}
                                                >
                                                    {opt.l}
                                                </button>
                                            ))}
                                        </div>
                                        
                                        {/* Price Range Slider (Restored) */}
                                        {priceType === 'paid' && (
                                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 animate-fade-in mt-3">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-xs font-bold text-gray-500">ÏµúÏÜå Í∞ÄÍ≤© ÏÑ§Ï†ï</span>
                                                    <span className="text-sm font-bold text-blue-600">{minPrice.toLocaleString()}Ïõê Ïù¥ÏÉÅ</span>
                                                </div>
                                                <input 
                                                    type="range" 
                                                    min="0" 
                                                    max="20000" 
                                                    step="500" 
                                                    value={minPrice} 
                                                    onChange={(e) => setMinPrice(Number(e.target.value))}
                                                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                                />
                                                <div className="flex justify-between text-[10px] text-gray-400 mt-1 px-1">
                                                    <span>0Ïõê</span>
                                                    <span>10,000Ïõê</span>
                                                    <span>20,000Ïõê+</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <button 
                                    onClick={handleApplyFilterUI}
                                    className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold text-lg hover:bg-slate-800 transition-colors mt-2"
                                >
                                    ÌïÑÌÑ∞ Ï†ÅÏö©ÌïòÍ∏∞
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
