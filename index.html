<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Curator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
        .animate-ping { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; }
        
        /* Îã¨Î†• ÏïÑÏù¥ÏΩò Ïª§Ïä§ÌÖÄ */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { cursor: pointer; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Lucide Icon Helper ---
        const Icon = ({ name, size = 24, className, color = "currentColor", ...props }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                    {iconData.map((child, index) => {
                        const [tag, attrs] = child;
                        return React.createElement(tag, { ...attrs, key: index });
                    })}
                </svg>
            );
        };

        const Icons = {
            Sparkles: (p) => <Icon name="Sparkles" {...p} />,
            Search: (p) => <Icon name="Search" {...p} />,
            CloudSnow: (p) => <Icon name="CloudSnow" {...p} />,
            CloudRain: (p) => <Icon name="CloudRain" {...p} />,
            Cloud: (p) => <Icon name="Cloud" {...p} />,
            Sun: (p) => <Icon name="Sun" {...p} />,
            Zap: (p) => <Icon name="Zap" {...p} />,
            CheckCircle2: (p) => <Icon name="CheckCircle2" {...p} />,
            ArrowRight: (p) => <Icon name="ArrowRight" {...p} />,
            Copy: (p) => <Icon name="Copy" {...p} />,
            RotateCcw: (p) => <Icon name="RotateCcw" {...p} />,
            Filter: (p) => <Icon name="Filter" {...p} />,
            X: (p) => <Icon name="X" {...p} />,
            FileSpreadsheet: (p) => <Icon name="FileSpreadsheet" {...p} />,
            Hash: (p) => <Icon name="Hash" {...p} />,
            DollarSign: (p) => <Icon name="DollarSign" {...p} />,
            AlertTriangle: (p) => <Icon name="AlertTriangle" {...p} />,
            Download: (p) => <Icon name="Download" {...p} />,
            Edit3: (p) => <Icon name="Edit3" {...p} />,
            Server: (p) => <Icon name="Server" {...p} />,
            Calendar: (p) => <Icon name="Calendar" {...p} />,
            CheckSquare: (p) => <Icon name="CheckSquare" {...p} />,
            Square: (p) => <Icon name="Square" {...p} />,
            Trash2: (p) => <Icon name="Trash2" {...p} />
        };

        // --- CONFIG ---
        const GAS_API_URL = "https://jolly-sun-635f.alcheminos.workers.dev/"; 
        const CACHE_KEY = "ai_curator_full_data_v1"; 

        // --- HELPER FUNCTIONS ---
        const calculateSimilarity = (s1, s2) => {
            const clean1 = String(s1).replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, "").toLowerCase();
            const clean2 = String(s2).replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, "").toLowerCase();
            if (clean1 === clean2) return 1.0; 
            if (clean1.includes(clean2) || clean2.includes(clean1)) return 0.8; 
            return 0.0; 
        };

        // ÎÇ†Ïßú Ìó¨Ìçº: Ïò§Îäò 00:00
        const getTodayStart = () => {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}T00:00`;
        };
        // ÎÇ†Ïßú Ìó¨Ìçº: 9999-12-31 23:59
        const getDefaultEnd = () => "9999-12-31T23:59";
        
        // ÏóëÏÖÄÏö© Ìè¨Îß∑ Î≥ÄÌôò
        const formatForExcel = (isoStr) => isoStr.replace('T', ' ');

        const fetchRealWeather = async () => {
            try {
                const res = await fetch('https://wttr.in/?format=j1');
                const data = await res.json();
                const current = data.current_condition[0];
                const desc = current.weatherDesc[0].value.toLowerCase();
                let simplifiedDesc = "ÎßëÏùå";
                if (desc.includes('rain') || desc.includes('drizzle')) simplifiedDesc = "ÎπÑ";
                else if (desc.includes('snow') || desc.includes('ice')) simplifiedDesc = "Îàà";
                else if (desc.includes('cloud') || desc.includes('overcast')) simplifiedDesc = "ÌùêÎ¶º";
                return { temp: `${current.temp_C}¬∞C`, weather: simplifiedDesc, rawDesc: desc };
            } catch (e) {
                const month = new Date().getMonth() + 1;
                let season = "ÎßëÏùå";
                if (month >= 12 || month <= 2) season = "Ï∂îÏõÄ";
                return { temp: "Seasonal", weather: season, isFallback: true };
            }
        };

        const getRandomColorClass = (idx) => {
            const colors = [
                'bg-red-50 border-red-100 text-red-600', 'bg-orange-50 border-orange-100 text-orange-600',
                'bg-amber-50 border-amber-100 text-amber-600', 'bg-green-50 border-green-100 text-green-600',
                'bg-teal-50 border-teal-100 text-teal-600', 'bg-blue-50 border-blue-100 text-blue-600',
                'bg-indigo-50 border-indigo-100 text-indigo-600', 'bg-purple-50 border-purple-100 text-purple-600',
                'bg-pink-50 border-pink-100 text-pink-600'
            ];
            return colors[idx % colors.length];
        };

        const getRandomEmoji = (idx) => {
            const emojis = ['üé¨', 'üçø', 'üì∫', 'üåü', 'üëÄ', '‚ú®', 'üíø', 'üìº', 'üìΩÔ∏è'];
            return emojis[idx % emojis.length];
        };

        const LOADING_MESSAGES = [
            "üçø ÌåùÏΩò ÌäÄÍ∏∞Îäî Ï§ë...", "üé¨ Í∞êÎèÖÎãò ÏÑ≠Ïô∏ÌïòÎü¨ Í∞ÄÎäî Ï§ë...", "‚ö°Ô∏è ÎÑ∑ÌîåÎ¶≠Ïä§Î≥¥Îã§ Îπ†Î•¥Í≤å...Îäî ÎÖ∏Î†• Ï§ëÏûÖÎãàÎã§",
            "‚õèÔ∏è Ïà®Í≤®ÏßÑ Î™ÖÏûë Îç∞Ïù¥ÌÑ∞Î•º Î∞úÍµ¥ÌïòÍ≥† ÏûàÏñ¥Ïöî", "üìù Ïù¥Î≤à Ï£ºÎßê Ï±ÖÏûÑÏßà Î¶¨Ïä§Ìä∏ ÏûëÏÑ± Ï§ë",
            "ü§ñ AIÍ∞Ä ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎèÖÌïòÎäî Ï§ë...", "üèÉ‚Äç‚ôÇÔ∏è Î∞∞Ïö∞Îì§ Ïä§ÏºÄÏ§Ñ ÌôïÏù∏ÌïòÎü¨ Îõ∞Ïñ¥Í∞ÄÎäî Ï§ë",
            "üç™ Ïø†ÌÇ§ ÏòÅÏÉÅ Ï∞æÎäêÎùº Ï¢Ä Îä¶ÎÑ§Ïöî...", "‚ùÑÔ∏è 'Ïò§Í≤°ÎÅºÎç∞Ïä§Íπå' Ïô∏ÏπòÎäî Ï§ë...",
            "üîã ÎãπÏã†Ïùò ÎèÑÌååÎØºÏùÑ Ï∂©Ï†ÑÌïòÎäî Ï§ë...", "üì° Ïò§ÏïÑÏãúÏä§ ÏÑúÎ≤ÑÏôÄ ÍµêÏã† ÏãúÎèÑ Ï§ë..."
        ];

        const getTagStyle = (text) => {
            const t = String(text).replace('#', '').trim();
            if (t === 'ÌïúÍµ≠ÏòÅÌôî') return 'bg-indigo-50 text-indigo-600 border-indigo-100';
            if (t === 'CJ ENM') return 'bg-orange-50 text-orange-600 border-orange-100';
            if (t === 'ÏòÅÌôî') return 'bg-slate-100 text-slate-600 border-slate-200';
            if (t === 'ÎìúÎùºÎßà') return 'bg-rose-50 text-rose-600 border-rose-100';
            if (t === 'ÏòàÎä•') return 'bg-yellow-50 text-yellow-600 border-yellow-100';
            return 'bg-blue-50 text-blue-600 border-blue-100';
        };

        const SearchBar = ({ query, setQuery, handleSearch, setShowFilters, compact = false, hasFilters = false }) => (
            <div className={`relative group z-10 transition-all ${compact ? 'shadow-none' : 'shadow-sm'}`}>
                <input type="text" value={query} onChange={(e) => setQuery(e.target.value)} onKeyDown={(e) => e.key === "Enter" && handleSearch()}
                    placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                    className={`w-full bg-white border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all placeholder:text-gray-300 ${compact ? 'py-3 pl-4 pr-20 text-base rounded-xl' : 'p-5 pr-24 text-lg rounded-2xl'}`} />
                <div className={`absolute right-2 flex gap-1 ${compact ? 'top-2' : 'top-3'}`}>
                    <button onClick={() => setShowFilters(true)} className={`rounded-lg transition-all flex items-center justify-center ${compact ? 'p-1.5 w-8 h-8' : 'p-2.5'} ${hasFilters ? 'bg-blue-100 text-blue-600' : 'bg-gray-50 text-gray-400 hover:bg-gray-100'}`}>
                        <Icons.Filter size={compact ? 16 : 20} />
                    </button>
                    <button onClick={() => handleSearch()} className={`rounded-lg transition-all flex items-center justify-center ${compact ? 'p-1.5 w-8 h-8' : 'p-2.5'} ${query ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-300'}`}>
                        <Icons.ArrowRight size={compact ? 16 : 20} />
                    </button>
                </div>
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [query, setQuery] = useState("");
            const [viewState, setViewState] = useState("idle");
            const [dbData, setDbData] = useState([]); 
            const [results, setResults] = useState([]);
            
            // Ìé∏ÏÑ± Í¥ÄÎ¶¨Ïö© State
            const [selectedIds, setSelectedIds] = useState([]);
            
            const [strategy, setStrategy] = useState("");
            const [blockTitle, setBlockTitle] = useState("");
            const [copied, setCopied] = useState(false);
            const [showFilters, setShowFilters] = useState(false);
            const [todaysPicks, setTodaysPicks] = useState([]);
            const [context, setContext] = useState({ weather: "", temp: "", trends: [] });
            const [isLoadingData, setIsLoadingData] = useState(true);
            const [loadingMsgIndex, setLoadingMsgIndex] = useState(0);
            const [toastMessage, setToastMessage] = useState("");
            const [sheetName, setSheetName] = useState("Ïó∞Í≤∞ ÎåÄÍ∏∞Ï§ë...");

            // Filters
            const [selectedGenres, setSelectedGenres] = useState([]);
            const [priceType, setPriceType] = useState("all");
            const [minPrice, setMinPrice] = useState(0);
            const [includeRestricted, setIncludeRestricted] = useState(false);

            const resultRef = useRef(null);
            const hasActiveFilters = selectedGenres.length > 0 || priceType !== 'all' || includeRestricted;
            const allGenres = dbData.length > 0 ? Array.from(new Set(dbData.map(item => item.category).filter(Boolean))) : [];

            // --- Effects ---
            useEffect(() => {
                if (isLoadingData) {
                    const interval = setInterval(() => {
                        setLoadingMsgIndex((prev) => (prev + 1) % LOADING_MESSAGES.length);
                    }, 1500);
                    return () => clearInterval(interval);
                }
            }, [isLoadingData]);

            // Ï¥àÍ∏∞Ìôî: ÎÇ†Ïî® + Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Ï∫êÏãú Ï†ÅÏö©)
            useEffect(() => {
                const initApp = async () => {
                    setIsLoadingData(true);
                    
                    // 1. ÎÇ†Ïî® & Ìä∏Î†åÎìú
                    const weatherData = await fetchRealWeather();
                    const month = new Date().getMonth() + 1;
                    const seasonalTrends = 
                        month === 12 ? ["#ÌÅ¨Î¶¨Ïä§ÎßàÏä§", "#Ïó∞ÎßêÍ≤∞ÏÇ∞", "#Î°úÎß®Ïä§", "#ÌôàÌååÌã∞"] :
                        month === 1 ? ["#ÏÉàÌï¥", "#Í∞ÄÏ°±", "#Ìï¥ÎèãÏù¥", "#Î∞©Ìïô"] :
                        (month === 7 || month === 8) ? ["#Í≥µÌè¨", "#Ïó¨Î¶ÑÌú¥Í∞Ä", "#ÎÇ©ÎüâÌäπÏßë"] : ["#Ï£ºÎßê", "#ÌûêÎßÅ", "#Î™∞ÏïÑÎ≥¥Í∏∞"];
                    
                    setContext({ weather: weatherData.weather, temp: weatherData.temp, trends: seasonalTrends });
                    setTodaysPicks(seasonalTrends.map(t => t.replace('#', '') + " Ï∂îÏ≤ú"));

                    // 2. Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Ï∫êÏãú -> API -> Mock ÏàúÏÑú)
                    try {
                        const cached = localStorage.getItem(CACHE_KEY);
                        if (cached) {
                            const { timestamp, data, sheet } = JSON.parse(cached);
                            // 24ÏãúÍ∞Ñ Ïú†Ìö®
                            if (Date.now() - timestamp < 24 * 60 * 60 * 1000) {
                                setDbData(data);
                                setSheetName(sheet || "Cached Data");
                                setIsLoadingData(false);
                                showToast("‚ö°Ô∏è Ï∫êÏãúÎêú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§.");
                                return;
                            }
                        }

                        // API Fetch
                        const res = await fetch(GAS_API_URL);
                        const json = await res.json();
                        
                        if (json.status === 'success') {
                            setDbData(json.data);
                            setSheetName(json.sheetName || "Live Data");
                            localStorage.setItem(CACHE_KEY, JSON.stringify({ 
                                timestamp: Date.now(), 
                                data: json.data, 
                                sheet: json.sheetName 
                            }));
                        } else {
                            throw new Error("API Status Error");
                        }
                    } catch (e) {
                        console.warn("Îç∞Ïù¥ÌÑ∞ Ïó∞Í≤∞ Ïã§Ìå®, Î°úÏª¨ ÏÉòÌîå ÏÇ¨Ïö©", e);
                        setSheetName("Ïò§ÌîÑÎùºÏù∏ ÏÉòÌîåÎ™®Îìú");
                        setDbData([
                            { id: "CS11197562", title: "ÌÜµÏû†", category: "ÏòÅÌôî", subCategory: "ÌïúÍµ≠ÏòÅÌôî", price: 10000 },
                            { id: "CS001", title: "Í≤®Ïö∏ÏôïÍµ≠", category: "ÏòÅÌôî", subCategory: "Ïï†ÎãàÎ©îÏù¥ÏÖò", price: 5500 },
                            { id: "CS002", title: "Ïñ¥Î∞îÏõÉ ÌÉÄÏûÑ", category: "ÏòÅÌôî", subCategory: "Î°úÎß®Ïä§", price: 1500 },
                            { id: "CS003", title: "Îü¨Î∏å Ïï°Ï∏ÑÏñºÎ¶¨", category: "ÏòÅÌôî", subCategory: "Î°úÎß®Ïä§", price: 1200 },
                            { id: "CS004", title: "ÎÇò ÌôÄÎ°ú ÏßëÏóê", category: "ÏòÅÌôî", subCategory: "Í∞ÄÏ°±", price: 1000 },
                            { id: "CS005", title: "ÎπÑÎ∞ÄÏùò Ïà≤", category: "ÎìúÎùºÎßà", subCategory: "ÌïúÍµ≠ÎìúÎùºÎßà", price: 0 }
                        ]);
                        showToast("‚ö†Ô∏è ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®. ÏÉòÌîå Îç∞Ïù¥ÌÑ∞Î°ú Ïã§ÌñâÌï©ÎãàÎã§.");
                    } finally {
                        setIsLoadingData(false);
                    }
                };
                initApp();
            }, []);

            const showToast = (msg) => {
                setToastMessage(msg);
                setTimeout(() => setToastMessage(""), 3000);
            };

            // --- Logic ---
            const handleSearch = async (inputQuery) => {
                const targetQuery = inputQuery || query;
                if (!targetQuery) return;

                setQuery(targetQuery);
                setViewState("thinking");
                setResults([]);
                setSelectedIds([]); // Í≤ÄÏÉâ Ïãú ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî

                setTimeout(() => {
                    const cleanQ = targetQuery.replace(/\s/g, '').toLowerCase();
                    
                    let filtered = dbData.map(item => {
                        let score = 0;
                        const t = (item.title || "").replace(/\s/g, '').toLowerCase();
                        if (t.includes(cleanQ)) score += 50;
                        if ((item.subCategory || "").includes(targetQuery)) score += 30;
                        return { ...item, score, prices: [item.price], minPrice: item.price };
                    }).filter(item => item.score > 0);

                    // Filters
                    filtered = filtered.filter(item => {
                        if (!includeRestricted && ['ÏÑ±Ïù∏', 'Í∏∞ÌÉÄ', 'adult'].includes(item.category)) return false;
                        if (selectedGenres.length > 0 && !selectedGenres.includes(item.category)) return false;
                        if (priceType === 'free' && item.minPrice > 0) return false;
                        if (priceType === 'paid' && (item.minPrice === 0 || item.minPrice < minPrice)) return false;
                        return true;
                    });

                    filtered.sort((a, b) => b.score - a.score);

                    // ÎÇ†Ïßú Ï¥àÍ∏∞Ìôî (ÏöîÏ≤≠ÏÇ¨Ìï≠ Î∞òÏòÅ)
                    const initialized = filtered.slice(0, 50).map(item => ({
                        ...item,
                        startDate: getTodayStart(),
                        endDate: getDefaultEnd()
                    }));

                    setStrategy(`ÌÇ§ÏõåÎìú '${targetQuery}' Îß§Ïπ≠ Î∞è ÌïÑÌÑ∞ÎßÅ`);
                    setBlockTitle(`"${targetQuery}" Ìé∏ÏÑ± Ï†úÏïà`);
                    setResults(initialized);
                    setViewState("result");
                }, 1000); // Î°úÎî© Î¨∏Íµ¨ Ï¢Ä Îçî Ï¶êÍ∏∞ÎèÑÎ°ù 1Ï¥à
            };

            const toggleSelect = (id) => {
                setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
            };

            const toggleSelectAll = () => {
                if (selectedIds.length === results.length) setSelectedIds([]);
                else setSelectedIds(results.map(r => r.id));
            };

            const updateDate = (id, field, val) => {
                setResults(prev => prev.map(r => r.id === id ? { ...r, [field]: val } : r));
            };

            const bulkUpdateDate = (field, val) => {
                setResults(prev => prev.map(r => selectedIds.includes(r.id) ? { ...r, [field]: val } : r));
                showToast(`${selectedIds.length}Í±¥ ÎÇ†Ïßú ÏùºÍ¥Ñ Î≥ÄÍ≤Ω ÏôÑÎ£å`);
            };

            const removeSelected = () => {
                setResults(prev => prev.filter(r => !selectedIds.includes(r.id)));
                setSelectedIds([]);
            };

            const downloadExcel = () => {
                const header = `"ÏΩòÌÖêÏ∏†ID\n(ÏãúÎ¶¨Ï¶à/ÏóêÌîºÏÜåÎìú)","Î©îÎâ¥Ìé∏ÏÑ±ÏãúÏûëÏùºÏãú\n(YYYY-MM-DD HH:MM)","Î©îÎâ¥Ìé∏ÏÑ±Ï¢ÖÎ£åÏùºÏãú\n(YYYY-MM-DD HH:MM)"\n`;
                const rows = results.map(r => `${r.id},${formatForExcel(r.startDate)},${formatForExcel(r.endDate)}`).join('\n');
                const blob = new Blob(['\uFEFF' + header + rows], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Ìé∏ÏÑ±Î¶¨Ïä§Ìä∏_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            const copyIds = () => {
                const text = results.map(r => r.id).join('\n');
                const t = document.createElement("textarea");
                t.value = text;
                document.body.appendChild(t);
                t.select();
                document.execCommand('copy');
                document.body.removeChild(t);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const resetApp = () => { setViewState("idle"); setQuery(""); setResults([]); };

            // --- RENDER ---
            if (isLoadingData) {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center">
                        <div className="bg-white p-8 rounded-3xl shadow-xl flex flex-col items-center max-w-sm w-full border border-slate-100 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-purple-500 animate-pulse"></div>
                            <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
                                <Icons.Sparkles size={32} className="text-blue-600" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-800 mb-4 h-14 flex items-center justify-center">{LOADING_MESSAGES[loadingMsgIndex]}</h2>
                            <div className="flex items-center gap-2 text-xs font-bold text-gray-400 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-100">
                                <Icons.Server size={12} /> <span>Îç∞Ïù¥ÌÑ∞ ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏãúÎèÑ Ï§ë...</span>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans max-w-5xl mx-auto shadow-2xl overflow-hidden relative border-x border-gray-100 pb-32">
                    {toastMessage && (
                        <div className="absolute top-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-5 py-3 rounded-full shadow-xl z-50 text-sm font-bold animate-fade-in flex items-center gap-2 whitespace-nowrap">
                            <Icons.CheckCircle2 size={18} className="text-green-400" /> {toastMessage}
                        </div>
                    )}

                    {/* Header */}
                    <header className="bg-white px-5 pt-6 pb-4 sticky top-0 z-20 border-b border-gray-100">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={resetApp}>
                                <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-blue-200 shadow-md">
                                    <Icons.Sparkles size={18} />
                                </div>
                                <h1 className="font-bold text-xl tracking-tight">AI Curator</h1>
                            </div>
                            <div className="flex items-center gap-1.5 bg-green-50 px-3 py-1.5 rounded-full border border-green-100 shadow-sm">
                                <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                <span className="text-[11px] font-bold text-green-800 flex items-center gap-1">
                                    <Icons.FileSpreadsheet size={12} /> {sheetName}
                                </span>
                            </div>
                        </div>
                        <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                            <div className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-xs font-bold whitespace-nowrap border border-blue-100">
                                <Icons.Sun size={12} /> {context.temp} {context.weather}
                            </div>
                            {context.trends.map((tag, i) => (
                                <button key={i} onClick={() => handleSearch(tag.replace("#", ""))} className="px-3 py-1.5 bg-white text-gray-600 rounded-full text-xs font-medium whitespace-nowrap border border-gray-200 shadow-sm active:scale-95 transition-transform hover:bg-gray-50 flex items-center gap-1">
                                    <Icons.Hash size={10} className="text-gray-400"/> {tag.replace("#", "")}
                                </button>
                            ))}
                        </div>
                    </header>

                    {/* Main */}
                    <main className="p-5">
                        {viewState === "idle" && (
                            <div className="flex flex-col gap-6 mt-4 animate-fade-in max-w-3xl mx-auto">
                                <SearchBar query={query} setQuery={setQuery} handleSearch={handleSearch} setShowFilters={setShowFilters} hasFilters={hasActiveFilters} />
                                <div className="space-y-4 mt-2">
                                    <div className="flex justify-between items-center px-1">
                                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider">AI Recommendation</p>
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        {todaysPicks.map((q, i) => (
                                            <button key={i} onClick={() => handleSearch(q)} className={`p-4 rounded-xl text-left text-sm font-bold shadow-sm hover:shadow-md active:scale-95 transition-all h-full border ${getRandomColorClass(i)}`}>
                                                <div className="text-lg mb-1">{getRandomEmoji(i)}</div>
                                                {q}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {viewState === "thinking" && (
                            <div className="flex flex-col items-center justify-center h-64 mt-10 space-y-6 animate-pulse">
                                <div className="relative">
                                    <div className="absolute inset-0 bg-blue-500 blur-xl opacity-20 rounded-full animate-ping"></div>
                                    <div className="w-20 h-20 bg-white rounded-2xl shadow-lg border border-blue-100 flex items-center justify-center relative z-10">
                                        <Icons.Sparkles size={32} className="text-blue-600 animate-spin-slow" />
                                    </div>
                                </div>
                                <div className="text-center space-y-1">
                                    <h3 className="text-lg font-bold text-gray-800">ÌÅêÎ†àÏù¥ÏÖò ÏÉùÏÑ± Ï§ë...</h3>
                                    <p className="text-sm text-gray-500">Ìé∏ÏÑ± ÏùºÏ†ïÏùÑ Í≥ÑÏÇ∞ÌïòÍ≥† ÏûàÏäµÎãàÎã§.</p>
                                </div>
                            </div>
                        )}

                        {viewState === "result" && (
                            <div className="space-y-6 animate-slide-up" ref={resultRef}>
                                <div className="mb-4"><SearchBar query={query} setQuery={setQuery} handleSearch={handleSearch} setShowFilters={setShowFilters} compact={true} hasFilters={hasActiveFilters} /></div>

                                <div className="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                                    <Icons.Edit3 className="absolute top-5 right-5 text-white opacity-50" size={20} />
                                    <div className="relative z-10">
                                        <div className="flex items-center gap-2 mb-3 text-purple-200 text-xs font-bold uppercase tracking-wider">
                                            <Icons.Sparkles size={12} /> AI Recommended
                                        </div>
                                        <h3 className="text-2xl font-bold leading-snug">{blockTitle}</h3>
                                        <p className="text-xs text-purple-200 mt-3 opacity-80 flex items-center gap-1">
                                            <Icons.Download size={10} /> Ï¥ù {results.length}Í±¥ / ÎÇ†ÏßúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.
                                        </p>
                                    </div>
                                </div>

                                <div className="flex justify-between items-end px-1">
                                    <h4 className="font-bold text-gray-800 flex items-center gap-2 text-lg">
                                        <Icons.CheckCircle2 size={20} className="text-green-500" /> Í≤∞Í≥º Î¶¨Ïä§Ìä∏
                                    </h4>
                                    <button onClick={toggleSelectAll} className="text-xs font-bold text-blue-600 hover:underline flex items-center gap-1">
                                        {selectedIds.length === results.length ? <Icons.CheckSquare size={14}/> : <Icons.Square size={14}/>} Ï†ÑÏ≤¥ÏÑ†ÌÉù
                                    </button>
                                </div>

                                {/* Results Grid */}
                                <div className="space-y-3">
                                    {results.length > 0 ? results.map((item, idx) => (
                                        <div key={item.id + idx} className={`bg-white p-4 rounded-xl border ${selectedIds.includes(item.id) ? 'border-blue-300 bg-blue-50/30' : 'border-gray-100'} shadow-sm flex flex-col gap-3 group transition-all`}>
                                            <div className="flex items-start gap-3">
                                                <div className="pt-1">
                                                    <input type="checkbox" checked={selectedIds.includes(item.id)} onChange={() => toggleSelect(item.id)} className="w-5 h-5 rounded border-gray-300 text-blue-600 cursor-pointer accent-blue-600"/>
                                                </div>
                                                <div className="flex-1">
                                                    <div className="flex justify-between items-start">
                                                        <div className="flex flex-col">
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-mono font-bold">{item.id}</span>
                                                                <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold border ${getTagStyle(item.subCategory)}`}>{item.subCategory}</span>
                                                            </div>
                                                            <h5 className="font-bold text-gray-900 text-lg leading-tight">{item.title}</h5>
                                                            <div className="text-xs text-gray-400 mt-1">{item.price === 0 ? "Î¨¥Î£å" : `${item.price.toLocaleString()}Ïõê`}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Date Pickers integrated nicely */}
                                            <div className="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-100">
                                                <Icons.Calendar size={14} className="text-gray-400"/>
                                                <div className="flex-1 flex gap-1 items-center">
                                                    <input type="datetime-local" value={item.startDate} onChange={(e) => updateDate(item.id, 'startDate', e.target.value)} className="bg-transparent text-xs font-mono w-full outline-none text-gray-600 font-bold"/>
                                                    <span className="text-gray-300">~</span>
                                                    <input type="datetime-local" value={item.endDate} onChange={(e) => updateDate(item.id, 'endDate', e.target.value)} className="bg-transparent text-xs font-mono w-full outline-none text-gray-600 font-bold"/>
                                                </div>
                                            </div>
                                        </div>
                                    )) : (
                                        <div className="text-center py-16 text-gray-400"><Icons.AlertTriangle size={24} className="mx-auto mb-2 opacity-50"/><p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p></div>
                                    )}
                                </div>
                                <div className="h-24"></div>
                            </div>
                        )}
                    </main>

                    {/* Floating Actions */}
                    {viewState === "result" && (
                        <div className="fixed bottom-6 left-0 right-0 z-30 px-5 flex flex-col items-center gap-3 pointer-events-none">
                            {/* Bulk Action Bar */}
                            {selectedIds.length > 0 && (
                                <div className="pointer-events-auto bg-slate-800 text-white p-3 rounded-xl shadow-2xl flex items-center gap-4 animate-slide-up w-full max-w-2xl justify-between">
                                    <div className="flex items-center gap-3">
                                        <span className="text-sm font-bold pl-2 whitespace-nowrap">{selectedIds.length}Í∞ú ÏÑ†ÌÉù</span>
                                        <div className="h-4 w-px bg-slate-600"></div>
                                        <div className="flex gap-2 items-center">
                                            <span className="text-xs text-gray-400">Ï¢ÖÎ£åÏùº ÏùºÍ¥Ñ:</span>
                                            <input type="datetime-local" className="text-xs text-slate-900 rounded px-2 py-1 outline-none w-32" onChange={(e) => e.target.value && bulkUpdateDate('endDate', e.target.value)}/>
                                        </div>
                                    </div>
                                    <button onClick={removeSelected} className="p-2 hover:bg-slate-700 rounded text-red-400"><Icons.Trash2 size={18} /></button>
                                </div>
                            )}

                            {/* Main Toolbar */}
                            <div className="pointer-events-auto flex gap-3 w-full max-w-2xl bg-white/90 backdrop-blur-sm p-2 rounded-2xl border border-white/50 shadow-2xl">
                                <button onClick={resetApp} className="w-14 h-14 bg-white border border-gray-200 rounded-xl shadow-sm flex items-center justify-center text-gray-500 hover:bg-gray-50 transition-all">
                                    <Icons.RotateCcw size={22} />
                                </button>
                                <button onClick={downloadExcel} className="w-14 h-14 bg-green-50 border border-green-200 rounded-xl shadow-sm flex items-center justify-center text-green-600 hover:bg-green-100 transition-all">
                                    <Icons.Download size={22} />
                                </button>
                                <button onClick={copyIds} className={`flex-1 h-14 rounded-xl shadow-sm font-bold text-lg flex items-center justify-center gap-2 transition-all ${copied ? 'bg-indigo-600 text-white' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>
                                    {copied ? <><Icons.CheckCircle2 size={22} /> ÏôÑÎ£å!</> : <><Icons.Copy size={22} /> ID Î≥µÏÇ¨</>}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Filters Modal */}
                    {showFilters && (
                        <div className="fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center sm:justify-center animate-fade-in" onClick={(e) => e.target === e.currentTarget && setShowFilters(false)}>
                            <div className="bg-white w-full sm:w-[400px] sm:rounded-3xl rounded-t-3xl p-6 pb-10 space-y-6 animate-slide-up shadow-2xl">
                                <div className="flex justify-between items-center"><h3 className="text-xl font-bold">Í≤ÄÏÉâ ÌïÑÌÑ∞</h3><button onClick={() => setShowFilters(false)}><Icons.X size={20} /></button></div>
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between bg-red-50 p-3 rounded-xl border border-red-100">
                                        <span className="text-sm font-bold text-red-600">ÏÑ±Ïù∏/Í∏∞ÌÉÄ Ìè¨Ìï®</span>
                                        <button onClick={() => setIncludeRestricted(!includeRestricted)} className={`w-12 h-7 rounded-full transition-colors relative ${includeRestricted ? 'bg-red-500' : 'bg-gray-300'}`}>
                                            <div className={`absolute top-1 left-1 w-5 h-5 bg-white rounded-full shadow transition-transform ${includeRestricted ? 'translate-x-5' : ''}`}></div>
                                        </button>
                                    </div>
                                    <div className="space-y-2"><label className="text-sm font-bold text-gray-500">Ïû•Î•¥</label><div className="flex flex-wrap gap-2">{allGenres.map(g => (<button key={g} onClick={() => setSelectedGenres(prev => prev.includes(g) ? prev.filter(x => x !== g) : [...prev, g])} className={`px-4 py-2 rounded-full text-sm font-medium border ${selectedGenres.includes(g) ? 'bg-blue-600 text-white' : 'bg-white text-gray-600'}`}>{g}</button>))}</div></div>
                                    <button onClick={() => { setShowFilters(false); if(query) handleSearch(); }} className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold text-lg mt-2">Ï†ÅÏö©ÌïòÍ∏∞</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
