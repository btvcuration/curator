<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Curator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Date Input Customization */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            cursor: pointer; opacity: 0.6;
        }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Lucide Icon Helper ---
        const Icon = ({ name, size = 18, className, ...props }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return React.createElement('svg', {
                xmlns: "http://www.w3.org/2000/svg",
                width: size, height: size, viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round",
                className: className, ...props
            }, iconData.map((child, i) => React.createElement(child[0], { ...child[1], key: i })));
        };

        // Icons
        const Icons = {
            Sparkles: (p) => <Icon name="Sparkles" {...p} />,
            Search: (p) => <Icon name="Search" {...p} />,
            Filter: (p) => <Icon name="Filter" {...p} />,
            Download: (p) => <Icon name="Download" {...p} />,
            Copy: (p) => <Icon name="Copy" {...p} />,
            Trash2: (p) => <Icon name="Trash2" {...p} />,
            RotateCcw: (p) => <Icon name="RotateCcw" {...p} />,
            Calendar: (p) => <Icon name="Calendar" {...p} />,
            CheckSquare: (p) => <Icon name="CheckSquare" {...p} />,
            Square: (p) => <Icon name="Square" {...p} />,
            ArrowUp: (p) => <Icon name="ArrowUp" {...p} />,
            ArrowDown: (p) => <Icon name="ArrowDown" {...p} />,
            X: (p) => <Icon name="X" {...p} />,
            Sun: (p) => <Icon name="Sun" {...p} />,
            Server: (p) => <Icon name="Server" {...p} />,
            CheckCircle2: (p) => <Icon name="CheckCircle2" {...p} />,
        };

        // --- CONFIG ---
        const GAS_API_URL = "https://jolly-sun-635f.alcheminos.workers.dev/"; 
        const CACHE_KEY = "ai_curator_data_v2"; // 캐시 버전 업

        // --- HELPERS ---
        const getTodayStartStr = () => {
            const now = new Date();
            // 오늘 00:00
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}T00:00`;
        };

        const getDefaultEndStr = () => "9999-12-31T23:59";

        // YYYY-MM-DDTHH:MM -> YYYY-MM-DD HH:MM (엑셀용)
        const formatForExcel = (isoStr) => isoStr.replace('T', ' ');

        // --- MAIN APP ---
        const App = () => {
            // Data States
            const [query, setQuery] = useState("");
            const [viewState, setViewState] = useState("idle"); // idle, thinking, result
            const [dbData, setDbData] = useState([]);
            const [results, setResults] = useState([]); 
            
            // Selection States (for Bulk Edit)
            const [selectedIds, setSelectedIds] = useState([]);
            const [lastCheckedId, setLastCheckedId] = useState(null);

            // Context & UI States
            const [context, setContext] = useState({ weather: "맑음", temp: "20°C", trends: [] });
            const [isLoadingData, setIsLoadingData] = useState(true);
            const [showFilters, setShowFilters] = useState(false);
            const [toastMessage, setToastMessage] = useState("");

            // Filter States
            const [selectedGenres, setSelectedGenres] = useState([]);
            const [priceType, setPriceType] = useState("all");

            // --- Initialization ---
            useEffect(() => {
                const init = async () => {
                    // 1. Weather & Trends (Mock for speed)
                    const month = new Date().getMonth() + 1;
                    const trends = month === 12 ? ["#크리스마스", "#연말", "#로맨스"] : ["#인기", "#정주행", "#힐링"];
                    setContext(prev => ({ ...prev, trends }));

                    // 2. Data Loading with Cache
                    try {
                        const cached = localStorage.getItem(CACHE_KEY);
                        if (cached) {
                            const { timestamp, data } = JSON.parse(cached);
                            if (Date.now() - timestamp < 24 * 60 * 60 * 1000) {
                                setDbData(data);
                                setIsLoadingData(false);
                                return;
                            }
                        }
                        
                        // Fetch Real (or use Mock if fail)
                        const res = await fetch(GAS_API_URL);
                        const json = await res.json();
                        if (json.status === 'success') {
                            setDbData(json.data);
                            localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data: json.data }));
                        } else {
                            throw new Error("API Fail");
                        }
                    } catch (e) {
                        console.warn("Using Mock Data");
                        setDbData([
                            { id: "CS001", title: "비밀의 숲 1", category: "드라마", subCategory: "스릴러", price: 0 },
                            { id: "CS002", title: "겨울왕국 2", category: "영화", subCategory: "애니메이션", price: 5500 },
                            { id: "CS003", title: "나 홀로 집에", category: "영화", subCategory: "가족", price: 1200 },
                            { id: "CS004", title: "무한도전 레전드", category: "예능", subCategory: "버라이어티", price: 0 },
                            { id: "CS005", title: "어바웃 타임", category: "영화", subCategory: "로맨스", price: 2500 },
                        ]);
                    } finally {
                        setIsLoadingData(false);
                    }
                };
                init();
            }, []);

            // --- Search Logic ---
            const handleSearch = (overrideQuery) => {
                const q = overrideQuery || query;
                if (!q) return;
                setQuery(q);
                setViewState("thinking");
                setSelectedIds([]);

                setTimeout(() => {
                    const cleanQ = q.replace(/\s/g, '').toLowerCase();
                    
                    let filtered = dbData.map(item => {
                        let score = 0;
                        const title = (item.title || "").replace(/\s/g, '').toLowerCase();
                        if (title.includes(cleanQ)) score += 50;
                        if ((item.subCategory || "").includes(q)) score += 30;
                        return { ...item, score };
                    }).filter(item => item.score > 0);

                    // Filters
                    if (selectedGenres.length > 0) filtered = filtered.filter(i => selectedGenres.includes(i.category));
                    if (priceType === 'free') filtered = filtered.filter(i => i.price === 0);
                    if (priceType === 'paid') filtered = filtered.filter(i => i.price > 0);

                    filtered.sort((a, b) => b.score - a.score);

                    // *** 날짜 초기화 로직 (요청사항 반영) ***
                    // 시작일: 오늘 00:00, 종료일: 9999-12-31 23:59
                    const initializedResults = filtered.slice(0, 50).map(item => ({
                        ...item,
                        startDate: getTodayStartStr(),
                        endDate: getDefaultEndStr()
                    }));

                    setResults(initializedResults);
                    setViewState("result");
                }, 800);
            };

            // --- Result Management (Edit, Delete, Move) ---
            const updateResultDate = (id, field, value) => {
                setResults(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
            };

            const toggleSelect = (id) => {
                setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
            };

            const toggleSelectAll = () => {
                if (selectedIds.length === results.length) setSelectedIds([]);
                else setSelectedIds(results.map(r => r.id));
            };

            const removeSelected = () => {
                setResults(prev => prev.filter(item => !selectedIds.includes(item.id)));
                setSelectedIds([]);
                showToast("삭제되었습니다.");
            };

            const bulkUpdateDate = (field, value) => {
                setResults(prev => prev.map(item => 
                    selectedIds.includes(item.id) ? { ...item, [field]: value } : item
                ));
                showToast(`${selectedIds.length}건의 날짜가 변경되었습니다.`);
            };

            // --- Export ---
            const downloadExcel = () => {
                // BOM for Excel Korean support
                const BOM = '\uFEFF';
                const header = `"콘텐츠ID\n(시리즈/에피소드)","메뉴편성시작일시\n(YYYY-MM-DD HH:MM)","메뉴편성종료일시\n(YYYY-MM-DD HH:MM)"\n`;
                
                const rows = results.map(r => {
                    // 실제 수정된 날짜 데이터 사용
                    return `${r.id},${formatForExcel(r.startDate)},${formatForExcel(r.endDate)}`;
                }).join('\n');

                const blob = new Blob([BOM + header + rows], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `편성리스트_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            const copyIds = () => {
                const text = results.map(r => r.id).join('\n');
                navigator.clipboard.writeText(text);
                showToast("ID 복사 완료!");
            };

            const showToast = (msg) => {
                setToastMessage(msg);
                setTimeout(() => setToastMessage(""), 2000);
            };

            // --- UI Sub-components ---
            const DateEditor = ({ label, value, onChange }) => (
                <div className="flex flex-col">
                    <span className="text-[10px] font-bold text-gray-400 mb-0.5">{label}</span>
                    <input 
                        type="datetime-local" 
                        value={value} 
                        onChange={(e) => onChange(e.target.value)}
                        className="text-xs bg-gray-50 border border-gray-200 rounded px-1 py-1 font-mono focus:bg-white focus:border-blue-500 outline-none w-36"
                    />
                </div>
            );

            // --- RENDER ---
            if (isLoadingData) return (
                <div className="min-h-screen flex items-center justify-center flex-col gap-4">
                    <Icons.Sparkles className="animate-spin text-blue-500" size={32} />
                    <p className="font-bold text-gray-500">데이터 동기화 중...</p>
                </div>
            );

            return (
                <div className="max-w-6xl mx-auto min-h-screen bg-white shadow-2xl border-x border-gray-100 pb-32">
                    
                    {/* Toast */}
                    {toastMessage && (
                        <div className="fixed top-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full text-sm font-bold z-50 animate-fade-in flex items-center gap-2">
                            <Icons.CheckCircle2 size={16} className="text-green-400"/> {toastMessage}
                        </div>
                    )}

                    {/* Header */}
                    <header className="p-6 border-b border-gray-100 bg-white sticky top-0 z-20">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-2xl font-black text-slate-800 flex items-center gap-2 cursor-pointer" onClick={() => setViewState('idle')}>
                                <span className="bg-blue-600 text-white p-1.5 rounded-lg"><Icons.Sparkles size={20}/></span>
                                AI Curator <span className="text-blue-600 text-sm font-medium self-end mb-1">Admin</span>
                            </h1>
                            <div className="text-xs font-bold text-gray-400 bg-gray-100 px-3 py-1 rounded-full">
                                {context.weather} {context.temp}
                            </div>
                        </div>

                        {/* Search Input */}
                        <div className="relative">
                            <input 
                                type="text" 
                                value={query}
                                onChange={e => setQuery(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && handleSearch()}
                                placeholder="검색어 입력 (예: 크리스마스 영화, 주말 예능)"
                                className="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 pl-12 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all font-bold text-lg"
                            />
                            <div className="absolute left-4 top-5 text-slate-400"><Icons.Search /></div>
                            <button 
                                onClick={() => setShowFilters(true)}
                                className={`absolute right-3 top-3 p-2 rounded-lg transition-colors ${selectedGenres.length ? 'bg-blue-100 text-blue-600' : 'bg-white text-gray-400 border border-gray-200 hover:bg-gray-50'}`}
                            >
                                <Icons.Filter size={20} />
                            </button>
                        </div>
                    </header>

                    {/* Body */}
                    <main className="p-6">
                        {viewState === 'idle' && (
                            <div className="mt-10 text-center animate-fade-in">
                                <p className="text-gray-400 font-bold mb-4">추천 키워드</p>
                                <div className="flex flex-wrap justify-center gap-2">
                                    {context.trends.map(t => (
                                        <button key={t} onClick={() => handleSearch(t.replace('#', ''))} className="px-4 py-2 bg-white border border-gray-200 rounded-full text-sm font-bold text-gray-600 hover:border-blue-500 hover:text-blue-600 transition-all">
                                            {t}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {viewState === 'thinking' && (
                            <div className="py-20 text-center animate-pulse">
                                <div className="inline-block p-4 bg-blue-50 rounded-full mb-4"><Icons.Sparkles className="text-blue-500 animate-spin-slow" size={40}/></div>
                                <h2 className="text-xl font-bold text-slate-800">편성 리스트 생성 중...</h2>
                                <p className="text-gray-500 mt-2">오늘 날짜 기준으로 스케줄링을 최적화하고 있습니다.</p>
                            </div>
                        )}

                        {viewState === 'result' && (
                            <div className="animate-slide-up">
                                {/* Toolbar */}
                                <div className="flex justify-between items-end mb-4 px-2">
                                    <div>
                                        <h2 className="text-xl font-bold text-slate-800">편성 결과 ({results.length}건)</h2>
                                        <p className="text-xs text-gray-500 mt-1">
                                            기본 시작일: <span className="font-mono font-bold text-blue-600">{getTodayStartStr().replace('T', ' ')}</span>
                                        </p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={toggleSelectAll} className="text-sm font-bold text-gray-500 hover:text-blue-600 flex items-center gap-1">
                                            {selectedIds.length === results.length ? <Icons.CheckSquare size={16} className="text-blue-600"/> : <Icons.Square size={16}/>}
                                            전체선택
                                        </button>
                                    </div>
                                </div>

                                {/* List Header */}
                                <div className="grid grid-cols-[40px_1fr_auto] gap-4 px-4 py-2 bg-gray-100 rounded-t-lg text-xs font-bold text-gray-500 uppercase">
                                    <div className="text-center">V</div>
                                    <div>콘텐츠 정보</div>
                                    <div className="w-[300px]">편성 기간 설정</div>
                                </div>

                                {/* List Items */}
                                <div className="bg-white border border-gray-200 rounded-b-lg divide-y divide-gray-100 shadow-sm">
                                    {results.map((item, idx) => (
                                        <div key={item.id} className={`grid grid-cols-[40px_1fr_auto] gap-4 px-4 py-4 items-center hover:bg-slate-50 transition-colors ${selectedIds.includes(item.id) ? 'bg-blue-50/50' : ''}`}>
                                            <div className="flex justify-center">
                                                <input 
                                                    type="checkbox" 
                                                    checked={selectedIds.includes(item.id)}
                                                    onChange={() => toggleSelect(item.id)}
                                                    className="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                                                />
                                            </div>
                                            
                                            <div className="min-w-0">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="px-1.5 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500 border border-gray-200 font-mono">{item.id}</span>
                                                    <span className="text-[10px] font-bold text-blue-500 border border-blue-100 px-1 rounded">{item.subCategory}</span>
                                                </div>
                                                <div className="font-bold text-slate-800 truncate text-base">{item.title}</div>
                                                <div className="text-xs text-gray-400 mt-0.5">{item.price === 0 ? "무료" : `${item.price.toLocaleString()}원`}</div>
                                            </div>

                                            <div className="flex gap-3 items-center">
                                                <DateEditor 
                                                    label="시작일시" 
                                                    value={item.startDate} 
                                                    onChange={(val) => updateResultDate(item.id, 'startDate', val)} 
                                                />
                                                <span className="text-gray-300 mt-4">~</span>
                                                <DateEditor 
                                                    label="종료일시" 
                                                    value={item.endDate} 
                                                    onChange={(val) => updateResultDate(item.id, 'endDate', val)} 
                                                />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Floating Action Bar (Bottom) */}
                    {viewState === 'result' && (
                        <div className="fixed bottom-6 left-0 right-0 z-40 flex flex-col items-center gap-3 px-4">
                            
                            {/* Bulk Action Bar (appears when items selected) */}
                            {selectedIds.length > 0 && (
                                <div className="bg-slate-800 text-white p-3 rounded-xl shadow-xl flex items-center gap-4 animate-slide-up w-full max-w-2xl">
                                    <span className="text-sm font-bold pl-2 whitespace-nowrap">{selectedIds.length}개 선택됨</span>
                                    <div className="h-4 w-px bg-slate-600"></div>
                                    
                                    <div className="flex-1 flex gap-2 overflow-x-auto scrollbar-hide">
                                        <input 
                                            type="datetime-local" 
                                            className="text-xs text-slate-900 rounded px-2 py-1.5 outline-none w-36"
                                            onChange={(e) => e.target.value && bulkUpdateDate('endDate', e.target.value)}
                                        />
                                        <span className="text-xs flex items-center text-gray-400">로 종료일 일괄변경</span>
                                    </div>
                                    
                                    <button onClick={removeSelected} className="p-2 hover:bg-slate-700 rounded text-red-400" title="선택 삭제">
                                        <Icons.Trash2 size={18} />
                                    </button>
                                </div>
                            )}

                            {/* Main Toolbar */}
                            <div className="flex gap-2 w-full max-w-2xl bg-white/90 backdrop-blur border border-gray-200 p-2 rounded-2xl shadow-2xl">
                                <button onClick={() => { setQuery(''); setViewState('idle'); setResults([]); }} className="w-12 h-12 flex items-center justify-center rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                                    <Icons.RotateCcw size={20} />
                                </button>
                                <div className="w-px h-8 bg-gray-300 my-auto mx-1"></div>
                                <button onClick={downloadExcel} className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-colors shadow-lg">
                                    <Icons.Download size={20} /> 엑셀 다운로드
                                </button>
                                <button onClick={copyIds} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-colors shadow-lg">
                                    <Icons.Copy size={20} /> ID 복사
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Filter Modal */}
                    {showFilters && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={(e) => e.target === e.currentTarget && setShowFilters(false)}>
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-slide-up">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg">상세 필터</h3>
                                    <button onClick={() => setShowFilters(false)}><Icons.X /></button>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 block mb-2">가격</label>
                                        <div className="flex bg-gray-100 p-1 rounded-lg">
                                            {['all', 'free', 'paid'].map(t => (
                                                <button key={t} onClick={() => setPriceType(t)} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${priceType === t ? 'bg-white shadow text-blue-600' : 'text-gray-400'}`}>
                                                    {t === 'all' ? '전체' : t === 'free' ? '무료' : '유료'}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <button onClick={() => { handleSearch(); setShowFilters(false); }} className="w-full py-3 bg-slate-900 text-white font-bold rounded-xl mt-4">적용하기</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
