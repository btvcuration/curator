<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Curator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes slide-up {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Sparkles, Search, CloudSnow, CloudRain, Cloud, Sun, Zap, CheckCircle2, 
            ArrowRight, Copy, RotateCcw, Film, Filter, X, RefreshCw, Calendar, 
            Download, Edit3, Server, FileSpreadsheet, Loader2, Hash, DollarSign, 
            AlertTriangle, Thermometer, Tag, Quote 
        } from 'lucide-react';

        // --- CONFIGURATION ---
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxrhGuW2iFJ-RXV6Ad7lfY2_k4ZvGuptYRF7ey9PxoKKn34639lf7BqzevxTO-PXksp/exec"; 
        const CACHE_KEY = "AI_CURATOR_DATA_V1";
        const CACHE_EXPIRY = 1000 * 60 * 60 * 6; // 6ÏãúÍ∞Ñ

        // --- HELPER FUNCTIONS ---
        const calculateSimilarity = (s1, s2) => {
            const clean1 = String(s1).replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, "").toLowerCase();
            const clean2 = String(s2).replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, "").toLowerCase();
            if (clean1 === clean2) return 1.0; 
            if (clean1.includes(clean2) || clean2.includes(clean1)) {
                const ratio = Math.min(clean1.length, clean2.length) / Math.max(clean1.length, clean2.length);
                return 0.8 + (ratio * 0.2); 
            }
            return 0.0; 
        };

        const fetchRealWeather = async () => {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 2000); // 2Ï¥à ÌÉÄÏûÑÏïÑÏõÉ
            try {
                const res = await fetch('https://wttr.in/?format=j1', { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!res.ok) throw new Error("Weather API Response Error");
                const data = await res.json();
                const current = data.current_condition[0];
                const desc = current.weatherDesc[0].value.toLowerCase();
                let simplifiedDesc = "ÎßëÏùå";
                if (desc.includes('rain') || desc.includes('drizzle')) simplifiedDesc = "ÎπÑ";
                else if (desc.includes('snow') || desc.includes('ice')) simplifiedDesc = "Îàà";
                else if (desc.includes('cloud') || desc.includes('overcast')) simplifiedDesc = "ÌùêÎ¶º";
                else if (desc.includes('fog') || desc.includes('mist')) simplifiedDesc = "ÏïàÍ∞ú";
                return { temp: `${current.temp_C}¬∞C`, weather: simplifiedDesc, rawDesc: desc };
            } catch (e) {
                const month = new Date().getMonth() + 1;
                let season = "ÎßëÏùå";
                if (month >= 12 || month <= 2) season = "Ï∂îÏõÄ";
                else if (month >= 6 && month <= 8) season = "ÎçîÏõÄ";
                return { temp: "Seasonal", weather: season, isFallback: true };
            }
        };

        const getRandomColorClass = (idx) => {
            const colors = [
                'bg-red-50 border-red-100 text-red-600', 'bg-orange-50 border-orange-100 text-orange-600',
                'bg-amber-50 border-amber-100 text-amber-600', 'bg-green-50 border-green-100 text-green-600',
                'bg-teal-50 border-teal-100 text-teal-600', 'bg-blue-50 border-blue-100 text-blue-600',
                'bg-indigo-50 border-indigo-100 text-indigo-600', 'bg-purple-50 border-purple-100 text-purple-600',
                'bg-pink-50 border-pink-100 text-pink-600'
            ];
            return colors[idx % colors.length];
        };

        const getRandomEmoji = (idx) => {
            const emojis = ['üé¨', 'üçø', 'üì∫', 'üåü', 'üëÄ', '‚ú®', 'üíø', 'üìº', 'üìΩÔ∏è'];
            return emojis[idx % emojis.length];
        };

        const LOADING_MESSAGES = [
            "üçø ÌåùÏΩò ÌäÄÍ∏∞Îäî Ï§ë...", "üé¨ Í∞êÎèÖÎãò ÏÑ≠Ïô∏ÌïòÎü¨ Í∞ÄÎäî Ï§ë...", "‚ö°Ô∏è ÎÑ∑ÌîåÎ¶≠Ïä§Î≥¥Îã§ Îπ†Î•¥Í≤å...",
            "‚õèÔ∏è Ïà®Í≤®ÏßÑ Î™ÖÏûë Îç∞Ïù¥ÌÑ∞ Î∞úÍµ¥ Ï§ë", "üìù Î¶¨Ïä§Ìä∏ ÏûëÏÑ± Ï§ë", "‚≠ê ÌèâÏ†ê 1Ï†êÏßúÎ¶¨ Í±∞Î•¥Îäî Ï§ë...",
            "üåä Îç∞Ïù¥ÌÑ∞ Î∞îÎã§ ÌÉêÌóò Ï§ë", "üïµÔ∏è‚Äç‚ôÇÔ∏è Î≤îÏù∏ÏùÄ Î∞îÎ°ú... Îç∞Ïù¥ÌÑ∞ ÏÜçÏóê", "ü§ñ AIÍ∞Ä ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎèÖ Ï§ë..."
        ];

        const getTagStyle = (text) => {
            const t = String(text).replace('#', '').trim();
            if (t === 'ÌïúÍµ≠ÏòÅÌôî') return 'bg-indigo-50 text-indigo-600 border-indigo-100';
            if (t === 'CJ ENM' || t === 'CJ') return 'bg-orange-50 text-orange-600 border-orange-100';
            if (t === 'ÏòÅÌôî') return 'bg-slate-100 text-slate-600 border-slate-200';
            if (t === 'ÎìúÎùºÎßà') return 'bg-rose-50 text-rose-600 border-rose-100';
            if (t === 'ÏòàÎä•') return 'bg-yellow-50 text-yellow-600 border-yellow-100';
            return 'bg-blue-50 text-blue-600 border-blue-100';
        };

        const SearchBar = ({ query, setQuery, handleSearch, setShowFilters, compact = false, hasFilters = false }) => (
            <div className={`relative group z-10 transition-all ${compact ? 'shadow-none' : 'shadow-sm'}`}>
                <input
                    type="text"
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                    onKeyDown={(e) => e.key === "Enter" && handleSearch()}
                    placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                    className={`w-full bg-white border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all placeholder:text-gray-300 ${compact ? 'py-3 pl-4 pr-20 text-base rounded-xl' : 'p-5 pr-24 text-lg rounded-2xl'}`}
                />
                <div className={`absolute right-2 flex gap-1 ${compact ? 'top-2' : 'top-3'}`}>
                    <button onClick={() => setShowFilters(true)} className={`rounded-lg transition-all flex items-center justify-center ${compact ? 'p-1.5 w-8 h-8' : 'p-2.5'} ${hasFilters ? 'bg-blue-100 text-blue-600' : 'bg-gray-50 text-gray-400 hover:bg-gray-100'}`}>
                        <Filter size={compact ? 16 : 20} />
                    </button>
                    <button onClick={() => handleSearch()} className={`rounded-lg transition-all flex items-center justify-center ${compact ? 'p-1.5 w-8 h-8' : 'p-2.5'} ${query ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-300'}`}>
                        <ArrowRight size={compact ? 16 : 20} />
                    </button>
                </div>
            </div>
        );

        function App() {
            const [query, setQuery] = useState("");
            const [viewState, setViewState] = useState("idle");
            const [dbData, setDbData] = useState([]); 
            const [results, setResults] = useState([]);
            const [allMatches, setAllMatches] = useState([]);
            const [strategy, setStrategy] = useState("");
            const [blockTitle, setBlockTitle] = useState("");
            const [copied, setCopied] = useState(false);
            const [showFilters, setShowFilters] = useState(false);
            const [todaysPicks, setTodaysPicks] = useState([]);
            const [context, setContext] = useState({ weather: "", temp: "", trends: [] }); 
            const [isLoadingData, setIsLoadingData] = useState(true); 
            const [loadingMsgIndex, setLoadingMsgIndex] = useState(0);
            const [isSearching, setIsSearching] = useState(false); 
            const [toastMessage, setToastMessage] = useState(""); 
            const today = new Date();
            const dateString = `${today.getFullYear()}.${today.getMonth() + 1}.${today.getDate()}`;
            const [sheetName, setSheetName] = useState("Îç∞Ïù¥ÌÑ∞ Ïó∞Í≤∞ ÎåÄÍ∏∞Ï§ë...");
            const [selectedGenres, setSelectedGenres] = useState([]);
            const [priceType, setPriceType] = useState("all"); 
            const [minPrice, setMinPrice] = useState(0); 
            const [includeRestricted, setIncludeRestricted] = useState(false); 
            const resultRef = useRef(null);
            
            const allGenres = dbData.length > 0 
                ? Array.from(new Set(dbData.map(item => item.category).filter(Boolean))) 
                : [];
            const hasActiveFilters = selectedGenres.length > 0 || priceType !== 'all' || includeRestricted;

            const getWeatherIcon = (weatherStr) => {
                if (!weatherStr) return <Sun size={12} />;
                const w = String(weatherStr).toLowerCase();
                if (w.includes('snow') || w.includes('Îàà') || w.includes('Ï∂îÏõÄ')) return <CloudSnow size={12} />;
                if (w.includes('rain') || w.includes('ÎπÑ')) return <CloudRain size={12} />;
                if (w.includes('cloud') || w.includes('ÌùêÎ¶º') || w.includes('Íµ¨Î¶Ñ') || w.includes('ÏïàÍ∞ú')) return <Cloud size={12} />;
                return <Sun size={12} />;
            };

            useEffect(() => {
                if (isLoadingData) {
                    const interval = setInterval(() => setLoadingMsgIndex((prev) => (prev + 1) % LOADING_MESSAGES.length), 1500);
                    return () => clearInterval(interval);
                }
            }, [isLoadingData]);

            useEffect(() => {
                const initApp = async () => {
                    const cached = localStorage.getItem(CACHE_KEY);
                    let hasCache = false;
                    if (cached) {
                        try {
                            const { data, timestamp, sheetName, todaysPicks } = JSON.parse(cached);
                            if (new Date().getTime() - timestamp < CACHE_EXPIRY) {
                                setDbData(data);
                                setSheetName(sheetName);
                                setTodaysPicks(todaysPicks || []);
                                setIsLoadingData(false);
                                hasCache = true;
                                showToast("ÏµúÍ∑º Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§.");
                            }
                        } catch (e) { localStorage.removeItem(CACHE_KEY); }
                    }

                    fetchRealWeather().then(weatherData => {
                        const month = new Date().getMonth() + 1;
                        const seasonalTrends = 
                            month === 12 ? ["#ÌÅ¨Î¶¨Ïä§ÎßàÏä§", "#Ïó∞ÎßêÍ≤∞ÏÇ∞", "#Î°úÎß®Ïä§"] :
                            month === 1 ? ["#ÏÉàÌï¥", "#Í∞ÄÏ°±", "#Ìï¥ÎèãÏù¥"] :
                            month === 7 || month === 8 ? ["#Í≥µÌè¨", "#Ïó¨Î¶ÑÌú¥Í∞Ä"] : ["#Ï£ºÎßê", "#ÌûêÎßÅ"];
                        setContext({ weather: weatherData.weather, temp: weatherData.temp, trends: seasonalTrends });
                    });

                    try {
                        let fetchPromise;
                        if (GAS_API_URL.includes("YOUR_SCRIPT_ID")) {
                            fetchPromise = new Promise(resolve => setTimeout(() => resolve({
                                status: 'success',
                                todaysPicks: ["ÎπÑÎ∞ÄÏùò Ïà≤ Ï†ïÏ£ºÌñâ", "Í≤®Ïö∏ Í∞êÏÑ± ÏòÅÌôî", "ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Î°úÏΩî", "Ï£ºÎßê ÌûêÎßÅ ÏòàÎä•"],
                                sheetName: "2025_02_Ìé∏ÏÑ±Îç∞Ïù¥ÌÑ∞", 
                                data: [
                                    { id: "CS11197562", title: "ÌÜµÏû†", category: "ÏòÅÌôî", subCategory: "ÌïúÍµ≠ÏòÅÌôî", price: 10000 },
                                    { id: "CS001", title: "Í≤®Ïö∏ÏôïÍµ≠", category: "ÏòÅÌôî", subCategory: "Ïï†ÎãàÎ©îÏù¥ÏÖò", price: 5500 },
                                    { id: "CS002", title: "Ïñ¥Î∞îÏõÉ ÌÉÄÏûÑ", category: "ÏòÅÌôî", subCategory: "Î°úÎß®Ïä§", price: 1500 },
                                    { id: "CS003", title: "Îü¨Î∏å Ïï°Ï∏ÑÏñºÎ¶¨", category: "ÏòÅÌôî", subCategory: "Î°úÎß®Ïä§", price: 1200 },
                                    { id: "CS004", title: "ÎÇò ÌôÄÎ°ú ÏßëÏóê", category: "ÏòÅÌôî", subCategory: "Í∞ÄÏ°±", price: 1000 },
                                    { id: "CS005", title: "ÎπÑÎ∞ÄÏùò Ïà≤", category: "ÎìúÎùºÎßà", subCategory: "ÌïúÍµ≠ÎìúÎùºÎßà", price: 0 }
                                ]
                            }), 500));
                        } else {
                            fetchPromise = fetch(GAS_API_URL).then(r => r.json());
                        }

                        const json = await fetchPromise;
                        if (json.status === 'success') {
                            setDbData(json.data || []);
                            setTodaysPicks(json.todaysPicks || []);
                            setSheetName(json.sheetName || `${dateString}_Ìé∏ÏÑ±Îç∞Ïù¥ÌÑ∞`);
                            localStorage.setItem(CACHE_KEY, JSON.stringify({
                                data: json.data, todaysPicks: json.todaysPicks, sheetName: json.sheetName, timestamp: new Date().getTime()
                            }));
                            if (!hasCache) setIsLoadingData(false);
                        }
                    } catch (error) {
                        if (!hasCache) { setSheetName("Ïò§ÌîÑÎùºÏù∏ Î™®Îìú"); setIsLoadingData(false); }
                    }
                };
                initApp();
            }, []);

            const showToast = (msg) => {
                setToastMessage(msg);
                setTimeout(() => setToastMessage(""), 3000);
            };

            const applyLocalFilters = (candidates = allMatches) => {
                const finalResults = candidates.filter(item => {
                    if (item.score <= 0) return false;
                    if (!includeRestricted && ['ÏÑ±Ïù∏', 'Í∏∞ÌÉÄ', 'adult', 'etc'].includes(item.category)) return false;
                    if (selectedGenres.length > 0 && !selectedGenres.includes(item.category)) return false;
                    if (priceType === 'free' && item.minPrice > 0) return false;
                    if (priceType === 'paid') { if (item.minPrice === 0) return false; if (item.minPrice < minPrice) return false; }
                    return true;
                }).sort((a, b) => b.score - a.score).slice(0, 30);
                setResults(finalResults);
            };

            const handleSearch = async (inputQuery) => {
                const targetQuery = inputQuery || query;
                if (!targetQuery) return;
                setQuery(targetQuery);
                setViewState("thinking");
                setIsSearching(true); 
                setResults([]); 
                setAllMatches([]); 
                
                try {
                    let aiResponse = { recommendedTitles: [], strategy: "", blockTitle: "" };
                    try {
                        if (GAS_API_URL.includes("YOUR_SCRIPT_ID")) throw new Error("Mock Mode");
                        const response = await fetch(`${GAS_API_URL}?query=${encodeURIComponent(targetQuery)}&weather=${encodeURIComponent(context.weather)}`);
                        if (!response.ok) throw new Error("API Error");
                        const json = await response.json();
                        if (json.status === 'success') aiResponse = json; else throw new Error("API Error");
                    } catch (e) {
                        await new Promise(r => setTimeout(r, 1000));
                        aiResponse = {
                            recommendedTitles: [{ title: targetQuery, reason: "Í≤ÄÏÉâ Í≤∞Í≥º", type: "Í∏∞ÌÉÄ", keywords: ["#Í≤ÄÏÉâ"] }],
                            strategy: `Ïò§ÌîÑÎùºÏù∏/Mock Î™®Îìú Í≤ÄÏÉâ`,
                            blockTitle: `"${targetQuery}" Í¥ÄÎ†®`
                        };
                    }

                    setStrategy(aiResponse.strategy || "ÌÇ§ÏõåÎìú Í∏∞Î∞ò Îß§Ïπ≠");
                    setBlockTitle(aiResponse.blockTitle || "Ï∂îÏ≤ú Î¶¨Ïä§Ìä∏");
                    
                    const normalizedRecs = (aiResponse.recommendedTitles || []).map(r => ({ 
                        rawTitle: r.title || r,
                        cleanTitle: String(r.title || r).replace(/\s/g, '').toLowerCase(),
                        keywords: r.keywords || []
                    }));
                    
                    const matches = dbData.map(item => {
                        const myTitle = (item.title || "").replace(/\s/g, '').toLowerCase();
                        let score = 0;
                        let matchedKeywords = [];
                        let bestMatchScore = 0;

                        for (const rec of normalizedRecs) {
                            const sim = calculateSimilarity(myTitle, rec.cleanTitle);
                            if (sim > bestMatchScore) { bestMatchScore = sim; matchedKeywords = rec.keywords; }
                        }

                        if (bestMatchScore >= 0.8) score = bestMatchScore * 100;
                        else if (myTitle.includes(targetQuery.replace(/\s/g, ''))) score = 40;
                        
                        return { ...item, score, aiKeywords: matchedKeywords };
                    });

                    const mergedMap = new Map();
                    matches.forEach(item => {
                        if (!mergedMap.has(item.id)) mergedMap.set(item.id, { ...item, prices: [item.price], minPrice: item.price });
                        else {
                            const existing = mergedMap.get(item.id);
                            if (!existing.prices.includes(item.price)) existing.prices.push(item.price);
                            existing.minPrice = Math.min(existing.minPrice, item.price);
                            existing.score = Math.max(existing.score, item.score);
                            if (item.aiKeywords?.length > 0) existing.aiKeywords = item.aiKeywords;
                        }
                    });

                    const candidates = Array.from(mergedMap.values());
                    setAllMatches(candidates);
                    applyLocalFilters(candidates);
                    setViewState("result");
                } catch (e) {
                    console.error(e);
                    showToast("Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                    setViewState("idle");
                } finally {
                    setIsSearching(false);
                }
            };

            const handleApplyFilter = () => {
                setShowFilters(false);
                if (viewState === 'result') applyLocalFilters(allMatches); else handleSearch();
            };

            const resetApp = () => {
                setViewState("idle");
                setQuery("");
                setResults([]);
                setAllMatches([]);
            };

            const downloadExcel = () => {
                const csvRows = results.map(r => `${r.id},${r.title},"${r.prices.join('/')}"`).join('\n');
                const blob = new Blob([`\uFEFFID,Title,Price\n${csvRows}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `list.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const copyToClipboard = () => {
                const txt = results.map(r => `${r.id}\t${r.title}`).join('\n');
                navigator.clipboard.writeText(txt).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); });
            };

            const toggleGenre = (genre) => {
                setSelectedGenres(prev => prev.includes(genre) ? prev.filter(g => g !== genre) : [...prev, genre]);
            };

            if (isLoadingData) {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center font-sans">
                        <div className="bg-white p-8 rounded-3xl shadow-xl flex flex-col items-center max-w-sm w-full border border-slate-100">
                            <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
                                <Sparkles size={32} className="text-blue-600" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-800 mb-4">{LOADING_MESSAGES[loadingMsgIndex]}</h2>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans max-w-5xl mx-auto shadow-2xl overflow-hidden relative border-x border-gray-100">
                    {toastMessage && (
                        <div className="absolute top-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-5 py-3 rounded-full shadow-xl z-50 text-sm font-bold flex items-center gap-2">
                            <CheckCircle2 size={18} className="text-green-400" /> {toastMessage}
                        </div>
                    )}
                    
                    <header className="bg-white px-5 pt-6 pb-4 sticky top-0 z-20 border-b border-gray-100">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={resetApp}>
                                <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white"><Sparkles size={18} /></div>
                                <h1 className="font-bold text-xl">AI Curator</h1>
                            </div>
                            <div className="flex items-center gap-1.5 bg-green-50 px-3 py-1.5 rounded-full border border-green-100">
                                <FileSpreadsheet size={12} className="text-green-600"/>
                                <span className="text-[11px] font-bold text-green-800">Data Connected</span>
                            </div>
                        </div>
                        <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                            <div className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-xs font-bold whitespace-nowrap border border-blue-100">
                                {getWeatherIcon(context.weather)} {context.temp} {context.weather}
                            </div>
                            {context.trends.map((tag, i) => (
                                <button key={i} onClick={() => handleSearch(tag.replace("#", ""))} className="px-3 py-1.5 bg-white text-gray-600 rounded-full text-xs font-medium border border-gray-200 hover:bg-gray-50 flex items-center gap-1">
                                    <Hash size={10} className="text-gray-400"/>{tag.replace("#", "")}
                                </button>
                            ))}
                        </div>
                    </header>

                    <main className="p-5 pb-32 min-h-[80vh]">
                        {viewState === "idle" && (
                            <div className="flex flex-col gap-6 mt-4 max-w-3xl mx-auto">
                                <SearchBar query={query} setQuery={setQuery} handleSearch={handleSearch} setShowFilters={setShowFilters} hasFilters={hasActiveFilters} />
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    {todaysPicks.map((q, i) => (
                                        <button key={i} onClick={() => handleSearch(q)} className={`p-4 rounded-xl text-left text-sm font-bold shadow-sm border ${getRandomColorClass(i)}`}>
                                            <div className="text-lg mb-1">{getRandomEmoji(i)}</div>{q}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {viewState === "thinking" && (
                            <div className="flex flex-col items-center justify-center h-64 mt-10 space-y-6 animate-pulse">
                                <div className="w-20 h-20 bg-white rounded-2xl shadow-lg border border-blue-100 flex items-center justify-center">
                                    <Sparkles size={32} className="text-blue-600 animate-spin-slow" />
                                </div>
                                <div className="text-center"><h3 className="font-bold text-gray-800">AI ÌÅêÎ†àÏù¥ÏÖò ÏßÑÌñâ Ï§ë...</h3></div>
                            </div>
                        )}

                        {viewState === "result" && (
                            <div className="space-y-6 animate-slide-up" ref={resultRef}>
                                <SearchBar query={query} setQuery={setQuery} handleSearch={handleSearch} setShowFilters={setShowFilters} compact={true} hasFilters={hasActiveFilters} />
                                <div className="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                                    <Edit3 className="absolute top-5 right-5 text-white opacity-50" size={20} />
                                    <div className="relative z-10">
                                        <div className="flex items-center gap-2 mb-3 text-purple-200 text-xs font-bold uppercase"><Sparkles size={12} /> AI Recommended</div>
                                        <h3 className="text-2xl font-bold">{blockTitle}</h3>
                                        <div className="mt-2 text-xs text-purple-200">{strategy}</div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {results.length > 0 ? results.map((item, idx) => (
                                        <div key={idx} className="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                                            <div className="flex justify-between items-start gap-3">
                                                <span className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded font-mono font-bold">{item.id}</span>
                                                <h5 className="font-bold text-gray-900 text-lg flex-1 text-right">{item.title}</h5>
                                            </div>
                                            <div className="flex justify-end gap-1 mt-2">
                                                <span className={`px-2 py-1 rounded text-[10px] font-bold border ${getTagStyle(item.subCategory)}`}>{item.subCategory}</span>
                                                {item.aiKeywords?.map((k, ki) => <span key={ki} className="px-2 py-1 bg-blue-50 text-blue-600 text-[10px] rounded border border-blue-100">{k}</span>)}
                                            </div>
                                            <div className="mt-3 text-right text-xs font-bold text-slate-600">
                                                {item.prices.map(p => p === 0 ? "Î¨¥Î£å" : p.toLocaleString() + "Ïõê").join(" / ")}
                                            </div>
                                        </div>
                                    )) : <div className="col-span-full text-center py-10 text-gray-400">Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>}
                                </div>
                            </div>
                        )}
                    </main>
                    
                    {viewState === "result" && (
                        <div className="absolute bottom-6 left-0 right-0 z-30 flex justify-center pointer-events-none">
                             <div className="flex gap-3 pointer-events-auto bg-white/90 p-2 rounded-2xl shadow-2xl border border-white/50 backdrop-blur-sm">
                                <button onClick={resetApp} className="w-12 h-12 flex items-center justify-center bg-white border rounded-xl hover:bg-gray-50"><RotateCcw size={20}/></button>
                                <button onClick={downloadExcel} className="w-12 h-12 flex items-center justify-center bg-white border rounded-xl text-green-600 hover:bg-green-50"><Download size={20}/></button>
                                <button onClick={copyToClipboard} className={`h-12 px-6 rounded-xl text-white font-bold flex items-center gap-2 ${copied ? 'bg-indigo-600' : 'bg-blue-600'}`}>
                                    {copied ? <CheckCircle2 size={20}/> : <Copy size={20}/>} {copied ? "ÏôÑÎ£å" : "ID Î≥µÏÇ¨"}
                                </button>
                             </div>
                        </div>
                    )}
                    
                    {showFilters && (
                        <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center" onClick={(e) => e.target === e.currentTarget && setShowFilters(false)}>
                            <div className="bg-white w-[90%] max-w-sm rounded-3xl p-6 space-y-6">
                                <div className="flex justify-between items-center"><h3 className="font-bold text-xl">ÌïÑÌÑ∞</h3><button onClick={() => setShowFilters(false)}><X/></button></div>
                                <div>
                                    <div className="text-sm font-bold text-gray-500 mb-2">Ïû•Î•¥</div>
                                    <div className="flex flex-wrap gap-2">
                                        {allGenres.map(g => (
                                            <button key={g} onClick={() => toggleGenre(g)} className={`px-3 py-1.5 rounded-full text-sm border ${selectedGenres.includes(g) ? 'bg-blue-600 text-white' : 'bg-white'}`}>{g}</button>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <div className="text-sm font-bold text-gray-500 mb-2">Í∞ÄÍ≤©</div>
                                    <div className="flex gap-2">
                                        {[{l:'Ï†ÑÏ≤¥',v:'all'},{l:'Î¨¥Î£å',v:'free'},{l:'Ïú†Î£å',v:'paid'}].map(o => (
                                            <button key={o.v} onClick={() => setPriceType(o.v)} className={`flex-1 py-2 rounded-lg border text-sm font-bold ${priceType === o.v ? 'bg-blue-600 text-white' : 'bg-white'}`}>{o.l}</button>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex items-center justify-between">
                                    <span className="text-sm font-bold text-red-500">ÏÑ±Ïù∏/Í∏∞ÌÉÄ Ìè¨Ìï®</span>
                                    <input type="checkbox" checked={includeRestricted} onChange={() => setIncludeRestricted(!includeRestricted)} className="toggle" />
                                </div>
                                <button onClick={handleApplyFilter} className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold">Ï†ÅÏö©ÌïòÍ∏∞</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
